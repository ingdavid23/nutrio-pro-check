<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NutriTrack Pro</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    * {
      box-sizing: border-box;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
    }

    .metric-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .chat-message {
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loading-dots::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      ring: 2px;
      ring-color: #667eea;
    }

    .btn-primary {
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .calendar-day:hover {
      background-color: #f3f4f6;
    }

    .calendar-day.today {
      background-color: #667eea;
      color: white;
    }

    .calendar-day.has-appointment {
      background-color: #fef3c7;
      border-color: #f59e0b;
    }

    .progress-bar {
      height: 20px;
      background-color: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full flex flex-col bg-gray-50" style="height: 100%;"><!-- Mobile Header -->
   <header class="text-white p-4 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="flex items-center justify-between">
     <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center"><span class="text-xl">ğŸ¥</span>
      </div>
      <div>
       <h1 id="app-title" class="text-lg font-bold">NutriTrack Pro</h1>
       <p id="welcome-message" class="text-xs opacity-90">GestiÃ³n integral</p>
      </div>
     </div><button id="menu-toggle" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center"> <span class="text-lg">â˜°</span> </button>
    </div>
   </header><!-- Main Content -->
   <main class="flex-1 overflow-auto" style="height: 100%;">
    <div class="pb-20"><!-- Patients View -->
     <div id="patients-view" class="p-4 space-y-4"><!-- Stats Cards -->
      <div class="grid grid-cols-3 gap-3">
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ‘¥
         </div>
         <p id="total-patients" class="text-xl font-bold" style="color: #667eea;">0</p>
         <p class="text-xs text-gray-500">Total</p>
        </div>
       </div>
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ“ˆ
         </div>
         <p id="new-patients" class="text-xl font-bold" style="color: #764ba2;">0</p>
         <p class="text-xs text-gray-500">Nuevos</p>
        </div>
       </div>
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          âœ…
         </div>
         <p id="active-followups" class="text-xl font-bold" style="color: #667eea;">0</p>
         <p class="text-xs text-gray-500">Activos</p>
        </div>
       </div>
      </div><!-- Add Patient Button -->
      <div class="flex justify-between items-center">
       <h2 class="text-lg font-bold text-gray-800">Mis Pacientes</h2><button id="btn-add-patient" class="w-12 h-12 bg-purple-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-purple-700 transition"> <span class="text-xl">â•</span> </button>
      </div><!-- Patients List -->
      <div id="patients-list" class="space-y-3"><!-- Patients will be rendered here -->
      </div><!-- Empty State -->
      <div id="empty-state" class="card p-8 text-center hidden">
       <div class="text-5xl mb-4">
        ğŸ“‹
       </div>
       <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay pacientes</h3>
       <p class="text-gray-500 mb-6 text-sm">Agrega tu primer paciente para comenzar</p><button id="btn-add-first" class="btn-primary px-6 py-3 bg-purple-600 text-white rounded-full font-semibold hover:bg-purple-700"> â• Agregar Paciente </button>
      </div>
     </div><!-- Calendar View -->
     <div id="calendar-view" class="hidden p-4 space-y-4">
      <div class="flex justify-between items-center">
       <h2 class="text-lg font-bold text-gray-800">Calendario</h2><button id="btn-add-appointment" class="w-12 h-12 bg-purple-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-purple-700 transition"> <span class="text-xl">â•</span> </button>
      </div><!-- Calendar -->
      <div class="card p-4">
       <div class="flex justify-between items-center mb-4"><button id="prev-month" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">â€¹</button> <span id="current-month" class="font-semibold text-sm"></span> <button id="next-month" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">â€º</button>
       </div>
       <div id="calendar-grid" class="grid grid-cols-7 gap-1"><!-- Calendar will be rendered here -->
       </div>
      </div><!-- Today's Appointments -->
      <div class="card p-4">
       <h3 class="font-semibold mb-3 flex items-center gap-2"><span class="text-lg">ğŸ“…</span> Citas de Hoy</h3>
       <div id="today-appointments" class="space-y-2"><!-- Today's appointments will be rendered here -->
       </div>
      </div><!-- Upcoming Appointments -->
      <div class="card p-4">
       <h3 class="font-semibold mb-3 flex items-center gap-2"><span class="text-lg">â°</span> PrÃ³ximas Citas</h3>
       <div id="upcoming-appointments" class="space-y-2"><!-- Upcoming appointments will be rendered here -->
       </div>
      </div>
     </div><!-- Nutrition Plans View -->
     <div id="nutrition-view" class="hidden p-4 space-y-4">
      <div class="flex justify-between items-center">
       <h2 class="text-lg font-bold text-gray-800">Planes Nutricionales</h2><button id="btn-add-plan" class="w-12 h-12 bg-purple-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-purple-700 transition"> <span class="text-xl">â•</span> </button>
      </div>
      <div id="nutrition-plans-list" class="space-y-3"><!-- Nutrition plans will be rendered here -->
      </div><!-- Empty State for Plans -->
      <div id="plans-empty-state" class="card p-8 text-center hidden">
       <div class="text-5xl mb-4">
        ğŸ
       </div>
       <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay planes nutricionales</h3>
       <p class="text-gray-500 mb-6 text-sm">Crea el primer plan para tus pacientes</p><button id="btn-add-first-plan" class="btn-primary px-6 py-3 bg-purple-600 text-white rounded-full font-semibold hover:bg-purple-700"> â• Crear Plan </button>
      </div>
     </div><!-- Statistics View -->
     <div id="statistics-view" class="hidden p-4 space-y-4">
      <h2 class="text-lg font-bold text-gray-800">EstadÃ­sticas</h2><!-- Key Metrics -->
      <div class="grid grid-cols-2 gap-3">
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ‘¥
         </div>
         <p id="stats-total-patients" class="text-xl font-bold" style="color: #667eea;">0</p>
         <p class="text-xs text-gray-500">Pacientes</p>
        </div>
       </div>
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ“…
         </div>
         <p id="stats-appointments" class="text-xl font-bold" style="color: #764ba2;">0</p>
         <p class="text-xs text-gray-500">Citas</p>
        </div>
       </div>
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ
         </div>
         <p id="stats-active-plans" class="text-xl font-bold" style="color: #667eea;">0</p>
         <p class="text-xs text-gray-500">Planes</p>
        </div>
       </div>
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ“Š
         </div>
         <p id="stats-avg-imc" class="text-xl font-bold" style="color: #764ba2;">0</p>
         <p class="text-xs text-gray-500">IMC Prom.</p>
        </div>
       </div>
      </div><!-- Charts and Analysis -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Gender Distribution -->
       <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">DistribuciÃ³n por GÃ©nero</h3>
        <div id="gender-chart" class="space-y-3"><!-- Gender chart will be rendered here -->
        </div>
       </div><!-- IMC Distribution -->
       <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">DistribuciÃ³n de IMC</h3>
        <div id="imc-chart" class="space-y-3"><!-- IMC chart will be rendered here -->
        </div>
       </div><!-- Age Groups -->
       <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">Grupos de Edad</h3>
        <div id="age-chart" class="space-y-3"><!-- Age chart will be rendered here -->
        </div>
       </div><!-- Monthly Progress -->
       <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">Progreso Mensual</h3>
        <div id="progress-chart" class="space-y-3"><!-- Progress chart will be rendered here -->
        </div>
       </div>
      </div>
     </div><!-- Chatbot View -->
     <div id="chatbot-view" class="hidden p-4 h-full flex flex-col">
      <div class="card flex-1 flex flex-col" style="height: calc(100% - 6rem);">
       <div class="flex items-center gap-3 p-4 border-b">
        <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
         ğŸ¤–
        </div>
        <div>
         <h3 id="chatbot-name" class="font-bold">NutriBot</h3>
         <p class="text-xs text-gray-500">Asistente IA</p>
        </div>
       </div>
       <div id="chat-messages" class="flex-1 overflow-auto p-4 space-y-3 scrollbar-hide"><!-- Messages will be rendered here -->
       </div>
       <div class="p-4 border-t">
        <form id="chat-form" class="flex gap-2"><input type="text" id="chat-input" placeholder="Escribe tu pregunta..." class="flex-1 px-3 py-2 border rounded-full focus:ring-2 focus:ring-purple-500 text-sm" required> <button type="submit" class="w-10 h-10 bg-purple-600 text-white rounded-full flex items-center justify-center hover:bg-purple-700"> <span class="text-sm">ğŸ“¤</span> </button>
        </form>
       </div>
      </div>
     </div><!-- Storage Management View -->
     <div id="storage-view" class="hidden p-4 space-y-4">
      <h2 class="text-lg font-bold text-gray-800">Almacenamiento</h2><!-- Storage Info -->
      <div class="grid grid-cols-3 gap-3">
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ’¾
         </div>
         <p class="text-xs text-gray-500 mb-1">Modo</p>
         <p class="text-xs font-medium">Local</p>
        </div>
       </div>
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ“Š
         </div>
         <p id="local-records-count" class="text-lg font-bold" style="color: #764ba2;">0</p>
         <p class="text-xs text-gray-500">Registros</p>
        </div>
       </div>
       <div class="card p-4">
        <div class="text-center">
         <div class="text-2xl mb-1">
          ğŸ“
         </div>
         <p id="storage-size" class="text-sm font-bold" style="color: #667eea;">0 KB</p>
         <p class="text-xs text-gray-500">Espacio</p>
        </div>
       </div>
      </div><!-- Storage Actions -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Export/Import -->
       <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">Exportar/Importar Datos</h3>
        <div class="space-y-4">
         <div>
          <p class="text-gray-600 mb-3">Exporta todos tus datos para crear una copia de seguridad</p><button id="btn-export-data" class="btn-primary w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700"> ğŸ“¤ Exportar Datos (JSON) </button>
         </div>
         <div class="border-t pt-4">
          <p class="text-gray-600 mb-3">Importa datos desde un archivo de respaldo</p><input type="file" id="import-file" accept=".json" class="hidden"> <button id="btn-import-data" class="btn-primary w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"> ğŸ“¥ Importar Datos </button>
         </div>
        </div>
       </div><!-- Data Management -->
       <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">GestiÃ³n de Datos</h3>
        <div class="space-y-4">
         <div>
          <p class="text-gray-600 mb-3">Limpia todos los datos almacenados localmente</p><button id="btn-clear-data" class="btn-primary w-full px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700"> ğŸ—‘ï¸ Limpiar Todos los Datos </button>
         </div>
         <div class="border-t pt-4">
          <p class="text-gray-600 mb-3">Actualiza las estadÃ­sticas de almacenamiento</p><button id="btn-refresh-storage" class="btn-primary w-full px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700"> ğŸ”„ Actualizar InformaciÃ³n </button>
         </div>
        </div>
       </div>
      </div><!-- Storage Details -->
      <div class="card p-6">
       <h3 class="text-xl font-bold mb-4">Detalles del Almacenamiento</h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="metric-card">
         <p class="text-xs text-gray-600">Pacientes</p>
         <p id="storage-patients-count" class="font-bold">0</p>
        </div>
        <div class="metric-card">
         <p class="text-xs text-gray-600">Citas</p>
         <p id="storage-appointments-count" class="font-bold">0</p>
        </div>
        <div class="metric-card">
         <p class="text-xs text-gray-600">Planes Nutricionales</p>
         <p id="storage-plans-count" class="font-bold">0</p>
        </div>
       </div>
       <div class="mt-4 p-4 bg-blue-50 rounded-lg">
        <h4 class="font-semibold text-blue-800 mb-2">â„¹ï¸ InformaciÃ³n Importante</h4>
        <ul class="text-sm text-blue-700 space-y-1">
         <li>â€¢ Los datos se guardan en el navegador de tu dispositivo</li>
         <li>â€¢ La informaciÃ³n persiste entre sesiones</li>
         <li>â€¢ Exporta regularmente para crear respaldos</li>
         <li>â€¢ Los datos se eliminan si limpias el navegador</li>
        </ul>
       </div>
      </div>
     </div>
    </div>
   </main><!-- Mobile Bottom Navigation -->
   <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-2 py-2 z-40">
    <div class="flex justify-around"><button id="btn-patients" class="flex flex-col items-center py-2 px-3 rounded-lg transition-colors"> <span class="text-xl mb-1">ğŸ‘¥</span> <span class="text-xs font-medium">Pacientes</span> </button> <button id="btn-calendar" class="flex flex-col items-center py-2 px-3 rounded-lg transition-colors"> <span class="text-xl mb-1">ğŸ“…</span> <span class="text-xs font-medium">Calendario</span> </button> <button id="btn-nutrition" class="flex flex-col items-center py-2 px-3 rounded-lg transition-colors"> <span class="text-xl mb-1">ğŸ</span> <span class="text-xs font-medium">Planes</span> </button> <button id="btn-statistics" class="flex flex-col items-center py-2 px-3 rounded-lg transition-colors"> <span class="text-xl mb-1">ğŸ“Š</span> <span class="text-xs font-medium">Stats</span> </button> <button id="btn-more" class="flex flex-col items-center py-2 px-3 rounded-lg transition-colors"> <span class="text-xl mb-1">â‹¯</span> <span class="text-xs font-medium">MÃ¡s</span> </button>
    </div>
   </nav><!-- Mobile Menu Overlay -->
   <div id="mobile-menu" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="fixed right-0 top-0 h-full w-80 bg-white shadow-lg transform translate-x-full transition-transform duration-300" id="menu-panel">
     <div class="p-4 border-b">
      <div class="flex items-center justify-between">
       <h3 class="text-lg font-semibold">MenÃº</h3><button id="close-menu" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"> <span class="text-lg">âœ•</span> </button>
      </div>
     </div>
     <div class="p-4 space-y-2"><button id="menu-chatbot" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 text-left"> <span class="text-xl">ğŸ¤–</span> <span class="font-medium">Asistente IA</span> </button> <button id="menu-storage" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 text-left"> <span class="text-xl">ğŸ’¾</span> <span class="font-medium">Almacenamiento</span> </button>
      <div class="border-t pt-4 mt-4">
       <p class="text-sm text-gray-500 px-3">VersiÃ³n 1.0</p>
      </div>
     </div>
    </div>
   </div><!-- Modal for Add/Edit Patient -->
   <div id="patient-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50">
    <div class="card w-full max-h-[90%] overflow-auto rounded-t-3xl rounded-b-none">
     <div class="sticky top-0 bg-white p-4 border-b rounded-t-3xl">
      <div class="flex justify-between items-center">
       <h2 id="modal-title" class="text-lg font-bold">Agregar Paciente</h2><button id="btn-close-modal" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"> <span class="text-lg">âœ•</span> </button>
      </div>
     </div>
     <div class="p-4">
      <form id="patient-form" class="space-y-6"><!-- Personal Info -->
       <div>
        <h3 class="font-semibold text-lg mb-3 text-purple-600">InformaciÃ³n Personal</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label> <input type="text" id="nombre" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="edad" class="block text-sm font-medium text-gray-700 mb-1">Edad *</label> <input type="number" id="edad" required min="0" max="120" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="genero" class="block text-sm font-medium text-gray-700 mb-1">GÃ©nero *</label> <select id="genero" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Seleccionar</option> <option value="Masculino">Masculino</option> <option value="Femenino">Femenino</option> <option value="Otro">Otro</option> </select>
         </div>
         <div><label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">TelÃ©fono</label> <input type="tel" id="telefono" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div class="md:col-span-2"><label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
        </div>
       </div><!-- Basic Measurements -->
       <div>
        <h3 class="font-semibold text-lg mb-3 text-purple-600">Medidas BÃ¡sicas</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div><label for="altura" class="block text-sm font-medium text-gray-700 mb-1">Altura (cm) *</label> <input type="number" id="altura" required min="0" step="0.1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="peso" class="block text-sm font-medium text-gray-700 mb-1">Peso (kg) *</label> <input type="number" id="peso" required min="0" step="0.1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="imc" class="block text-sm font-medium text-gray-700 mb-1">IMC</label> <input type="number" id="imc" step="0.1" class="w-full px-4 py-2 border rounded-lg bg-gray-50" readonly>
         </div>
        </div>
       </div><!-- Body Composition -->
       <div>
        <h3 class="font-semibold text-lg mb-3 text-purple-600">ComposiciÃ³n Corporal</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div><label for="grasa_corporal" class="block text-sm font-medium text-gray-700 mb-1">Grasa Corporal (%)</label> <input type="number" id="grasa_corporal" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="musculatura_esqueletica" class="block text-sm font-medium text-gray-700 mb-1">Musculatura EsquelÃ©tica (%)</label> <input type="number" id="musculatura_esqueletica" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="peso_sin_grasa" class="block text-sm font-medium text-gray-700 mb-1">Peso sin Grasa (kg)</label> <input type="number" id="peso_sin_grasa" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="grasa_subcutanea" class="block text-sm font-medium text-gray-700 mb-1">Grasa SubcutÃ¡nea (%)</label> <input type="number" id="grasa_subcutanea" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="grasa_visceral" class="block text-sm font-medium text-gray-700 mb-1">Grasa Visceral (nivel)</label> <input type="number" id="grasa_visceral" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="agua_corporal" class="block text-sm font-medium text-gray-700 mb-1">Agua Corporal (%)</label> <input type="number" id="agua_corporal" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
        </div>
       </div><!-- Additional Metrics -->
       <div>
        <h3 class="font-semibold text-lg mb-3 text-purple-600">MÃ©tricas Adicionales</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div><label for="masa_muscular" class="block text-sm font-medium text-gray-700 mb-1">Masa Muscular (kg)</label> <input type="number" id="masa_muscular" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="masa_osea" class="block text-sm font-medium text-gray-700 mb-1">Masa Ã“sea (kg)</label> <input type="number" id="masa_osea" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="proteina" class="block text-sm font-medium text-gray-700 mb-1">ProteÃ­na (%)</label> <input type="number" id="proteina" step="0.1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="tmb" class="block text-sm font-medium text-gray-700 mb-1">TMB (kcal/dÃ­a)</label> <input type="number" id="tmb" step="1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
         <div><label for="edad_metabolica" class="block text-sm font-medium text-gray-700 mb-1">Edad MetabÃ³lica</label> <input type="number" id="edad_metabolica" step="1" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
         </div>
        </div>
       </div><!-- Notes -->
       <div><label for="notas" class="block text-sm font-medium text-gray-700 mb-1">Notas y Observaciones</label> <textarea id="notas" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Alergias, condiciones mÃ©dicas, objetivos..."></textarea>
       </div><!-- Buttons -->
       <div class="flex gap-3 justify-end pt-4 border-t"><button type="button" id="btn-cancel" class="px-6 py-2 border rounded-lg hover:bg-gray-50"> Cancelar </button> <button type="submit" id="btn-save" class="btn-primary px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700"> Guardar Paciente </button>
       </div>
      </form>
     </div>
    </div><!-- Patient Detail Modal -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
     <div class="card p-6 max-w-5xl w-full max-h-[90%] overflow-auto">
      <div class="flex justify-between items-center mb-6">
       <h2 id="detail-patient-name" class="text-2xl font-bold">Detalles del Paciente</h2><button id="btn-close-detail" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
      </div>
      <div id="detail-content" class="space-y-6"><!-- Content will be rendered here -->
      </div>
      <div class="flex gap-3 justify-end pt-6 border-t mt-6"><button id="btn-edit-patient" class="btn-primary px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700"> âœï¸ Editar </button> <button id="btn-delete-patient" class="px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600"> ğŸ—‘ï¸ Eliminar </button>
      </div>
     </div>
    </div><!-- Appointment Modal -->
    <div id="appointment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
     <div class="card p-6 max-w-2xl w-full">
      <div class="flex justify-between items-center mb-6">
       <h2 id="appointment-modal-title" class="text-2xl font-bold">Nueva Cita</h2><button id="btn-close-appointment" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
      </div>
      <form id="appointment-form" class="space-y-4">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label for="appointment-patient" class="block text-sm font-medium text-gray-700 mb-1">Paciente *</label> <select id="appointment-patient" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Seleccionar paciente</option> </select>
        </div>
        <div><label for="appointment-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cita *</label> <select id="appointment-type" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Seleccionar tipo</option> <option value="Consulta Inicial">Consulta Inicial</option> <option value="Seguimiento">Seguimiento</option> <option value="Control de Peso">Control de Peso</option> <option value="RevisiÃ³n de Plan">RevisiÃ³n de Plan</option> </select>
        </div>
        <div><label for="appointment-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label> <input type="date" id="appointment-date" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
        </div>
        <div><label for="appointment-time" class="block text-sm font-medium text-gray-700 mb-1">Hora *</label> <input type="time" id="appointment-time" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
        </div>
       </div>
       <div><label for="appointment-notes" class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label> <textarea id="appointment-notes" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Notas adicionales..."></textarea>
       </div>
       <div class="flex gap-3 justify-end pt-4 border-t"><button type="button" id="btn-cancel-appointment" class="px-6 py-2 border rounded-lg hover:bg-gray-50"> Cancelar </button> <button type="submit" id="btn-save-appointment" class="btn-primary px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700"> Guardar Cita </button>
       </div>
      </form>
     </div>
    </div><!-- Nutrition Plan Modal -->
    <div id="nutrition-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
     <div class="card p-6 max-w-4xl w-full max-h-[90%] overflow-auto">
      <div class="flex justify-between items-center mb-6">
       <h2 id="nutrition-modal-title" class="text-2xl font-bold">Nuevo Plan Nutricional</h2><button id="btn-close-nutrition" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
      </div>
      <form id="nutrition-form" class="space-y-6">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label for="plan-patient" class="block text-sm font-medium text-gray-700 mb-1">Paciente *</label> <select id="plan-patient" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Seleccionar paciente</option> </select>
        </div>
        <div><label for="plan-title" class="block text-sm font-medium text-gray-700 mb-1">TÃ­tulo del Plan *</label> <input type="text" id="plan-title" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Ej: Plan de PÃ©rdida de Peso">
        </div>
       </div>
       <div><label for="plan-objective" class="block text-sm font-medium text-gray-700 mb-1">Objetivo *</label> <select id="plan-objective" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Seleccionar objetivo</option> <option value="PÃ©rdida de Peso">PÃ©rdida de Peso</option> <option value="Ganancia de Peso">Ganancia de Peso</option> <option value="Mantenimiento">Mantenimiento</option> <option value="Ganancia Muscular">Ganancia Muscular</option> <option value="Control DiabÃ©tico">Control DiabÃ©tico</option> </select>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div><label for="plan-calories" class="block text-sm font-medium text-gray-700 mb-1">CalorÃ­as Totales *</label> <input type="number" id="plan-calories" required min="800" max="4000" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
        </div>
        <div><label for="plan-proteins" class="block text-sm font-medium text-gray-700 mb-1">ProteÃ­nas (g) *</label> <input type="number" id="plan-proteins" required min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
        </div>
        <div><label for="plan-carbs" class="block text-sm font-medium text-gray-700 mb-1">Carbohidratos (g) *</label> <input type="number" id="plan-carbs" required min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
        </div>
        <div><label for="plan-fats" class="block text-sm font-medium text-gray-700 mb-1">Grasas (g) *</label> <input type="number" id="plan-fats" required min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
        </div>
       </div>
       <div><label for="plan-meals" class="block text-sm font-medium text-gray-700 mb-1">Comidas y Horarios *</label> <textarea id="plan-meals" rows="6" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Desayuno (8:00 AM):
- Avena con frutas
- Yogurt griego

Almuerzo (1:00 PM):
- Pollo a la plancha
- Ensalada mixta

Cena (7:00 PM):
- Pescado al vapor
- Vegetales"></textarea>
       </div>
       <div><label for="plan-instructions" class="block text-sm font-medium text-gray-700 mb-1">Instrucciones Especiales</label> <textarea id="plan-instructions" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Recomendaciones adicionales, suplementos, restricciones..."></textarea>
       </div>
       <div class="flex gap-3 justify-end pt-4 border-t"><button type="button" id="btn-cancel-nutrition" class="px-6 py-2 border rounded-lg hover:bg-gray-50"> Cancelar </button> <button type="submit" id="btn-save-nutrition" class="btn-primary px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700"> Guardar Plan </button>
       </div>
      </form>
     </div>
    </div>
   </div>
   <script>
    const defaultConfig = {
      app_title: "NutriTrack Pro",
      welcome_message: "GestiÃ³n integral de pacientes",
      storage_mode: "Local Storage (Memoria del Navegador)",
      chatbot_name: "NutriBot",
      chatbot_greeting: "Â¡Hola! Soy tu asistente nutricional. Â¿En quÃ© puedo ayudarte hoy?",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#667eea",
      secondary_action_color: "#764ba2",
      font_family: "Inter",
      font_size: 16
    };

    let allData = [];
    let patients = [];
    let appointments = [];
    let nutritionPlans = [];
    let currentView = 'patients';
    let editingPatient = null;
    let editingAppointment = null;
    let editingPlan = null;
    let chatMessages = [];
    let currentDate = new Date();

    // Local Storage Management
    const STORAGE_KEY = 'nutritrack_pro_data';

    function saveToLocalStorage() {
      try {
        const dataToSave = {
          patients,
          appointments,
          nutritionPlans,
          lastUpdated: new Date().toISOString()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        updateStorageInfo();
      } catch (error) {
        console.error('Error saving to localStorage:', error);
        showToast('Error al guardar datos localmente', 'error');
      }
    }

    function loadFromLocalStorage() {
      try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
          const parsedData = JSON.parse(savedData);
          patients = parsedData.patients || [];
          appointments = parsedData.appointments || [];
          nutritionPlans = parsedData.nutritionPlans || [];
          
          // Ensure all items have __backendId for compatibility
          patients.forEach(p => {
            if (!p.__backendId) p.__backendId = p.id || Date.now().toString() + Math.random();
          });
          appointments.forEach(a => {
            if (!a.__backendId) a.__backendId = a.id || Date.now().toString() + Math.random();
          });
          nutritionPlans.forEach(n => {
            if (!n.__backendId) n.__backendId = n.id || Date.now().toString() + Math.random();
          });
          
          allData = [...patients, ...appointments, ...nutritionPlans];
          updateCurrentView();
          updateStorageInfo();
        }
      } catch (error) {
        console.error('Error loading from localStorage:', error);
        showToast('Error al cargar datos locales', 'error');
      }
    }

    function updateCurrentView() {
      switch(currentView) {
        case 'patients':
          renderPatientsList();
          updateStats();
          break;
        case 'calendar':
          renderCalendar();
          renderTodayAppointments();
          renderUpcomingAppointments();
          break;
        case 'nutrition':
          renderNutritionPlans();
          break;
        case 'statistics':
          renderStatistics();
          break;
        case 'storage':
          updateStorageInfo();
          break;
      }
    }

    async function onConfigChange(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';

      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.fontSize = `${baseSize}px`;

      const appTitle = document.getElementById('app-title');
      if (appTitle) {
        appTitle.textContent = config.app_title || defaultConfig.app_title;
        appTitle.style.fontSize = `${baseSize * 1.875}px`;
      }

      const welcomeMessage = document.getElementById('welcome-message');
      if (welcomeMessage) {
        welcomeMessage.textContent = config.welcome_message || defaultConfig.welcome_message;
        welcomeMessage.style.fontSize = `${baseSize * 0.875}px`;
      }

      const chatbotName = document.getElementById('chatbot-name');
      if (chatbotName) {
        chatbotName.textContent = config.chatbot_name || defaultConfig.chatbot_name;
        chatbotName.style.fontSize = `${baseSize * 1.125}px`;
      }

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;

      const app = document.getElementById('app');
      if (app) {
        app.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${secondaryColor} 100%)`;
      }

      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.style.backgroundColor = surfaceColor;
        card.style.color = textColor;
      });

      const primaryButtons = document.querySelectorAll('.btn-primary');
      primaryButtons.forEach(btn => {
        btn.style.backgroundColor = primaryColor;
      });

      const headings = document.querySelectorAll('h1, h2, h3');
      headings.forEach(h => {
        h.style.fontFamily = `${customFont}, ${baseFontStack}`;
      });
    }

    async function init() {
      // Load data from localStorage first
      loadFromLocalStorage();

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
            ["storage_mode", config.storage_mode || defaultConfig.storage_mode],
            ["chatbot_name", config.chatbot_name || defaultConfig.chatbot_name],
            ["chatbot_greeting", config.chatbot_greeting || defaultConfig.chatbot_greeting]
          ])
        });
      }

      setupEventListeners();
      initializeChatbot();
      updateStorageInfo();
    }

    function setupEventListeners() {
      // Navigation
      document.getElementById('btn-patients').addEventListener('click', () => switchView('patients'));
      document.getElementById('btn-calendar').addEventListener('click', () => switchView('calendar'));
      document.getElementById('btn-nutrition').addEventListener('click', () => switchView('nutrition'));
      document.getElementById('btn-statistics').addEventListener('click', () => switchView('statistics'));
      document.getElementById('btn-more').addEventListener('click', toggleMobileMenu);
      document.getElementById('menu-toggle').addEventListener('click', toggleMobileMenu);
      document.getElementById('close-menu').addEventListener('click', closeMobileMenu);
      document.getElementById('menu-chatbot').addEventListener('click', () => { switchView('chatbot'); closeMobileMenu(); });
      document.getElementById('menu-storage').addEventListener('click', () => { switchView('storage'); closeMobileMenu(); });
      document.getElementById('mobile-menu').addEventListener('click', (e) => {
        if (e.target.id === 'mobile-menu') closeMobileMenu();
      });
      
      // Patient modals
      document.getElementById('btn-add-patient').addEventListener('click', openAddPatientModal);
      document.getElementById('btn-add-first').addEventListener('click', openAddPatientModal);
      document.getElementById('btn-close-modal').addEventListener('click', closePatientModal);
      document.getElementById('btn-cancel').addEventListener('click', closePatientModal);
      document.getElementById('btn-close-detail').addEventListener('click', closeDetailModal);
      
      // Appointment modals
      document.getElementById('btn-add-appointment').addEventListener('click', openAddAppointmentModal);
      document.getElementById('btn-close-appointment').addEventListener('click', closeAppointmentModal);
      document.getElementById('btn-cancel-appointment').addEventListener('click', closeAppointmentModal);
      
      // Nutrition modals
      document.getElementById('btn-add-plan').addEventListener('click', openAddNutritionModal);
      document.getElementById('btn-add-first-plan').addEventListener('click', openAddNutritionModal);
      document.getElementById('btn-close-nutrition').addEventListener('click', closeNutritionModal);
      document.getElementById('btn-cancel-nutrition').addEventListener('click', closeNutritionModal);
      
      // Forms
      document.getElementById('patient-form').addEventListener('submit', handleSavePatient);
      document.getElementById('appointment-form').addEventListener('submit', handleSaveAppointment);
      document.getElementById('nutrition-form').addEventListener('submit', handleSaveNutritionPlan);
      document.getElementById('chat-form').addEventListener('submit', handleChatSubmit);

      // Calendar navigation
      document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });
      document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });

      // IMC calculation
      const pesoInput = document.getElementById('peso');
      const alturaInput = document.getElementById('altura');
      pesoInput.addEventListener('input', calculateIMC);
      alturaInput.addEventListener('input', calculateIMC);

      // Storage management
      document.getElementById('btn-export-data').addEventListener('click', exportData);
      document.getElementById('btn-import-data').addEventListener('click', () => {
        document.getElementById('import-file').click();
      });
      document.getElementById('import-file').addEventListener('change', importData);
      document.getElementById('btn-clear-data').addEventListener('click', clearAllData);
      document.getElementById('btn-refresh-storage').addEventListener('click', updateStorageInfo);
    }

    function switchView(view) {
      currentView = view;
      
      // Hide all views
      document.getElementById('patients-view').classList.add('hidden');
      document.getElementById('calendar-view').classList.add('hidden');
      document.getElementById('nutrition-view').classList.add('hidden');
      document.getElementById('statistics-view').classList.add('hidden');
      document.getElementById('chatbot-view').classList.add('hidden');
      document.getElementById('storage-view').classList.add('hidden');

      // Show selected view
      document.getElementById(`${view}-view`).classList.remove('hidden');

      // Update active navigation
      updateActiveNavigation(view);

      // Render content based on view
      switch(view) {
        case 'patients':
          renderPatientsList();
          updateStats();
          break;
        case 'calendar':
          renderCalendar();
          renderTodayAppointments();
          renderUpcomingAppointments();
          break;
        case 'nutrition':
          renderNutritionPlans();
          break;
        case 'statistics':
          renderStatistics();
          break;
        case 'storage':
          updateStorageInfo();
          break;
      }
    }

    function updateActiveNavigation(activeView) {
      // Reset all navigation buttons
      const navButtons = document.querySelectorAll('nav button');
      navButtons.forEach(btn => {
        btn.classList.remove('bg-purple-100', 'text-purple-600');
        btn.classList.add('text-gray-600');
      });

      // Highlight active button
      const activeButton = document.getElementById(`btn-${activeView}`);
      if (activeButton) {
        activeButton.classList.add('bg-purple-100', 'text-purple-600');
        activeButton.classList.remove('text-gray-600');
      }
    }

    function toggleMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      const panel = document.getElementById('menu-panel');
      
      menu.classList.remove('hidden');
      setTimeout(() => {
        panel.classList.remove('translate-x-full');
      }, 10);
    }

    function closeMobileMenu() {
      const menu = document.getElementById('mobile-menu');
      const panel = document.getElementById('menu-panel');
      
      panel.classList.add('translate-x-full');
      setTimeout(() => {
        menu.classList.add('hidden');
      }, 300);
    }

    function updateStats() {
      document.getElementById('total-patients').textContent = patients.length;
      
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      const newThisMonth = patients.filter(p => {
        const regDate = new Date(p.fecha_registro);
        return regDate.getMonth() === currentMonth && regDate.getFullYear() === currentYear;
      }).length;
      
      document.getElementById('new-patients').textContent = newThisMonth;
      document.getElementById('active-followups').textContent = patients.length;
    }

    function renderPatientsList() {
      const listContainer = document.getElementById('patients-list');
      const emptyState = document.getElementById('empty-state');

      if (patients.length === 0) {
        listContainer.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      listContainer.innerHTML = patients.map(patient => `
        <div class="card p-4 cursor-pointer hover:shadow-lg transition" onclick="openPatientDetail('${patient.__backendId}')">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              ${patient.genero === 'Masculino' ? 'ğŸ‘¨' : patient.genero === 'Femenino' ? 'ğŸ‘©' : 'ğŸ‘¤'}
            </div>
            <div class="flex-1">
              <h3 class="font-bold">${patient.nombre}</h3>
              <p class="text-sm text-gray-500">${patient.edad} aÃ±os â€¢ ${patient.genero}</p>
              <div class="flex gap-4 mt-2">
                <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                  ${patient.peso} kg
                </span>
                <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                  IMC: ${patient.imc ? patient.imc.toFixed(1) : 'N/A'}
                </span>
              </div>
            </div>
            <div class="text-gray-400">
              <span class="text-lg">â€º</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderCalendar() {
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      document.getElementById('current-month').textContent = 
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      const calendarGrid = document.getElementById('calendar-grid');
      calendarGrid.innerHTML = '';

      // Day headers
      const dayHeaders = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'p-2 text-center font-semibold text-gray-600 text-sm';
        header.textContent = day;
        calendarGrid.appendChild(header);
      });

      // Calendar days
      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day text-sm';
        dayElement.textContent = date.getDate();

        if (date.getMonth() !== currentDate.getMonth()) {
          dayElement.classList.add('text-gray-300');
        }

        const today = new Date();
        if (date.toDateString() === today.toDateString()) {
          dayElement.classList.add('today');
        }

        // Check for appointments
        const dateStr = date.toISOString().split('T')[0];
        const hasAppointment = appointments.some(apt => apt.fecha === dateStr);
        if (hasAppointment) {
          dayElement.classList.add('has-appointment');
        }

        calendarGrid.appendChild(dayElement);
      }
    }

    function renderTodayAppointments() {
      const today = new Date().toISOString().split('T')[0];
      const todayAppts = appointments.filter(apt => apt.fecha === today);
      
      const container = document.getElementById('today-appointments');
      
      if (todayAppts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No hay citas programadas para hoy</p>';
        return;
      }

      container.innerHTML = todayAppts.map(apt => {
        const patient = patients.find(p => p.__backendId === apt.paciente_id);
        return `
          <div class="p-3 border rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-semibold">${patient ? patient.nombre : 'Paciente no encontrado'}</p>
                <p class="text-sm text-gray-600">${apt.tipo}</p>
                <p class="text-sm text-purple-600">${apt.hora}</p>
              </div>
              <div class="flex gap-1 ml-2">
                <button onclick="editAppointment('${apt.__backendId}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Editar cita">
                  âœï¸
                </button>
                <button onclick="deleteAppointment('${apt.__backendId}')" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Eliminar cita">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderUpcomingAppointments() {
      const today = new Date();
      const upcoming = appointments
        .filter(apt => new Date(apt.fecha) > today)
        .sort((a, b) => new Date(a.fecha) - new Date(b.fecha))
        .slice(0, 5);
      
      const container = document.getElementById('upcoming-appointments');
      
      if (upcoming.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No hay citas prÃ³ximas programadas</p>';
        return;
      }

      container.innerHTML = upcoming.map(apt => {
        const patient = patients.find(p => p.__backendId === apt.paciente_id);
        return `
          <div class="p-3 border rounded-lg">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-semibold">${patient ? patient.nombre : 'Paciente no encontrado'}</p>
                <p class="text-sm text-gray-600">${apt.tipo}</p>
                <p class="text-sm text-purple-600">${new Date(apt.fecha).toLocaleDateString('es-ES')} - ${apt.hora}</p>
              </div>
              <div class="flex gap-1 ml-2">
                <button onclick="editAppointment('${apt.__backendId}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Editar cita">
                  âœï¸
                </button>
                <button onclick="deleteAppointment('${apt.__backendId}')" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Eliminar cita">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderNutritionPlans() {
      const listContainer = document.getElementById('nutrition-plans-list');
      const emptyState = document.getElementById('plans-empty-state');

      if (nutritionPlans.length === 0) {
        listContainer.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      listContainer.innerHTML = nutritionPlans.map(plan => {
        const patient = patients.find(p => p.__backendId === plan.paciente_id);
        return `
          <div class="card p-4 cursor-pointer hover:shadow-lg transition">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-xl">
                ğŸ
              </div>
              <div class="flex-1">
                <h3 class="font-bold">${plan.titulo}</h3>
                <p class="text-sm text-gray-500">${patient ? patient.nombre : 'Paciente no encontrado'}</p>
                <div class="flex gap-4 mt-2">
                  <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">
                    ${plan.objetivo}
                  </span>
                  <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                    ${plan.calorias_totales} kcal
                  </span>
                </div>
              </div>
              <div class="text-gray-400">
                <span class="text-lg">â€º</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderStatistics() {
      // Update key metrics
      document.getElementById('stats-total-patients').textContent = patients.length;
      document.getElementById('stats-appointments').textContent = appointments.length;
      document.getElementById('stats-active-plans').textContent = nutritionPlans.length;
      
      const avgIMC = patients.length > 0 ? 
        (patients.reduce((sum, p) => sum + (p.imc || 0), 0) / patients.length).toFixed(1) : 0;
      document.getElementById('stats-avg-imc').textContent = avgIMC;

      // Gender distribution
      const genderStats = patients.reduce((acc, p) => {
        acc[p.genero] = (acc[p.genero] || 0) + 1;
        return acc;
      }, {});

      const genderChart = document.getElementById('gender-chart');
      genderChart.innerHTML = Object.entries(genderStats).map(([gender, count]) => {
        const percentage = ((count / patients.length) * 100).toFixed(1);
        return `
          <div class="flex justify-between items-center">
            <span>${gender}</span>
            <div class="flex items-center gap-2">
              <div class="progress-bar w-24">
                <div class="progress-fill bg-purple-500" style="width: ${percentage}%"></div>
              </div>
              <span class="text-sm">${count} (${percentage}%)</span>
            </div>
          </div>
        `;
      }).join('');

      // IMC distribution
      const imcRanges = {
        'Bajo peso': patients.filter(p => p.imc && p.imc < 18.5).length,
        'Normal': patients.filter(p => p.imc && p.imc >= 18.5 && p.imc < 25).length,
        'Sobrepeso': patients.filter(p => p.imc && p.imc >= 25 && p.imc < 30).length,
        'Obesidad': patients.filter(p => p.imc && p.imc >= 30).length
      };

      const imcChart = document.getElementById('imc-chart');
      imcChart.innerHTML = Object.entries(imcRanges).map(([range, count]) => {
        const percentage = patients.length > 0 ? ((count / patients.length) * 100).toFixed(1) : 0;
        return `
          <div class="flex justify-between items-center">
            <span>${range}</span>
            <div class="flex items-center gap-2">
              <div class="progress-bar w-24">
                <div class="progress-fill bg-blue-500" style="width: ${percentage}%"></div>
              </div>
              <span class="text-sm">${count} (${percentage}%)</span>
            </div>
          </div>
        `;
      }).join('');

      // Age groups
      const ageGroups = {
        '18-30': patients.filter(p => p.edad >= 18 && p.edad <= 30).length,
        '31-45': patients.filter(p => p.edad >= 31 && p.edad <= 45).length,
        '46-60': patients.filter(p => p.edad >= 46 && p.edad <= 60).length,
        '60+': patients.filter(p => p.edad > 60).length
      };

      const ageChart = document.getElementById('age-chart');
      ageChart.innerHTML = Object.entries(ageGroups).map(([range, count]) => {
        const percentage = patients.length > 0 ? ((count / patients.length) * 100).toFixed(1) : 0;
        return `
          <div class="flex justify-between items-center">
            <span>${range} aÃ±os</span>
            <div class="flex items-center gap-2">
              <div class="progress-bar w-24">
                <div class="progress-fill bg-green-500" style="width: ${percentage}%"></div>
              </div>
              <span class="text-sm">${count} (${percentage}%)</span>
            </div>
          </div>
        `;
      }).join('');

      // Monthly progress (simplified)
      const progressChart = document.getElementById('progress-chart');
      progressChart.innerHTML = `
        <div class="flex justify-between items-center">
          <span>Pacientes nuevos</span>
          <div class="flex items-center gap-2">
            <div class="progress-bar w-24">
              <div class="progress-fill bg-purple-500" style="width: 75%"></div>
            </div>
            <span class="text-sm">+${patients.length}</span>
          </div>
        </div>
        <div class="flex justify-between items-center">
          <span>Citas completadas</span>
          <div class="flex items-center gap-2">
            <div class="progress-bar w-24">
              <div class="progress-fill bg-blue-500" style="width: 60%"></div>
            </div>
            <span class="text-sm">${appointments.length}</span>
          </div>
        </div>
        <div class="flex justify-between items-center">
          <span>Planes activos</span>
          <div class="flex items-center gap-2">
            <div class="progress-bar w-24">
              <div class="progress-fill bg-green-500" style="width: 45%"></div>
            </div>
            <span class="text-sm">${nutritionPlans.length}</span>
          </div>
        </div>
      `;
    }

    function openAddPatientModal() {
      editingPatient = null;
      document.getElementById('modal-title').textContent = 'Agregar Paciente';
      document.getElementById('patient-form').reset();
      document.getElementById('patient-modal').classList.remove('hidden');
    }

    function closePatientModal() {
      document.getElementById('patient-modal').classList.add('hidden');
      editingPatient = null;
    }

    function openAddAppointmentModal() {
      editingAppointment = null;
      document.getElementById('appointment-modal-title').textContent = 'Nueva Cita';
      document.getElementById('appointment-form').reset();
      
      // Populate patient dropdown
      const patientSelect = document.getElementById('appointment-patient');
      patientSelect.innerHTML = '<option value="">Seleccionar paciente</option>' +
        patients.map(p => `<option value="${p.__backendId}">${p.nombre}</option>`).join('');
      
      document.getElementById('appointment-modal').classList.remove('hidden');
    }

    function closeAppointmentModal() {
      document.getElementById('appointment-modal').classList.add('hidden');
      editingAppointment = null;
    }

    function openAddNutritionModal() {
      editingPlan = null;
      document.getElementById('nutrition-modal-title').textContent = 'Nuevo Plan Nutricional';
      document.getElementById('nutrition-form').reset();
      
      // Populate patient dropdown
      const patientSelect = document.getElementById('plan-patient');
      patientSelect.innerHTML = '<option value="">Seleccionar paciente</option>' +
        patients.map(p => `<option value="${p.__backendId}">${p.nombre}</option>`).join('');
      
      document.getElementById('nutrition-modal').classList.remove('hidden');
    }

    function closeNutritionModal() {
      document.getElementById('nutrition-modal').classList.add('hidden');
      editingPlan = null;
    }

    function calculateIMC() {
      const peso = parseFloat(document.getElementById('peso').value);
      const altura = parseFloat(document.getElementById('altura').value);
      
      if (peso && altura && altura > 0) {
        const imc = peso / Math.pow(altura / 100, 2);
        document.getElementById('imc').value = imc.toFixed(1);
      }
    }

    async function handleSavePatient(e) {
      e.preventDefault();
      
      if (patients.length >= 999 && !editingPatient) {
        showToast('LÃ­mite alcanzado: mÃ¡ximo 999 registros', 'error');
        return;
      }

      const btnSave = document.getElementById('btn-save');
      btnSave.disabled = true;
      btnSave.textContent = 'Guardando...';

      const formData = {
        type: 'patient',
        id: editingPatient ? editingPatient.id : Date.now().toString(),
        nombre: document.getElementById('nombre').value,
        edad: parseInt(document.getElementById('edad').value),
        genero: document.getElementById('genero').value,
        telefono: document.getElementById('telefono').value || '',
        email: document.getElementById('email').value || '',
        altura: parseFloat(document.getElementById('altura').value),
        peso: parseFloat(document.getElementById('peso').value),
        imc: parseFloat(document.getElementById('imc').value) || 0,
        grasa_corporal: parseFloat(document.getElementById('grasa_corporal').value) || 0,
        musculatura_esqueletica: parseFloat(document.getElementById('musculatura_esqueletica').value) || 0,
        peso_sin_grasa: parseFloat(document.getElementById('peso_sin_grasa').value) || 0,
        grasa_subcutanea: parseFloat(document.getElementById('grasa_subcutanea').value) || 0,
        grasa_visceral: parseFloat(document.getElementById('grasa_visceral').value) || 0,
        agua_corporal: parseFloat(document.getElementById('agua_corporal').value) || 0,
        masa_muscular: parseFloat(document.getElementById('masa_muscular').value) || 0,
        masa_osea: parseFloat(document.getElementById('masa_osea').value) || 0,
        proteina: parseFloat(document.getElementById('proteina').value) || 0,
        tmb: parseInt(document.getElementById('tmb').value) || 0,
        edad_metabolica: parseInt(document.getElementById('edad_metabolica').value) || 0,
        notas: document.getElementById('notas').value || '',
        fecha_registro: editingPatient ? editingPatient.fecha_registro : new Date().toISOString(),
        ultima_actualizacion: new Date().toISOString(),
        __backendId: editingPatient ? editingPatient.__backendId : Date.now().toString() + Math.random()
      };

      try {
        if (editingPatient) {
          const index = patients.findIndex(p => p.__backendId === editingPatient.__backendId);
          if (index !== -1) {
            patients[index] = formData;
          }
        } else {
          patients.push(formData);
        }
        
        saveToLocalStorage();
        closePatientModal();
        updateCurrentView();
        showToast(editingPatient ? 'Paciente actualizado' : 'Paciente agregado', 'success');
      } catch (error) {
        showToast('Error al guardar paciente', 'error');
      }

      btnSave.disabled = false;
      btnSave.textContent = 'Guardar Paciente';
    }

    async function handleSaveAppointment(e) {
      e.preventDefault();
      
      if (appointments.length >= 999 && !editingAppointment) {
        showToast('LÃ­mite alcanzado: mÃ¡ximo 999 registros', 'error');
        return;
      }

      const btnSave = document.getElementById('btn-save-appointment');
      btnSave.disabled = true;
      btnSave.textContent = 'Guardando...';

      const formData = {
        type: 'appointment',
        id: editingAppointment ? editingAppointment.id : Date.now().toString(),
        paciente_id: document.getElementById('appointment-patient').value,
        tipo: document.getElementById('appointment-type').value,
        fecha: document.getElementById('appointment-date').value,
        hora: document.getElementById('appointment-time').value,
        estado: editingAppointment ? editingAppointment.estado : 'Programada',
        observaciones: document.getElementById('appointment-notes').value || '',
        fecha_creacion: editingAppointment ? editingAppointment.fecha_creacion : new Date().toISOString(),
        __backendId: editingAppointment ? editingAppointment.__backendId : Date.now().toString() + Math.random()
      };

      try {
        if (editingAppointment) {
          const index = appointments.findIndex(a => a.__backendId === editingAppointment.__backendId);
          if (index !== -1) {
            appointments[index] = formData;
          }
        } else {
          appointments.push(formData);
        }
        
        saveToLocalStorage();
        closeAppointmentModal();
        updateCurrentView();
        showToast(editingAppointment ? 'Cita actualizada exitosamente' : 'Cita programada exitosamente', 'success');
      } catch (error) {
        showToast('Error al guardar cita', 'error');
      }

      btnSave.disabled = false;
      btnSave.textContent = 'Guardar Cita';
    }

    async function handleSaveNutritionPlan(e) {
      e.preventDefault();
      
      if (nutritionPlans.length >= 999) {
        showToast('LÃ­mite alcanzado: mÃ¡ximo 999 registros', 'error');
        return;
      }

      const btnSave = document.getElementById('btn-save-nutrition');
      btnSave.disabled = true;
      btnSave.textContent = 'Guardando...';

      const formData = {
        type: 'nutrition_plan',
        id: Date.now().toString(),
        paciente_id: document.getElementById('plan-patient').value,
        titulo: document.getElementById('plan-title').value,
        objetivo: document.getElementById('plan-objective').value,
        calorias_totales: parseInt(document.getElementById('plan-calories').value),
        proteinas: parseFloat(document.getElementById('plan-proteins').value),
        carbohidratos: parseFloat(document.getElementById('plan-carbs').value),
        grasas: parseFloat(document.getElementById('plan-fats').value),
        comidas: document.getElementById('plan-meals').value,
        instrucciones: document.getElementById('plan-instructions').value || '',
        fecha_creacion: new Date().toISOString(),
        __backendId: Date.now().toString() + Math.random()
      };

      try {
        nutritionPlans.push(formData);
        saveToLocalStorage();
        closeNutritionModal();
        updateCurrentView();
        showToast('Plan nutricional creado exitosamente', 'success');
      } catch (error) {
        showToast('Error al crear plan nutricional', 'error');
      }

      btnSave.disabled = false;
      btnSave.textContent = 'Guardar Plan';
    }

    function openPatientDetail(backendId) {
      const patient = patients.find(p => p.__backendId === backendId);
      if (!patient) return;

      editingPatient = patient;
      
      document.getElementById('detail-patient-name').textContent = patient.nombre;
      
      const detailContent = document.getElementById('detail-content');
      detailContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-semibold text-lg mb-3 text-purple-600">InformaciÃ³n Personal</h3>
            <div class="space-y-2">
              <p><span class="font-medium">Edad:</span> ${patient.edad} aÃ±os</p>
              <p><span class="font-medium">GÃ©nero:</span> ${patient.genero}</p>
              ${patient.telefono ? `<p><span class="font-medium">TelÃ©fono:</span> ${patient.telefono}</p>` : ''}
              ${patient.email ? `<p><span class="font-medium">Email:</span> ${patient.email}</p>` : ''}
            </div>
          </div>

          <div>
            <h3 class="font-semibold text-lg mb-3 text-purple-600">Medidas BÃ¡sicas</h3>
            <div class="grid grid-cols-3 gap-3">
              <div class="metric-card">
                <p class="text-xs text-gray-600">Altura</p>
                <p class="font-bold">${patient.altura} cm</p>
              </div>
              <div class="metric-card">
                <p class="text-xs text-gray-600">Peso</p>
                <p class="font-bold">${patient.peso} kg</p>
              </div>
              <div class="metric-card">
                <p class="text-xs text-gray-600">IMC</p>
                <p class="font-bold">${patient.imc ? patient.imc.toFixed(1) : 'N/A'}</p>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <h3 class="font-semibold text-lg mb-3 text-purple-600">ComposiciÃ³n Corporal</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              ${patient.grasa_corporal ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">Grasa Corporal</p>
                  <p class="font-bold">${patient.grasa_corporal}%</p>
                </div>
              ` : ''}
              ${patient.musculatura_esqueletica ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">Musculatura</p>
                  <p class="font-bold">${patient.musculatura_esqueletica}%</p>
                </div>
              ` : ''}
              ${patient.agua_corporal ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">Agua Corporal</p>
                  <p class="font-bold">${patient.agua_corporal}%</p>
                </div>
              ` : ''}
              ${patient.grasa_visceral ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">Grasa Visceral</p>
                  <p class="font-bold">${patient.grasa_visceral}</p>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="md:col-span-2">
            <h3 class="font-semibold text-lg mb-3 text-purple-600">MÃ©tricas Adicionales</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              ${patient.masa_muscular ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">Masa Muscular</p>
                  <p class="font-bold">${patient.masa_muscular} kg</p>
                </div>
              ` : ''}
              ${patient.masa_osea ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">Masa Ã“sea</p>
                  <p class="font-bold">${patient.masa_osea} kg</p>
                </div>
              ` : ''}
              ${patient.tmb ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">TMB</p>
                  <p class="font-bold">${patient.tmb} kcal</p>
                </div>
              ` : ''}
              ${patient.edad_metabolica ? `
                <div class="metric-card">
                  <p class="text-xs text-gray-600">Edad MetabÃ³lica</p>
                  <p class="font-bold">${patient.edad_metabolica} aÃ±os</p>
                </div>
              ` : ''}
            </div>
          </div>

          ${patient.notas ? `
            <div class="md:col-span-2">
              <h3 class="font-semibold text-lg mb-3 text-purple-600">Notas</h3>
              <p class="text-gray-700 bg-gray-50 p-4 rounded-lg">${patient.notas}</p>
            </div>
          ` : ''}
        </div>
      `;

      document.getElementById('detail-modal').classList.remove('hidden');
    }

    function closeDetailModal() {
      document.getElementById('detail-modal').classList.add('hidden');
      editingPatient = null;
    }

    document.getElementById('btn-edit-patient').addEventListener('click', () => {
      if (!editingPatient) return;
      
      closeDetailModal();
      
      document.getElementById('modal-title').textContent = 'Editar Paciente';
      document.getElementById('nombre').value = editingPatient.nombre;
      document.getElementById('edad').value = editingPatient.edad;
      document.getElementById('genero').value = editingPatient.genero;
      document.getElementById('telefono').value = editingPatient.telefono || '';
      document.getElementById('email').value = editingPatient.email || '';
      document.getElementById('altura').value = editingPatient.altura;
      document.getElementById('peso').value = editingPatient.peso;
      document.getElementById('imc').value = editingPatient.imc || '';
      document.getElementById('grasa_corporal').value = editingPatient.grasa_corporal || '';
      document.getElementById('musculatura_esqueletica').value = editingPatient.musculatura_esqueletica || '';
      document.getElementById('peso_sin_grasa').value = editingPatient.peso_sin_grasa || '';
      document.getElementById('grasa_subcutanea').value = editingPatient.grasa_subcutanea || '';
      document.getElementById('grasa_visceral').value = editingPatient.grasa_visceral || '';
      document.getElementById('agua_corporal').value = editingPatient.agua_corporal || '';
      document.getElementById('masa_muscular').value = editingPatient.masa_muscular || '';
      document.getElementById('masa_osea').value = editingPatient.masa_osea || '';
      document.getElementById('proteina').value = editingPatient.proteina || '';
      document.getElementById('tmb').value = editingPatient.tmb || '';
      document.getElementById('edad_metabolica').value = editingPatient.edad_metabolica || '';
      document.getElementById('notas').value = editingPatient.notas || '';
      
      document.getElementById('patient-modal').classList.remove('hidden');
    });

    document.getElementById('btn-delete-patient').addEventListener('click', async () => {
      if (!editingPatient) return;

      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="card p-6 max-w-md">
          <h3 class="text-xl font-bold mb-4">Â¿Eliminar paciente?</h3>
          <p class="text-gray-600 mb-6">Esta acciÃ³n no se puede deshacer.</p>
          <div class="flex gap-3 justify-end">
            <button id="cancel-delete" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
            <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Eliminar</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);

      document.getElementById('cancel-delete').addEventListener('click', () => {
        document.body.removeChild(confirmDiv);
      });

      document.getElementById('confirm-delete').addEventListener('click', async () => {
        try {
          const index = patients.findIndex(p => p.__backendId === editingPatient.__backendId);
          if (index !== -1) {
            patients.splice(index, 1);
            saveToLocalStorage();
            updateCurrentView();
            closeDetailModal();
            showToast('Paciente eliminado', 'success');
          }
        } catch (error) {
          showToast('Error al eliminar paciente', 'error');
        }
        document.body.removeChild(confirmDiv);
      });
    });

    function initializeChatbot() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const greeting = config.chatbot_greeting || defaultConfig.chatbot_greeting;
      
      chatMessages = [{
        type: 'bot',
        text: greeting,
        timestamp: new Date()
      }];
      
      renderChatMessages();
    }

    function renderChatMessages() {
      const container = document.getElementById('chat-messages');
      container.innerHTML = chatMessages.map(msg => `
        <div class="chat-message flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}">
          <div class="max-w-[80%] ${msg.type === 'user' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-800'} rounded-lg px-4 py-3">
            <p>${msg.text}</p>
            <p class="text-xs opacity-70 mt-1">${msg.timestamp.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
          </div>
        </div>
      `).join('');
      
      container.scrollTop = container.scrollHeight;
    }

    function handleChatSubmit(e) {
      e.preventDefault();
      
      const input = document.getElementById('chat-input');
      const userMessage = input.value.trim();
      
      if (!userMessage) return;
      
      chatMessages.push({
        type: 'user',
        text: userMessage,
        timestamp: new Date()
      });
      
      input.value = '';
      renderChatMessages();
      
      setTimeout(() => {
        const botResponse = generateBotResponse(userMessage);
        chatMessages.push({
          type: 'bot',
          text: botResponse,
          timestamp: new Date()
        });
        renderChatMessages();
      }, 1000);
    }

    function generateBotResponse(message) {
      const lowerMessage = message.toLowerCase();
      
      if (lowerMessage.includes('imc') || lowerMessage.includes('Ã­ndice de masa corporal')) {
        return 'El IMC se calcula dividiendo el peso (kg) entre la altura al cuadrado (mÂ²). Un IMC entre 18.5 y 24.9 se considera normal. Â¿Necesitas calcular el IMC de algÃºn paciente?';
      }
      
      if (lowerMessage.includes('grasa corporal') || lowerMessage.includes('porcentaje de grasa')) {
        return 'El porcentaje de grasa corporal ideal varÃ­a segÃºn gÃ©nero y edad. Para hombres: 10-20%, para mujeres: 18-28%. Valores mÃ¡s altos pueden indicar riesgo de obesidad.';
      }
      
      if (lowerMessage.includes('tmb') || lowerMessage.includes('tasa metabÃ³lica') || lowerMessage.includes('metabolismo basal')) {
        return 'La TMB (Tasa MetabÃ³lica Basal) es la cantidad de calorÃ­as que tu cuerpo necesita en reposo. Se calcula con fÃ³rmulas como Harris-Benedict considerando peso, altura, edad y gÃ©nero.';
      }
      
      if (lowerMessage.includes('agua corporal') || lowerMessage.includes('hidrataciÃ³n')) {
        return 'El agua corporal ideal es 50-65% del peso total. Niveles bajos pueden indicar deshidrataciÃ³n, mientras que niveles muy altos pueden sugerir retenciÃ³n de lÃ­quidos.';
      }
      
      if (lowerMessage.includes('masa muscular') || lowerMessage.includes('mÃºsculo')) {
        return 'La masa muscular es crucial para el metabolismo. Un buen porcentaje de mÃºsculo esquelÃ©tico es 40-50% para hombres y 30-40% para mujeres. El ejercicio de resistencia ayuda a aumentarla.';
      }
      
      if (lowerMessage.includes('dieta') || lowerMessage.includes('alimentaciÃ³n') || lowerMessage.includes('nutriciÃ³n')) {
        return 'Una dieta balanceada debe incluir: proteÃ­nas (15-25%), carbohidratos (45-65%), y grasas saludables (20-35%). Ajusta segÃºn objetivos del paciente: pÃ©rdida de peso, ganancia muscular, o mantenimiento.';
      }
      
      if (lowerMessage.includes('paciente') || lowerMessage.includes('registro')) {
        return `Actualmente tienes ${patients.length} paciente${patients.length !== 1 ? 's' : ''} registrado${patients.length !== 1 ? 's' : ''}. Puedes agregar nuevos pacientes desde la vista principal y hacer seguimiento de todas sus mÃ©tricas.`;
      }
      
      if (lowerMessage.includes('cita') || lowerMessage.includes('calendario')) {
        return `Tienes ${appointments.length} cita${appointments.length !== 1 ? 's' : ''} programada${appointments.length !== 1 ? 's' : ''}. Usa el calendario para gestionar tus citas y ver las prÃ³ximas consultas.`;
      }
      
      if (lowerMessage.includes('plan') || lowerMessage.includes('nutricional')) {
        return `Has creado ${nutritionPlans.length} plan${nutritionPlans.length !== 1 ? 'es' : ''} nutricional${nutritionPlans.length !== 1 ? 'es' : ''}. Los planes te ayudan a estructurar la alimentaciÃ³n de tus pacientes segÃºn sus objetivos.`;
      }
      
      if (lowerMessage.includes('grasa visceral')) {
        return 'La grasa visceral rodea los Ã³rganos internos. Un nivel saludable es 1-12. Niveles superiores a 13 aumentan el riesgo de enfermedades cardiovasculares y diabetes.';
      }
      
      if (lowerMessage.includes('proteÃ­na') || lowerMessage.includes('proteinas')) {
        return 'La ingesta recomendada de proteÃ­na es 0.8-1g por kg de peso para mantenimiento, y 1.6-2.2g/kg para ganancia muscular. Fuentes: carnes magras, pescado, huevos, legumbres.';
      }
      
      return 'Entiendo tu pregunta. Como asistente nutricional, puedo ayudarte con informaciÃ³n sobre IMC, composiciÃ³n corporal, TMB, planes alimenticios, gestiÃ³n de citas y seguimiento de pacientes. Â¿Sobre quÃ© tema especÃ­fico necesitas ayuda?';
    }

    function updateStorageInfo() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      document.getElementById('storage-mode-display').textContent = config.storage_mode || defaultConfig.storage_mode;
      
      const totalRecords = patients.length + appointments.length + nutritionPlans.length;
      document.getElementById('local-records-count').textContent = totalRecords;
      
      document.getElementById('storage-patients-count').textContent = patients.length;
      document.getElementById('storage-appointments-count').textContent = appointments.length;
      document.getElementById('storage-plans-count').textContent = nutritionPlans.length;
      
      // Calculate storage size
      try {
        const dataString = localStorage.getItem(STORAGE_KEY) || '{}';
        const sizeInBytes = new Blob([dataString]).size;
        const sizeInKB = (sizeInBytes / 1024).toFixed(2);
        document.getElementById('storage-size').textContent = `${sizeInKB} KB`;
      } catch (error) {
        document.getElementById('storage-size').textContent = 'N/A';
      }
    }

    function exportData() {
      try {
        const exportData = {
          patients,
          appointments,
          nutritionPlans,
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `nutritrack_backup_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showToast('Datos exportados exitosamente', 'success');
      } catch (error) {
        showToast('Error al exportar datos', 'error');
      }
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          if (importedData.patients && importedData.appointments && importedData.nutritionPlans) {
            // Confirm import
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
              <div class="card p-6 max-w-md">
                <h3 class="text-xl font-bold mb-4">Â¿Importar datos?</h3>
                <p class="text-gray-600 mb-2">Se encontraron:</p>
                <ul class="text-sm text-gray-600 mb-4">
                  <li>â€¢ ${importedData.patients.length} pacientes</li>
                  <li>â€¢ ${importedData.appointments.length} citas</li>
                  <li>â€¢ ${importedData.nutritionPlans.length} planes nutricionales</li>
                </ul>
                <p class="text-red-600 text-sm mb-6">âš ï¸ Esto reemplazarÃ¡ todos los datos actuales</p>
                <div class="flex gap-3 justify-end">
                  <button id="cancel-import" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                  <button id="confirm-import" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Importar</button>
                </div>
              </div>
            `;
            document.body.appendChild(confirmDiv);

            document.getElementById('cancel-import').addEventListener('click', () => {
              document.body.removeChild(confirmDiv);
            });

            document.getElementById('confirm-import').addEventListener('click', () => {
              patients = importedData.patients;
              appointments = importedData.appointments;
              nutritionPlans = importedData.nutritionPlans;
              
              // Ensure all items have __backendId
              patients.forEach(p => {
                if (!p.__backendId) p.__backendId = p.id || Date.now().toString() + Math.random();
              });
              appointments.forEach(a => {
                if (!a.__backendId) a.__backendId = a.id || Date.now().toString() + Math.random();
              });
              nutritionPlans.forEach(n => {
                if (!n.__backendId) n.__backendId = n.id || Date.now().toString() + Math.random();
              });
              
              saveToLocalStorage();
              updateCurrentView();
              document.body.removeChild(confirmDiv);
              showToast('Datos importados exitosamente', 'success');
            });
          } else {
            showToast('Archivo de respaldo invÃ¡lido', 'error');
          }
        } catch (error) {
          showToast('Error al leer el archivo', 'error');
        }
      };
      reader.readAsText(file);
      
      // Reset file input
      event.target.value = '';
    }

    function clearAllData() {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="card p-6 max-w-md">
          <h3 class="text-xl font-bold mb-4">âš ï¸ Â¿Limpiar todos los datos?</h3>
          <p class="text-gray-600 mb-4">Se eliminarÃ¡n permanentemente:</p>
          <ul class="text-sm text-gray-600 mb-4">
            <li>â€¢ ${patients.length} pacientes</li>
            <li>â€¢ ${appointments.length} citas</li>
            <li>â€¢ ${nutritionPlans.length} planes nutricionales</li>
          </ul>
          <p class="text-red-600 text-sm mb-6">Esta acciÃ³n no se puede deshacer</p>
          <div class="flex gap-3 justify-end">
            <button id="cancel-clear" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
            <button id="confirm-clear" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Limpiar Todo</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);

      document.getElementById('cancel-clear').addEventListener('click', () => {
        document.body.removeChild(confirmDiv);
      });

      document.getElementById('confirm-clear').addEventListener('click', () => {
        patients = [];
        appointments = [];
        nutritionPlans = [];
        localStorage.removeItem(STORAGE_KEY);
        updateCurrentView();
        document.body.removeChild(confirmDiv);
        showToast('Todos los datos han sido eliminados', 'success');
      });
    }

    function editAppointment(backendId) {
      const appointment = appointments.find(a => a.__backendId === backendId);
      if (!appointment) return;

      editingAppointment = appointment;
      
      document.getElementById('appointment-modal-title').textContent = 'Editar Cita';
      
      // Populate patient dropdown
      const patientSelect = document.getElementById('appointment-patient');
      patientSelect.innerHTML = '<option value="">Seleccionar paciente</option>' +
        patients.map(p => `<option value="${p.__backendId}">${p.nombre}</option>`).join('');
      
      // Fill form with appointment data
      document.getElementById('appointment-patient').value = appointment.paciente_id;
      document.getElementById('appointment-type').value = appointment.tipo;
      document.getElementById('appointment-date').value = appointment.fecha;
      document.getElementById('appointment-time').value = appointment.hora;
      document.getElementById('appointment-notes').value = appointment.observaciones || '';
      
      document.getElementById('appointment-modal').classList.remove('hidden');
    }

    function deleteAppointment(backendId) {
      const appointment = appointments.find(a => a.__backendId === backendId);
      if (!appointment) return;

      const patient = patients.find(p => p.__backendId === appointment.paciente_id);
      
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="card p-6 max-w-md">
          <h3 class="text-xl font-bold mb-4">Â¿Eliminar cita?</h3>
          <div class="mb-4">
            <p class="text-gray-600 mb-2"><strong>Paciente:</strong> ${patient ? patient.nombre : 'Desconocido'}</p>
            <p class="text-gray-600 mb-2"><strong>Tipo:</strong> ${appointment.tipo}</p>
            <p class="text-gray-600 mb-2"><strong>Fecha:</strong> ${new Date(appointment.fecha).toLocaleDateString('es-ES')} - ${appointment.hora}</p>
          </div>
          <p class="text-red-600 text-sm mb-6">Esta acciÃ³n no se puede deshacer.</p>
          <div class="flex gap-3 justify-end">
            <button id="cancel-delete-apt" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
            <button id="confirm-delete-apt" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Eliminar</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);

      document.getElementById('cancel-delete-apt').addEventListener('click', () => {
        document.body.removeChild(confirmDiv);
      });

      document.getElementById('confirm-delete-apt').addEventListener('click', () => {
        try {
          const index = appointments.findIndex(a => a.__backendId === backendId);
          if (index !== -1) {
            appointments.splice(index, 1);
            saveToLocalStorage();
            updateCurrentView();
            showToast('Cita eliminada exitosamente', 'success');
          }
        } catch (error) {
          showToast('Error al eliminar cita', 'error');
        }
        document.body.removeChild(confirmDiv);
      });
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg text-white font-medium shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Make functions globally available
    window.editAppointment = editAppointment;
    window.deleteAppointment = deleteAppointment;

    init();
  </script>
  </div>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9997c6d2f2e1f048',t:'MTc2MjI5Nzc0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>