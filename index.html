<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n Nutricional</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        * {
            box-sizing: border-box;
        }

        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            transition: all 0.2s;
        }

        .nav-item:hover {
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .input-field {
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .calendar-day {
            transition: all 0.3s ease;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 8px 4px;
            border: 1px solid #e5e7eb;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.has-appointment {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            font-weight: bold;
            color: #92400e;
        }

        .calendar-day.other-month {
            color: #d1d5db;
            background-color: #f9fafb;
        }

        .calendar-day-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-appointment-dot {
            width: 6px;
            height: 6px;
            background-color: #3b82f6;
            border-radius: 50%;
            margin: 1px;
        }

        .calendar-appointment-count {
            font-size: 10px;
            background-color: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            margin-top: 2px;
            font-weight: bold;
        }

        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .calendar-weekday {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #475569;
            font-weight: 600;
            padding: 12px;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .metric-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .metric-normal {
            background-color: #d1fae5;
            color: #065f46;
        }

        .metric-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .metric-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50">
  <div class="flex h-full"><!-- Sidebar -->
   <div class="w-64 bg-white shadow-lg">
    <div class="p-6 border-b border-gray-200">
     <h1 id="app-title" class="text-2xl font-bold text-gray-800">Gesti√≥n Nutricional</h1>
     <p id="clinic-name" class="text-sm text-gray-500 mt-1">Mi Cl√≠nica Nutricional</p>
    </div>
    <nav class="p-4"><button onclick="showSection('pacientes')" class="nav-item active w-full text-left px-4 py-3 rounded-lg mb-2 font-medium" id="nav-pacientes"> üìã Pacientes </button> <button onclick="showSection('calendario')" class="nav-item w-full text-left px-4 py-3 rounded-lg mb-2 font-medium text-gray-700" id="nav-calendario"> üìÖ Calendario </button> <button onclick="showSection('planes')" class="nav-item w-full text-left px-4 py-3 rounded-lg mb-2 font-medium text-gray-700" id="nav-planes"> üçé Planes Nutricionales </button> <button onclick="showSection('estadisticas')" class="nav-item w-full text-left px-4 py-3 rounded-lg mb-2 font-medium text-gray-700" id="nav-estadisticas"> üìä Estad√≠sticas </button> <button onclick="showSection('reportes')" class="nav-item w-full text-left px-4 py-3 rounded-lg mb-2 font-medium text-gray-700" id="nav-reportes"> üìÑ Reportes </button> <button onclick="showSection('asistente')" class="nav-item w-full text-left px-4 py-3 rounded-lg mb-2 font-medium text-gray-700" id="nav-asistente"> ü§ñ Asistente IA </button>
    </nav>
   </div><!-- Main Content -->
   <div class="flex-1 overflow-y-auto"><!-- Pacientes Section -->
    <div id="section-pacientes" class="p-8">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Gesti√≥n de Pacientes</h2><button onclick="showAddPatientForm()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium"> ‚ûï Nuevo Paciente </button>
     </div>
     <div id="patients-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Patients will be rendered here -->
     </div><!-- Add/Edit Patient Form -->
     <div id="patient-form-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90%] overflow-y-auto">
       <div class="p-6 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-2xl font-bold text-gray-800" id="form-title">Nuevo Paciente</h3><button onclick="closePatientForm()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
       </div>
       <form id="patient-form" class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label> <input type="text" id="input-nombre" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Edad *</label> <input type="number" id="input-edad" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">G√©nero *</label> <select id="input-genero" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleccionar</option> <option value="Masculino">Masculino</option> <option value="Femenino">Femenino</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Altura (cm) *</label> <input type="number" step="0.1" id="input-altura" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Peso (kg) *</label> <input type="number" step="0.1" id="input-peso" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Grasa Corporal (%) <span class="text-xs text-gray-500">- Opcional, se calcular√° autom√°ticamente</span></label> <input type="number" step="0.1" id="input-grasa" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Se calcular√° autom√°ticamente">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Musculatura Esquel√©tica (%)</label> <input type="number" step="0.1" id="input-musculatura" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Grasa Subcut√°nea (%)</label> <input type="number" step="0.1" id="input-grasa-subcutanea" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Grasa Visceral (nivel)</label> <input type="number" step="0.1" id="input-grasa-visceral" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Agua Corporal (%)</label> <input type="number" step="0.1" id="input-agua" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Masa Muscular (kg)</label> <input type="number" step="0.1" id="input-masa-muscular" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Masa √ìsea (kg)</label> <input type="number" step="0.1" id="input-masa-osea" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Prote√≠na (%)</label> <input type="number" step="0.1" id="input-proteina" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div class="col-span-full"><button type="button" onclick="autoFillCalculatedFields()" class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg font-medium hover:from-green-600 hover:to-blue-600 transition-all"> üßÆ Calcular Autom√°ticamente Todos los Par√°metros </button>
          <p class="text-xs text-gray-500 mt-2 text-center">Completa peso, altura, edad y g√©nero, luego haz clic para calcular el resto</p>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label> <input type="tel" id="input-telefono" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="input-email" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
        </div><!-- Vista previa de c√°lculos -->
        <div id="metrics-preview" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
         <h4 class="font-semibold text-blue-800 mb-3">üìä Vista Previa de C√°lculos</h4>
         <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div class="text-center">
           <p class="text-blue-600 font-medium">IMC</p>
           <p class="text-lg font-bold text-blue-800" id="preview-imc">-</p>
          </div>
          <div class="text-center">
           <p class="text-blue-600 font-medium">TMB</p>
           <p class="text-lg font-bold text-blue-800" id="preview-tmb">-</p>
          </div>
          <div class="text-center">
           <p class="text-blue-600 font-medium">Grasa Corporal</p>
           <p class="text-lg font-bold text-blue-800" id="preview-grasa">-</p>
          </div>
          <div class="text-center">
           <p class="text-blue-600 font-medium">Edad Metab√≥lica</p>
           <p class="text-lg font-bold text-blue-800" id="preview-edad-metabolica">-</p>
          </div>
         </div><button type="button" onclick="toggleAdvancedPreview()" class="mt-3 text-blue-600 hover:text-blue-800 text-sm font-medium"> <span id="advanced-toggle-text">Ver m√°s detalles ‚ñº</span> </button>
         <div id="advanced-preview" class="hidden mt-3 grid grid-cols-2 md:grid-cols-3 gap-3 text-xs">
          <div class="bg-white p-2 rounded">
           <p class="text-gray-600">Peso sin Grasa</p>
           <p class="font-bold" id="preview-peso-sin-grasa">-</p>
          </div>
          <div class="bg-white p-2 rounded">
           <p class="text-gray-600">Masa Muscular</p>
           <p class="font-bold" id="preview-masa-muscular">-</p>
          </div>
          <div class="bg-white p-2 rounded">
           <p class="text-gray-600">Agua Corporal</p>
           <p class="font-bold" id="preview-agua">-</p>
          </div>
          <div class="bg-white p-2 rounded">
           <p class="text-gray-600">Grasa Visceral</p>
           <p class="font-bold" id="preview-grasa-visceral">-</p>
          </div>
          <div class="bg-white p-2 rounded">
           <p class="text-gray-600">Masa √ìsea</p>
           <p class="font-bold" id="preview-masa-osea">-</p>
          </div>
          <div class="bg-white p-2 rounded">
           <p class="text-gray-600">Prote√≠na</p>
           <p class="font-bold" id="preview-proteina">-</p>
          </div>
         </div>
        </div>
        <div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closePatientForm()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"> Cancelar </button> <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2"> <span id="save-btn-text">Guardar Paciente</span>
          <div id="save-spinner" class="loading-spinner hidden"></div></button>
        </div>
       </form>
      </div>
     </div><!-- Patient Detail View -->
     <div id="patient-detail-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90%] overflow-y-auto">
       <div class="p-6 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-2xl font-bold text-gray-800" id="detail-patient-name">Detalles del Paciente</h3><button onclick="closePatientDetail()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
       </div>
       <div id="patient-detail-content" class="p-6"><!-- Patient details will be rendered here -->
       </div>
      </div>
     </div>
    </div><!-- Calendario Section -->
    <div id="section-calendario" class="p-8 hidden">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Calendario de Citas</h2><button onclick="showAddAppointmentForm()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium"> ‚ûï Nueva Cita </button>
     </div>
     <div class="bg-white rounded-xl shadow-xl overflow-hidden mb-6"><!-- Calendar Header -->
      <div class="calendar-header">
       <div class="flex justify-between items-center"><button onclick="previousMonth()" class="calendar-nav-btn flex items-center gap-2"> <span>‚Üê</span> Anterior </button>
        <div class="text-center">
         <h3 class="text-2xl font-bold" id="calendar-month-year"></h3>
         <p class="text-sm opacity-80 mt-1">Haz clic en un d√≠a para agendar una cita</p>
        </div><button onclick="nextMonth()" class="calendar-nav-btn flex items-center gap-2"> Siguiente <span>‚Üí</span> </button>
       </div>
      </div><!-- Calendar Grid -->
      <div class="grid grid-cols-7"><!-- Weekday Headers -->
       <div class="calendar-weekday">
        Dom
       </div>
       <div class="calendar-weekday">
        Lun
       </div>
       <div class="calendar-weekday">
        Mar
       </div>
       <div class="calendar-weekday">
        Mi√©
       </div>
       <div class="calendar-weekday">
        Jue
       </div>
       <div class="calendar-weekday">
        Vie
       </div>
       <div class="calendar-weekday">
        S√°b
       </div><!-- Calendar Days -->
       <div id="calendar-days" class="contents"></div>
      </div><!-- Calendar Legend -->
      <div class="p-4 bg-gray-50 border-t">
       <div class="flex flex-wrap gap-4 justify-center text-sm">
        <div class="flex items-center gap-2">
         <div class="w-4 h-4 rounded border-2 border-f59e0b bg-gradient-to-br from-yellow-200 to-yellow-300"></div><span class="text-gray-600">Hoy</span>
        </div>
        <div class="flex items-center gap-2">
         <div class="w-4 h-4 rounded border-2 border-blue-500 bg-gradient-to-br from-blue-200 to-blue-300"></div><span class="text-gray-600">Con citas</span>
        </div>
        <div class="flex items-center gap-2">
         <div class="w-2 h-2 rounded-full bg-blue-500"></div><span class="text-gray-600">Indicador de cita</span>
        </div>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl shadow-xl p-6">
      <div class="flex items-center justify-between mb-6">
       <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"><span class="text-white text-lg">üìÖ</span>
        </div>
        <div>
         <h3 class="text-xl font-bold text-gray-800">Pr√≥ximas Citas</h3>
         <p class="text-sm text-gray-500">Citas programadas para los pr√≥ximos d√≠as</p>
        </div>
       </div>
       <div class="text-right">
        <p class="text-2xl font-bold text-blue-600" id="upcoming-count">0</p>
        <p class="text-xs text-gray-500">Pendientes</p>
       </div>
      </div>
      <div id="appointments-list" class="space-y-3"><!-- Appointments will be rendered here -->
      </div>
     </div><!-- Add Appointment Form -->
     <div id="appointment-form-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
       <div class="p-6 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-2xl font-bold text-gray-800">Nueva Cita</h3><button onclick="closeAppointmentForm()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
       </div>
       <form id="appointment-form" class="p-6">
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Paciente *</label> <select id="input-paciente-cita" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleccionar paciente</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Fecha *</label> <input type="date" id="input-fecha" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Hora *</label> <input type="time" id="input-hora" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Motivo</label> <textarea id="input-motivo" rows="3" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
         </div>
        </div>
        <div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeAppointmentForm()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"> Cancelar </button> <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2"> <span id="save-appointment-btn-text">Guardar Cita</span>
          <div id="save-appointment-spinner" class="loading-spinner hidden"></div></button>
        </div>
       </form>
      </div>
     </div>
    </div><!-- Planes Section -->
    <div id="section-planes" class="p-8 hidden">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Planes Nutricionales</h2><button onclick="showAddPlanForm()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium"> ‚ûï Nuevo Plan </button>
     </div>
     <div id="plans-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Plans will be rendered here -->
     </div><!-- Add Plan Form -->
     <div id="plan-form-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90%] overflow-y-auto">
       <div class="p-6 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-2xl font-bold text-gray-800" id="plan-form-title">Nuevo Plan Nutricional</h3><button onclick="closePlanForm()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
       </div>
       <form id="plan-form" class="p-6">
        <div class="space-y-6">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Paciente *</label> <select id="input-paciente-plan" required class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Seleccionar paciente</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Objetivo *</label> <input type="text" id="input-objetivo" required placeholder="Ej: P√©rdida de peso, Ganancia muscular" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div><!-- Plan Nutricional Estructurado -->
         <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
          <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">üçΩÔ∏è Plan Nutricional Diario</h4><!-- Desayuno -->
          <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
           <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üåÖ</span>
            <h5 class="font-semibold text-gray-700">Desayuno</h5><span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">7:00 - 9:00 AM</span>
           </div><textarea id="input-desayuno" rows="3" placeholder="Ej: 1 taza de avena con frutas, 1 vaso de leche descremada, 2 rebanadas de pan integral..." class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
          </div><!-- Colaci√≥n Matutina -->
          <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
           <div class="flex items-center gap-2 mb-3"><span class="text-2xl">ü•§</span>
            <h5 class="font-semibold text-gray-700">Colaci√≥n Matutina</h5><span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">10:00 - 11:00 AM</span>
           </div><textarea id="input-colacion-matutina" rows="2" placeholder="Ej: 1 manzana con 10 almendras, 1 yogurt griego natural..." class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
          </div><!-- Almuerzo -->
          <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
           <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üçΩÔ∏è</span>
            <h5 class="font-semibold text-gray-700">Almuerzo</h5><span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">12:00 - 2:00 PM</span>
           </div><textarea id="input-almuerzo" rows="4" placeholder="Ej: 150g de pollo a la plancha, 1 taza de arroz integral, ensalada mixta con aceite de oliva..." class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
          </div><!-- Colaci√≥n Vespertina -->
          <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
           <div class="flex items-center gap-2 mb-3"><span class="text-2xl">ü•®</span>
            <h5 class="font-semibold text-gray-700">Colaci√≥n Vespertina</h5><span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">4:00 - 5:00 PM</span>
           </div><textarea id="input-colacion-vespertina" rows="2" placeholder="Ej: 1 batido de prote√≠nas, galletas integrales, frutos secos..." class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
          </div><!-- Cena -->
          <div class="mb-4 bg-white rounded-lg p-4 shadow-sm">
           <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üåô</span>
            <h5 class="font-semibold text-gray-700">Cena</h5><span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">7:00 - 9:00 PM</span>
           </div><textarea id="input-cena" rows="3" placeholder="Ej: 120g de pescado al vapor, verduras salteadas, 1 rebanada de pan integral..." class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
          </div>
         </div><!-- Informaci√≥n Adicional -->
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üíß Hidrataci√≥n Diaria</label> <input type="text" id="input-hidratacion" placeholder="Ej: 2-3 litros de agua, infusiones sin az√∫car" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">üèÉ‚Äç‚ôÄÔ∏è Actividad F√≠sica Recomendada</label> <input type="text" id="input-ejercicio" placeholder="Ej: 30 min caminata diaria, 3 d√≠as gym" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">üìù Notas y Restricciones</label> <textarea id="input-notas" rows="3" placeholder="Alergias, intolerancias, preferencias alimentarias, medicamentos..." class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">‚ö†Ô∏è Recomendaciones Especiales</label> <textarea id="input-recomendaciones" rows="2" placeholder="Suplementos, horarios espec√≠ficos, precauciones..." class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
         </div>
        </div>
        <div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closePlanForm()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"> Cancelar </button> <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2"> <span id="save-plan-btn-text">Guardar Plan</span>
          <div id="save-plan-spinner" class="loading-spinner hidden"></div></button>
        </div>
       </form>
      </div>
     </div>
    </div><!-- Reportes Section -->
    <div id="section-reportes" class="p-8 hidden">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-gray-800">Generador de Reportes</h2>
      <div class="flex items-center gap-2 text-sm text-gray-500"><span>üìÑ</span> <span>Genera reportes completos para enviar a tus pacientes</span>
      </div>
     </div>
     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><!-- Panel de Selecci√≥n -->
      <div class="lg:col-span-1">
       <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">üéØ Seleccionar Paciente</h3>
        <div class="space-y-4">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Paciente *</label> <select id="report-patient-select" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadPatientData()"> <option value="">Seleccionar paciente</option> </select>
         </div>
         <div id="patient-summary" class="hidden bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-200">
          <h4 class="font-semibold text-gray-800 mb-2">Resumen del Paciente</h4>
          <div class="space-y-1 text-sm">
           <div class="flex justify-between"><span class="text-gray-600">Edad:</span> <span id="summary-edad" class="font-medium">-</span>
           </div>
           <div class="flex justify-between"><span class="text-gray-600">IMC:</span> <span id="summary-imc" class="font-medium">-</span>
           </div>
           <div class="flex justify-between"><span class="text-gray-600">Planes:</span> <span id="summary-planes" class="font-medium">-</span>
           </div>
           <div class="flex justify-between"><span class="text-gray-600">Citas:</span> <span id="summary-citas" class="font-medium">-</span>
           </div>
          </div>
         </div>
         <div class="space-y-3">
          <h4 class="font-semibold text-gray-700">Opciones del Reporte</h4><label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="include-personal" checked class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Informaci√≥n Personal</span> </label> <label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="include-metrics" checked class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">M√©tricas Corporales</span> </label> <label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="include-plans" checked class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Planes Nutricionales</span> </label> <label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="include-appointments" checked class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Historial de Citas</span> </label> <label class="flex items-center gap-3 cursor-pointer"> <input type="checkbox" id="include-recommendations" checked class="w-4 h-4 text-blue-600 rounded"> <span class="text-sm text-gray-700">Recomendaciones</span> </label>
         </div><button onclick="generateReport()" id="generate-btn" class="w-full btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:opacity-50" disabled> <span>üìÑ</span> <span>Generar Reporte</span> </button> <button onclick="downloadReport()" id="download-btn" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 hidden"> <span>üíæ</span> <span>Descargar TXT</span> </button> <button onclick="copyReport()" id="copy-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 hidden"> <span>üìã</span> <span>Copiar Texto</span> </button>
        </div>
       </div>
      </div><!-- Vista Previa del Reporte -->
      <div class="lg:col-span-2">
       <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
         <h3 class="text-xl font-bold flex items-center gap-2">üìã Vista Previa del Reporte</h3>
         <p class="text-blue-100 mt-1">El reporte se generar√° en formato de texto plano</p>
        </div>
        <div class="p-6">
         <div id="report-preview" class="bg-gray-50 rounded-lg p-6 font-mono text-sm whitespace-pre-wrap min-h-[500px] border-2 border-dashed border-gray-300">
          <div class="text-center text-gray-500 mt-20">
           <div class="text-4xl mb-4">
            üìÑ
           </div>
           <p class="text-lg font-medium">Selecciona un paciente para generar el reporte</p>
           <p class="text-sm mt-2">El reporte incluir√° toda la informaci√≥n relevante del tratamiento</p>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Asistente IA Section -->
    <div id="section-asistente" class="p-8 hidden">
     <div class="flex justify-between items-center mb-6">
      <div>
       <h2 class="text-3xl font-bold text-gray-800">Asistente IA Nutricional</h2>
       <p class="text-gray-600 mt-2">Tu asistente inteligente para consultas nutricionales y an√°lisis de pacientes</p>
      </div>
      <div class="flex items-center gap-2 text-sm text-gray-500">
       <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div><span>IA Activa</span>
      </div>
     </div>
     <div class="grid grid-cols-1 lg:grid-cols-4 gap-6"><!-- Panel de Acciones R√°pidas -->
      <div class="lg:col-span-1">
       <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">‚ö° Acciones R√°pidas</h3>
        <div class="space-y-3"><button onclick="quickAnalyzePatient()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-3 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all flex items-center gap-2"> <span>üë§</span> <span>Analizar Paciente</span> </button> <button onclick="quickMealPlan()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white px-4 py-3 rounded-lg font-medium hover:from-green-600 hover:to-teal-700 transition-all flex items-center gap-2"> <span>üçΩÔ∏è</span> <span>Plan de Comidas</span> </button> <button onclick="quickNutritionTips()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white px-4 py-3 rounded-lg font-medium hover:from-orange-600 hover:to-red-700 transition-all flex items-center gap-2"> <span>üí°</span> <span>Tips Nutricionales</span> </button> <button onclick="quickFoodAnalysis()" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-3 rounded-lg font-medium hover:from-purple-600 hover:to-pink-700 transition-all flex items-center gap-2"> <span>üîç</span> <span>An√°lisis de Alimentos</span> </button> <button onclick="clearChat()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-2"> <span>üóëÔ∏è</span> <span>Limpiar Chat</span> </button>
        </div><!-- Selector de Paciente para An√°lisis -->
        <div class="mt-6 pt-6 border-t border-gray-200">
         <h4 class="font-semibold text-gray-700 mb-3">Paciente para An√°lisis</h4><select id="ai-patient-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"> <option value="">Seleccionar paciente</option> </select>
        </div><!-- Estad√≠sticas del Chat -->
        <div class="mt-6 pt-6 border-t border-gray-200">
         <h4 class="font-semibold text-gray-700 mb-3">Estad√≠sticas</h4>
         <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span class="text-gray-600">Consultas:</span> <span id="chat-count" class="font-medium">0</span>
          </div>
          <div class="flex justify-between"><span class="text-gray-600">An√°lisis:</span> <span id="analysis-count" class="font-medium">0</span>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Chat Interface -->
      <div class="lg:col-span-3">
       <div class="bg-white rounded-xl shadow-lg overflow-hidden h-[700px] flex flex-col"><!-- Chat Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
         <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
           <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center"><span class="text-2xl">ü§ñ</span>
           </div>
           <div>
            <h3 class="text-xl font-bold">NutriBot</h3>
            <p class="text-blue-100 text-sm">Asistente Nutricional Inteligente</p>
           </div>
          </div>
          <div class="flex items-center gap-2 text-sm">
           <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div><span class="text-blue-100">En l√≠nea</span>
          </div>
         </div>
        </div><!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50"><!-- Mensaje de bienvenida -->
         <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-white text-sm">ü§ñ</span>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
           <p class="text-gray-800">¬°Hola! Soy tu asistente nutricional inteligente. Puedo ayudarte con:</p>
           <ul class="mt-2 text-sm text-gray-600 space-y-1">
            <li>‚Ä¢ An√°lisis de pacientes y m√©tricas</li>
            <li>‚Ä¢ Recomendaciones nutricionales</li>
            <li>‚Ä¢ Planes de alimentaci√≥n personalizados</li>
            <li>‚Ä¢ Informaci√≥n sobre alimentos y nutrientes</li>
            <li>‚Ä¢ Interpretaci√≥n de datos corporales</li>
           </ul>
           <p class="mt-2 text-sm text-gray-600">¬øEn qu√© puedo ayudarte hoy?</p>
          </div>
         </div>
        </div><!-- Chat Input -->
        <div class="border-t border-gray-200 p-4 bg-white">
         <form id="chat-form" class="flex gap-3"><input type="text" id="chat-input" placeholder="Escribe tu consulta nutricional aqu√≠..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" autocomplete="off"> <button type="submit" id="send-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all flex items-center gap-2 disabled:opacity-50"> <span id="send-icon">üì§</span> <span id="send-text">Enviar</span> </button>
         </form><!-- Sugerencias de preguntas -->
         <div class="mt-3">
          <div class="flex flex-wrap gap-2"><button onclick="sendSuggestion('¬øC√≥mo interpreto un IMC de 28.5?')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors"> ¬øC√≥mo interpreto un IMC de 28.5? </button> <button onclick="sendSuggestion('Recomienda alimentos ricos en prote√≠na')" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full hover:bg-green-200 transition-colors"> Alimentos ricos en prote√≠na </button> <button onclick="sendSuggestion('¬øQu√© significa tener grasa visceral nivel 12?')" class="text-xs bg-orange-100 text-orange-700 px-3 py-1 rounded-full hover:bg-orange-200 transition-colors"> Grasa visceral nivel 12 </button>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Estad√≠sticas Section -->
    <div id="section-estadisticas" class="p-8 hidden">
     <h2 class="text-3xl font-bold text-gray-800 mb-6">Estad√≠sticas</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="stat-card bg-white rounded-lg shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm font-medium">Total Pacientes</p>
         <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-total-patients">0</p>
        </div>
        <div class="text-4xl">
         üë•
        </div>
       </div>
      </div>
      <div class="stat-card bg-white rounded-lg shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm font-medium">Citas Pendientes</p>
         <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-pending-appointments">0</p>
        </div>
        <div class="text-4xl">
         üìÖ
        </div>
       </div>
      </div>
      <div class="stat-card bg-white rounded-lg shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm font-medium">Planes Activos</p>
         <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-active-plans">0</p>
        </div>
        <div class="text-4xl">
         üçé
        </div>
       </div>
      </div>
      <div class="stat-card bg-white rounded-lg shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm font-medium">IMC Promedio</p>
         <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-avg-imc">0</p>
        </div>
        <div class="text-4xl">
         üìä
        </div>
       </div>
      </div>
     </div>
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">Distribuci√≥n por G√©nero</h3>
       <div id="gender-stats" class="space-y-4"><!-- Gender stats will be rendered here -->
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">Rangos de IMC</h3>
       <div id="imc-stats" class="space-y-4"><!-- IMC stats will be rendered here -->
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        const defaultConfig = {
            app_title: "Gesti√≥n Nutricional",
            clinic_name: "Mi Cl√≠nica Nutricional",
            primary_color: "#667eea",
            secondary_color: "#764ba2",
            background_color: "#f9fafb",
            text_color: "#1f2937",
            accent_color: "#3b82f6"
        };

        let allData = [];
        let currentSection = 'pacientes';
        let editingPatientId = null;
        let editingPlanId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Local Storage Management
        const STORAGE_KEY = 'nutricion_app_data';

        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            } catch (error) {
                showToast('Error al guardar datos localmente', 'error');
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    allData = JSON.parse(stored);
                    renderCurrentSection();
                }
            } catch (error) {
                showToast('Error al cargar datos locales', 'error');
                allData = [];
            }
        }

        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function onConfigChange(config) {
            const appTitle = config.app_title || defaultConfig.app_title;
            const clinicName = config.clinic_name || defaultConfig.clinic_name;
            
            document.getElementById('app-title').textContent = appTitle;
            document.getElementById('clinic-name').textContent = clinicName;
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.background_color || defaultConfig.background_color,
                        set: (value) => {
                            config.background_color = value;
                            window.elementSdk.setConfig({ background_color: value });
                        }
                    },
                    {
                        get: () => config.text_color || defaultConfig.text_color,
                        set: (value) => {
                            config.text_color = value;
                            window.elementSdk.setConfig({ text_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["app_title", config.app_title || defaultConfig.app_title],
                ["clinic_name", config.clinic_name || defaultConfig.clinic_name]
            ]);
        }

        async function init() {
            // Load data from localStorage
            loadFromLocalStorage();

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }
        }

        function showSection(section) {
            currentSection = section;
            
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
                el.classList.add('text-gray-700');
            });
            document.getElementById(`nav-${section}`).classList.add('active');
            document.getElementById(`nav-${section}`).classList.remove('text-gray-700');
            
            renderCurrentSection();
        }

        function renderCurrentSection() {
            switch(currentSection) {
                case 'pacientes':
                    renderPatients();
                    break;
                case 'calendario':
                    renderCalendar();
                    renderAppointments();
                    break;
                case 'planes':
                    renderPlans();
                    break;
                case 'reportes':
                    renderReports();
                    break;
                case 'asistente':
                    renderAssistant();
                    break;
                case 'estadisticas':
                    renderStatistics();
                    break;
            }
        }

        function getPatients() {
            return allData.filter(item => item.type === 'patient');
        }

        function getAppointments() {
            return allData.filter(item => item.type === 'appointment');
        }

        function getPlans() {
            return allData.filter(item => item.type === 'plan');
        }

        function createRecord(data) {
            const newRecord = {
                ...data,
                id: generateId(),
                createdAt: new Date().toISOString()
            };
            allData.push(newRecord);
            saveToLocalStorage();
            renderCurrentSection();
            return newRecord;
        }

        function updateRecord(id, data) {
            const index = allData.findIndex(item => item.id === id);
            if (index !== -1) {
                allData[index] = { ...allData[index], ...data };
                saveToLocalStorage();
                renderCurrentSection();
                return allData[index];
            }
            return null;
        }

        function deleteRecord(id) {
            const index = allData.findIndex(item => item.id === id);
            if (index !== -1) {
                allData.splice(index, 1);
                saveToLocalStorage();
                renderCurrentSection();
                return true;
            }
            return false;
        }

        function calculateMetrics(peso, altura, edad, genero, grasaCorporal = null) {
            const alturaM = altura / 100;
            const imc = peso / (alturaM * alturaM);
            
            // Calcular grasa corporal si no se proporciona (usando f√≥rmulas aproximadas)
            let calculatedGrasaCorporal = grasaCorporal;
            if (!grasaCorporal) {
                if (genero === 'Masculino') {
                    // F√≥rmula Deurenberg para hombres
                    calculatedGrasaCorporal = (1.20 * imc) + (0.23 * edad) - 16.2;
                } else {
                    // F√≥rmula Deurenberg para mujeres
                    calculatedGrasaCorporal = (1.20 * imc) + (0.23 * edad) - 5.4;
                }
                calculatedGrasaCorporal = Math.max(5, Math.min(50, calculatedGrasaCorporal)); // L√≠mites realistas
            }
            
            // Peso sin grasa
            const pesoSinGrasa = peso * (1 - calculatedGrasaCorporal / 100);
            
            // TMB (Tasa Metab√≥lica Basal) - F√≥rmula Mifflin-St Jeor
            let tmb = 0;
            if (genero === 'Masculino') {
                tmb = 10 * peso + 6.25 * altura - 5 * edad + 5;
            } else {
                tmb = 10 * peso + 6.25 * altura - 5 * edad - 161;
            }
            
            // Edad metab√≥lica (basada en TMB y composici√≥n corporal)
            const tmbPromedio = genero === 'Masculino' ? 1800 : 1400;
            const factorMetabolico = tmb / tmbPromedio;
            const edadMetabolica = Math.round(edad / factorMetabolico);
            
            // Musculatura esquel√©tica (aproximaci√≥n basada en peso sin grasa)
            const musculaturaEsqueletica = genero === 'Masculino' 
                ? (pesoSinGrasa / peso) * 45 // ~45% del peso sin grasa en hombres
                : (pesoSinGrasa / peso) * 38; // ~38% del peso sin grasa en mujeres
            
            // Grasa subcut√°nea (aproximadamente 80% de la grasa total)
            const grasaSubcutanea = calculatedGrasaCorporal * 0.8;
            
            // Grasa visceral (nivel de 1-20, basado en IMC y edad)
            let grasaVisceral = 1;
            if (imc > 25) grasaVisceral += (imc - 25) * 0.5;
            if (edad > 40) grasaVisceral += (edad - 40) * 0.1;
            grasaVisceral = Math.min(20, Math.max(1, Math.round(grasaVisceral)));
            
            // Agua corporal (var√≠a con edad, g√©nero y composici√≥n)
            let aguaCorporal = 0;
            if (genero === 'Masculino') {
                aguaCorporal = 60 - (calculatedGrasaCorporal * 0.4) - (edad * 0.1);
            } else {
                aguaCorporal = 55 - (calculatedGrasaCorporal * 0.4) - (edad * 0.1);
            }
            aguaCorporal = Math.max(45, Math.min(70, aguaCorporal));
            
            // Masa muscular (aproximaci√≥n basada en peso sin grasa)
            const masaMuscular = pesoSinGrasa * 0.75; // ~75% del peso sin grasa es m√∫sculo
            
            // Masa √≥sea (aproximaci√≥n basada en altura y g√©nero)
            let masaOsea = 0;
            if (genero === 'Masculino') {
                masaOsea = (altura / 100) * (altura / 100) * 1.2; // F√≥rmula aproximada
            } else {
                masaOsea = (altura / 100) * (altura / 100) * 1.0;
            }
            
            // Prote√≠na (aproximaci√≥n basada en masa muscular)
            const proteina = (masaMuscular / peso) * 20; // ~20% de la masa muscular es prote√≠na
            
            return {
                imc: Math.round(imc * 10) / 10,
                grasaCorporal: Math.round(calculatedGrasaCorporal * 10) / 10,
                pesoSinGrasa: Math.round(pesoSinGrasa * 10) / 10,
                tmb: Math.round(tmb),
                edadMetabolica: Math.max(18, Math.min(80, edadMetabolica)),
                musculaturaEsqueletica: Math.round(musculaturaEsqueletica * 10) / 10,
                grasaSubcutanea: Math.round(grasaSubcutanea * 10) / 10,
                grasaVisceral: grasaVisceral,
                aguaCorporal: Math.round(aguaCorporal * 10) / 10,
                masaMuscular: Math.round(masaMuscular * 10) / 10,
                masaOsea: Math.round(masaOsea * 10) / 10,
                proteina: Math.round(proteina * 10) / 10
            };
        }

        function getIMCCategory(imc) {
            if (imc < 18.5) return { text: 'Bajo peso', class: 'metric-warning' };
            if (imc < 25) return { text: 'Normal', class: 'metric-normal' };
            if (imc < 30) return { text: 'Sobrepeso', class: 'metric-warning' };
            return { text: 'Obesidad', class: 'metric-danger' };
        }

        function renderPatients() {
            const patients = getPatients();
            const container = document.getElementById('patients-list');
            
            if (patients.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üë§</div>
                        <p class="text-gray-500 text-lg">No hay pacientes registrados</p>
                        <p class="text-gray-400 text-sm mt-2">Comienza agregando tu primer paciente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = patients.map(patient => {
                const imcCategory = getIMCCategory(patient.imc);
                return `
                    <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow cursor-pointer" onclick="showPatientDetail('${patient.__backendId}')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${patient.nombre}</h3>
                                <p class="text-gray-500 text-sm">${patient.edad} a√±os ‚Ä¢ ${patient.genero}</p>
                            </div>
                            <span class="metric-badge ${imcCategory.class}">IMC: ${patient.imc}</span>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Peso:</span>
                                <span class="font-semibold">${patient.peso} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Altura:</span>
                                <span class="font-semibold">${patient.altura} cm</span>
                            </div>
                            ${patient.grasaCorporal ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600">Grasa Corporal:</span>
                                <span class="font-semibold">${patient.grasaCorporal}%</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200 flex gap-2">
                            <button onclick="event.stopPropagation(); editPatient('${patient.id}')" class="flex-1 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm font-medium">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="event.stopPropagation(); deletePatient('${patient.id}')" class="flex-1 px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm font-medium">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showPatientDetail(patientId) {
            const patient = allData.find(p => p.id === patientId);
            if (!patient) return;
            
            const imcCategory = getIMCCategory(patient.imc);
            
            document.getElementById('detail-patient-name').textContent = patient.nombre;
            document.getElementById('patient-detail-content').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Informaci√≥n Personal</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Edad:</span>
                                <span class="font-semibold">${patient.edad} a√±os</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">G√©nero:</span>
                                <span class="font-semibold">${patient.genero}</span>
                            </div>
                            ${patient.telefono ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Tel√©fono:</span>
                                <span class="font-semibold">${patient.telefono}</span>
                            </div>
                            ` : ''}
                            ${patient.email ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Email:</span>
                                <span class="font-semibold">${patient.email}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Medidas B√°sicas</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Peso:</span>
                                <span class="font-semibold">${patient.peso} kg</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Altura:</span>
                                <span class="font-semibold">${patient.altura} cm</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">IMC:</span>
                                <span class="font-semibold">${patient.imc} <span class="metric-badge ${imcCategory.class} ml-2">${imcCategory.text}</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Composici√≥n Corporal</h4>
                        <div class="space-y-2 text-sm">
                            ${patient.grasaCorporal ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Grasa Corporal:</span>
                                <span class="font-semibold">${patient.grasaCorporal}%</span>
                            </div>
                            ` : ''}
                            ${patient.musculaturaEsqueletica ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Musculatura Esquel√©tica:</span>
                                <span class="font-semibold">${patient.musculaturaEsqueletica}%</span>
                            </div>
                            ` : ''}
                            ${patient.pesoSinGrasa ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Peso sin Grasa:</span>
                                <span class="font-semibold">${patient.pesoSinGrasa} kg</span>
                            </div>
                            ` : ''}
                            ${patient.grasaSubcutanea ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Grasa Subcut√°nea:</span>
                                <span class="font-semibold">${patient.grasaSubcutanea}%</span>
                            </div>
                            ` : ''}
                            ${patient.grasaVisceral ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Grasa Visceral:</span>
                                <span class="font-semibold">Nivel ${patient.grasaVisceral}</span>
                            </div>
                            ` : ''}
                            ${patient.aguaCorporal ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Agua Corporal:</span>
                                <span class="font-semibold">${patient.aguaCorporal}%</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Otros Par√°metros</h4>
                        <div class="space-y-2 text-sm">
                            ${patient.masaMuscular ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Masa Muscular:</span>
                                <span class="font-semibold">${patient.masaMuscular} kg</span>
                            </div>
                            ` : ''}
                            ${patient.masaOsea ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Masa √ìsea:</span>
                                <span class="font-semibold">${patient.masaOsea} kg</span>
                            </div>
                            ` : ''}
                            ${patient.proteina ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Prote√≠na:</span>
                                <span class="font-semibold">${patient.proteina}%</span>
                            </div>
                            ` : ''}
                            ${patient.tmb ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">TMB:</span>
                                <span class="font-semibold">${patient.tmb} kcal/d√≠a</span>
                            </div>
                            ` : ''}
                            ${patient.edadMetabolica ? `
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Edad Metab√≥lica:</span>
                                <span class="font-semibold">${patient.edadMetabolica} a√±os</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('patient-detail-container').classList.remove('hidden');
        }

        function closePatientDetail() {
            document.getElementById('patient-detail-container').classList.add('hidden');
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('form-title').textContent = 'Nuevo Paciente';
            document.getElementById('patient-form').reset();
            document.getElementById('metrics-preview').classList.add('hidden');
            document.getElementById('advanced-preview').classList.add('hidden');
            document.getElementById('advanced-toggle-text').textContent = 'Ver m√°s detalles ‚ñº';
            document.getElementById('patient-form-container').classList.remove('hidden');
            
            // Configurar listeners despu√©s de mostrar el formulario
            setTimeout(() => {
                setupRealtimeCalculation();
            }, 100);
        }

        function editPatient(patientId) {
            const patient = allData.find(p => p.id === patientId);
            if (!patient) return;
            
            editingPatientId = patientId;
            document.getElementById('form-title').textContent = 'Editar Paciente';
            
            document.getElementById('input-nombre').value = patient.nombre;
            document.getElementById('input-edad').value = patient.edad;
            document.getElementById('input-genero').value = patient.genero;
            document.getElementById('input-altura').value = patient.altura;
            document.getElementById('input-peso').value = patient.peso;
            document.getElementById('input-grasa').value = patient.grasaCorporal || '';
            document.getElementById('input-musculatura').value = patient.musculaturaEsqueletica || '';
            document.getElementById('input-grasa-subcutanea').value = patient.grasaSubcutanea || '';
            document.getElementById('input-grasa-visceral').value = patient.grasaVisceral || '';
            document.getElementById('input-agua').value = patient.aguaCorporal || '';
            document.getElementById('input-masa-muscular').value = patient.masaMuscular || '';
            document.getElementById('input-masa-osea').value = patient.masaOsea || '';
            document.getElementById('input-proteina').value = patient.proteina || '';
            document.getElementById('input-telefono').value = patient.telefono || '';
            document.getElementById('input-email').value = patient.email || '';
            
            document.getElementById('patient-form-container').classList.remove('hidden');
        }

        function closePatientForm() {
            document.getElementById('patient-form-container').classList.add('hidden');
            editingPatientId = null;
        }

        function deletePatient(patientId) {
            const deleteBtn = event.target;
            const originalText = deleteBtn.innerHTML;
            
            if (deleteBtn.dataset.confirming === 'true') {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '‚è≥ Eliminando...';
                
                const success = deleteRecord(patientId);
                
                if (success) {
                    showToast('Paciente eliminado correctamente', 'success');
                } else {
                    showToast('Error al eliminar el paciente', 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalText;
                }
                
                delete deleteBtn.dataset.confirming;
            } else {
                deleteBtn.dataset.confirming = 'true';
                deleteBtn.innerHTML = '‚úì Confirmar';
                deleteBtn.classList.remove('bg-red-50', 'text-red-600', 'hover:bg-red-100');
                deleteBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                
                setTimeout(() => {
                    if (deleteBtn.dataset.confirming === 'true') {
                        delete deleteBtn.dataset.confirming;
                        deleteBtn.innerHTML = originalText;
                        deleteBtn.classList.add('bg-red-50', 'text-red-600', 'hover:bg-red-100');
                        deleteBtn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-700');
                    }
                }, 3000);
            }
        }

        document.getElementById('patient-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('save-btn-text');
            const spinner = document.getElementById('save-spinner');
            
            submitBtn.disabled = true;
            btnText.textContent = editingPlanId ? 'Actualizando...' : 'Guardando...';
            spinner.classList.remove('hidden');
            
            setTimeout(() => {
                const peso = parseFloat(document.getElementById('input-peso').value);
                const altura = parseFloat(document.getElementById('input-altura').value);
                const edad = parseInt(document.getElementById('input-edad').value);
                const genero = document.getElementById('input-genero').value;
                
                // Usar valor manual si se proporciona, sino calcular autom√°ticamente
                const grasaCorporalManual = parseFloat(document.getElementById('input-grasa').value) || null;
                
                const metrics = calculateMetrics(peso, altura, edad, genero, grasaCorporalManual);
                
                const patientData = {
                    type: 'patient',
                    nombre: document.getElementById('input-nombre').value,
                    edad: edad,
                    genero: genero,
                    altura: altura,
                    peso: peso,
                    imc: metrics.imc,
                    grasaCorporal: metrics.grasaCorporal,
                    musculaturaEsqueletica: parseFloat(document.getElementById('input-musculatura').value) || metrics.musculaturaEsqueletica,
                    pesoSinGrasa: metrics.pesoSinGrasa,
                    grasaSubcutanea: parseFloat(document.getElementById('input-grasa-subcutanea').value) || metrics.grasaSubcutanea,
                    grasaVisceral: parseFloat(document.getElementById('input-grasa-visceral').value) || metrics.grasaVisceral,
                    aguaCorporal: parseFloat(document.getElementById('input-agua').value) || metrics.aguaCorporal,
                    masaMuscular: parseFloat(document.getElementById('input-masa-muscular').value) || metrics.masaMuscular,
                    masaOsea: parseFloat(document.getElementById('input-masa-osea').value) || metrics.masaOsea,
                    proteina: parseFloat(document.getElementById('input-proteina').value) || metrics.proteina,
                    tmb: metrics.tmb,
                    edadMetabolica: metrics.edadMetabolica,
                    telefono: document.getElementById('input-telefono').value,
                    email: document.getElementById('input-email').value
                };
                
                try {
                    if (editingPatientId) {
                        updateRecord(editingPatientId, patientData);
                        showToast('Paciente actualizado correctamente', 'success');
                    } else {
                        createRecord(patientData);
                        showToast('Paciente registrado correctamente', 'success');
                    }
                    closePatientForm();
                } catch (error) {
                    showToast('Error al guardar el paciente', 'error');
                }
                
                submitBtn.disabled = false;
                btnText.textContent = 'Guardar Paciente';
                spinner.classList.add('hidden');
            }, 500);
        });

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const appointments = getAppointments();
            const appointmentsByDate = {};
            appointments.forEach(appointment => {
                if (!appointmentsByDate[appointment.fecha]) {
                    appointmentsByDate[appointment.fecha] = [];
                }
                appointmentsByDate[appointment.fecha].push(appointment);
            });
            
            let calendarHTML = '';
            
            // D√≠as del mes anterior (grises)
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                calendarHTML += `
                    <div class="calendar-day other-month cursor-default">
                        <span class="calendar-day-number">${day}</span>
                    </div>
                `;
            }
            
            // D√≠as del mes actual
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = appointmentsByDate[dateStr] || [];
                const hasAppointments = dayAppointments.length > 0;
                const isToday = new Date().toDateString() === new Date(currentYear, currentMonth, day).toDateString();
                
                let dayClasses = 'calendar-day cursor-pointer';
                if (hasAppointments) dayClasses += ' has-appointment';
                if (isToday) dayClasses += ' today';
                
                let appointmentIndicators = '';
                if (hasAppointments) {
                    if (dayAppointments.length <= 3) {
                        // Mostrar puntos individuales para pocas citas
                        appointmentIndicators = dayAppointments.map(() => 
                            '<div class="calendar-appointment-dot"></div>'
                        ).join('');
                    } else {
                        // Mostrar contador para muchas citas
                        appointmentIndicators = `<div class="calendar-appointment-count">${dayAppointments.length}</div>`;
                    }
                }
                
                calendarHTML += `
                    <div class="${dayClasses}" onclick="selectDate('${dateStr}')" title="${hasAppointments ? `${dayAppointments.length} cita(s) programada(s)` : 'Haz clic para agendar una cita'}">
                        <span class="calendar-day-number">${day}</span>
                        <div class="flex flex-wrap justify-center items-center gap-1 mt-1">
                            ${appointmentIndicators}
                        </div>
                    </div>
                `;
            }
            
            // D√≠as del siguiente mes (grises) para completar la grilla
            const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (firstDay + daysInMonth);
            
            for (let day = 1; day <= remainingCells; day++) {
                calendarHTML += `
                    <div class="calendar-day other-month cursor-default">
                        <span class="calendar-day-number">${day}</span>
                    </div>
                `;
            }
            
            document.getElementById('calendar-days').innerHTML = calendarHTML;
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        function selectDate(dateStr) {
            document.getElementById('input-fecha').value = dateStr;
            showAddAppointmentForm();
        }

        function renderAppointments() {
            const appointments = getAppointments().sort((a, b) => {
                const dateA = new Date(a.fecha + 'T' + a.hora);
                const dateB = new Date(b.fecha + 'T' + b.hora);
                return dateA - dateB;
            });
            
            const container = document.getElementById('appointments-list');
            const now = new Date();
            const upcomingAppointments = appointments.filter(a => {
                const appointmentDate = new Date(a.fecha + 'T' + a.hora);
                return appointmentDate >= now;
            });
            
            // Actualizar contador
            document.getElementById('upcoming-count').textContent = upcomingAppointments.length;
            
            if (upcomingAppointments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl text-gray-400">üìÖ</span>
                        </div>
                        <p class="text-gray-500 text-lg font-medium">No hay citas programadas</p>
                        <p class="text-gray-400 text-sm mt-2">Las pr√≥ximas citas aparecer√°n aqu√≠</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = upcomingAppointments.slice(0, 8).map((appointment, index) => {
                const patient = allData.find(p => p.id === appointment.pacienteId);
                const patientName = patient ? patient.nombre : 'Paciente no encontrado';
                const appointmentDate = new Date(appointment.fecha + 'T' + appointment.hora);
                const isToday = appointmentDate.toDateString() === now.toDateString();
                const isTomorrow = appointmentDate.toDateString() === new Date(now.getTime() + 24 * 60 * 60 * 1000).toDateString();
                
                let dateLabel = appointment.fecha;
                if (isToday) dateLabel = 'Hoy';
                else if (isTomorrow) dateLabel = 'Ma√±ana';
                
                const timeUntil = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));
                let urgencyClass = '';
                let urgencyIcon = 'üìÖ';
                
                if (isToday) {
                    urgencyClass = 'border-l-4 border-l-red-500 bg-red-50';
                    urgencyIcon = 'üî•';
                } else if (isTomorrow) {
                    urgencyClass = 'border-l-4 border-l-orange-500 bg-orange-50';
                    urgencyIcon = '‚ö°';
                } else if (timeUntil <= 7) {
                    urgencyClass = 'border-l-4 border-l-yellow-500 bg-yellow-50';
                    urgencyIcon = '‚è∞';
                } else {
                    urgencyClass = 'border-l-4 border-l-blue-500 bg-blue-50';
                }
                
                return `
                    <div class="group relative bg-white border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300 ${urgencyClass}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start gap-3 flex-1">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <span class="text-white text-sm font-bold">${index + 1}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-semibold text-gray-800 truncate">${patientName}</h4>
                                        <span class="text-lg">${urgencyIcon}</span>
                                    </div>
                                    <div class="flex items-center gap-4 text-sm text-gray-600 mb-2">
                                        <div class="flex items-center gap-1">
                                            <span>üìÖ</span>
                                            <span class="font-medium">${dateLabel}</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span>‚è∞</span>
                                            <span class="font-medium">${appointment.hora}</span>
                                        </div>
                                    </div>
                                    ${appointment.motivo ? `
                                        <p class="text-sm text-gray-500 bg-gray-50 rounded-lg px-3 py-2 mt-2">
                                            üí¨ ${appointment.motivo}
                                        </p>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                ${timeUntil <= 1 ? `
                                    <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full">
                                        ${isToday ? 'HOY' : 'MA√ëANA'}
                                    </span>
                                ` : timeUntil <= 7 ? `
                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full">
                                        ${timeUntil} d√≠as
                                    </span>
                                ` : ''}
                                <button onclick="deleteAppointment('${appointment.id}')" 
                                        class="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Mostrar enlace para ver todas las citas si hay m√°s de 8
            if (upcomingAppointments.length > 8) {
                container.innerHTML += `
                    <div class="text-center pt-4 border-t border-gray-200">
                        <p class="text-sm text-gray-500">
                            Y ${upcomingAppointments.length - 8} citas m√°s programadas
                        </p>
                    </div>
                `;
            }
        }

        function showAddAppointmentForm() {
            const patients = getPatients();
            const select = document.getElementById('input-paciente-cita');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + 
                patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            
            document.getElementById('appointment-form').reset();
            document.getElementById('appointment-form-container').classList.remove('hidden');
        }

        function closeAppointmentForm() {
            document.getElementById('appointment-form-container').classList.add('hidden');
        }

        function deleteAppointment(appointmentId) {
            const deleteBtn = event.target;
            const originalText = deleteBtn.innerHTML;
            
            if (deleteBtn.dataset.confirming === 'true') {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '‚è≥';
                
                const success = deleteRecord(appointmentId);
                
                if (success) {
                    showToast('Cita eliminada correctamente', 'success');
                } else {
                    showToast('Error al eliminar la cita', 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalText;
                }
                
                delete deleteBtn.dataset.confirming;
            } else {
                deleteBtn.dataset.confirming = 'true';
                deleteBtn.innerHTML = '‚úì';
                
                setTimeout(() => {
                    if (deleteBtn.dataset.confirming === 'true') {
                        delete deleteBtn.dataset.confirming;
                        deleteBtn.innerHTML = originalText;
                    }
                }, 3000);
            }
        }

        document.getElementById('appointment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('save-appointment-btn-text');
            const spinner = document.getElementById('save-appointment-spinner');
            
            submitBtn.disabled = true;
            btnText.textContent = editingPlanId ? 'Actualizando...' : 'Guardando...';
            spinner.classList.remove('hidden');
            
            setTimeout(() => {
                const appointmentData = {
                    type: 'appointment',
                    pacienteId: document.getElementById('input-paciente-cita').value,
                    fecha: document.getElementById('input-fecha').value,
                    hora: document.getElementById('input-hora').value,
                    motivo: document.getElementById('input-motivo').value,
                    estado: 'pendiente'
                };
                
                try {
                    createRecord(appointmentData);
                    showToast('Cita registrada correctamente', 'success');
                    closeAppointmentForm();
                } catch (error) {
                    showToast('Error al guardar la cita', 'error');
                }
                
                submitBtn.disabled = false;
                btnText.textContent = 'Guardar Cita';
                spinner.classList.add('hidden');
            }, 500);
        });

        function renderPlans() {
            const plans = getPlans();
            const container = document.getElementById('plans-list');
            
            if (plans.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üçé</div>
                        <p class="text-gray-500 text-lg">No hay planes nutricionales</p>
                        <p class="text-gray-400 text-sm mt-2">Crea el primer plan para tus pacientes</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = plans.map(plan => {
                const patient = allData.find(p => p.id === plan.pacienteId);
                const patientName = patient ? patient.nombre : 'Paciente no encontrado';
                
                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <!-- Header del Plan -->
                        <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold">${patientName}</h3>
                                    <p class="text-green-100 mt-1">üéØ ${plan.objetivo}</p>
                                    <p class="text-xs text-green-200 mt-2">Plan creado: ${new Date(plan.createdAt).toLocaleDateString()}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editPlan('${plan.id}')" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="deletePlan('${plan.id}')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="p-6">
                            <!-- Plan Nutricional Diario -->
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    üçΩÔ∏è Plan Nutricional Diario
                                </h4>
                                
                                <div class="grid grid-cols-1 gap-4">
                                    ${plan.desayuno ? `
                                    <div class="bg-orange-50 border-l-4 border-orange-400 p-4 rounded-r-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">üåÖ</span>
                                            <h5 class="font-semibold text-gray-700">Desayuno</h5>
                                            <span class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded-full">7:00 - 9:00 AM</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${plan.desayuno}</p>
                                    </div>
                                    ` : ''}

                                    ${plan.colacionMatutina ? `
                                    <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">ü•§</span>
                                            <h5 class="font-semibold text-gray-700">Colaci√≥n Matutina</h5>
                                            <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full">10:00 - 11:00 AM</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${plan.colacionMatutina}</p>
                                    </div>
                                    ` : ''}

                                    ${plan.almuerzo ? `
                                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">üçΩÔ∏è</span>
                                            <h5 class="font-semibold text-gray-700">Almuerzo</h5>
                                            <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full">12:00 - 2:00 PM</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${plan.almuerzo}</p>
                                    </div>
                                    ` : ''}

                                    ${plan.colacionVespertina ? `
                                    <div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded-r-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">ü•®</span>
                                            <h5 class="font-semibold text-gray-700">Colaci√≥n Vespertina</h5>
                                            <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full">4:00 - 5:00 PM</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${plan.colacionVespertina}</p>
                                    </div>
                                    ` : ''}

                                    ${plan.cena ? `
                                    <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-r-lg">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">üåô</span>
                                            <h5 class="font-semibold text-gray-700">Cena</h5>
                                            <span class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded-full">7:00 - 9:00 PM</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${plan.cena}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Informaci√≥n Adicional -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                ${plan.hidratacion ? `
                                <div class="bg-cyan-50 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        üíß Hidrataci√≥n
                                    </h5>
                                    <p class="text-sm text-gray-600">${plan.hidratacion}</p>
                                </div>
                                ` : ''}

                                ${plan.ejercicio ? `
                                <div class="bg-yellow-50 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                        üèÉ‚Äç‚ôÄÔ∏è Actividad F√≠sica
                                    </h5>
                                    <p class="text-sm text-gray-600">${plan.ejercicio}</p>
                                </div>
                                ` : ''}
                            </div>

                            ${plan.notas ? `
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                    üìù Notas y Restricciones
                                </h5>
                                <p class="text-sm text-gray-600">${plan.notas}</p>
                            </div>
                            ` : ''}

                            ${plan.recomendaciones ? `
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                <h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                    ‚ö†Ô∏è Recomendaciones Especiales
                                </h5>
                                <p class="text-sm text-gray-600">${plan.recomendaciones}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddPlanForm() {
            editingPlanId = null;
            document.getElementById('plan-form-title').textContent = 'Nuevo Plan Nutricional';
            
            const patients = getPatients();
            const select = document.getElementById('input-paciente-plan');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + 
                patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            
            document.getElementById('plan-form').reset();
            document.getElementById('plan-form-container').classList.remove('hidden');
        }

        function editPlan(planId) {
            const plan = allData.find(p => p.id === planId);
            if (!plan) return;
            
            editingPlanId = planId;
            document.getElementById('plan-form-title').textContent = 'Editar Plan Nutricional';
            
            // Llenar el formulario con los datos del plan
            const patients = getPatients();
            const select = document.getElementById('input-paciente-plan');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + 
                patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            
            document.getElementById('input-paciente-plan').value = plan.pacienteId;
            document.getElementById('input-objetivo').value = plan.objetivo || '';
            document.getElementById('input-desayuno').value = plan.desayuno || '';
            document.getElementById('input-colacion-matutina').value = plan.colacionMatutina || '';
            document.getElementById('input-almuerzo').value = plan.almuerzo || '';
            document.getElementById('input-colacion-vespertina').value = plan.colacionVespertina || '';
            document.getElementById('input-cena').value = plan.cena || '';
            document.getElementById('input-hidratacion').value = plan.hidratacion || '';
            document.getElementById('input-ejercicio').value = plan.ejercicio || '';
            document.getElementById('input-notas').value = plan.notas || '';
            document.getElementById('input-recomendaciones').value = plan.recomendaciones || '';
            
            document.getElementById('plan-form-container').classList.remove('hidden');
        }

        function closePlanForm() {
            document.getElementById('plan-form-container').classList.add('hidden');
            editingPlanId = null;
        }

        function deletePlan(planId) {
            const deleteBtn = event.target;
            const originalText = deleteBtn.innerHTML;
            
            if (deleteBtn.dataset.confirming === 'true') {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '‚è≥';
                
                const success = deleteRecord(planId);
                
                if (success) {
                    showToast('Plan eliminado correctamente', 'success');
                } else {
                    showToast('Error al eliminar el plan', 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalText;
                }
                
                delete deleteBtn.dataset.confirming;
            } else {
                deleteBtn.dataset.confirming = 'true';
                deleteBtn.innerHTML = '‚úì';
                
                setTimeout(() => {
                    if (deleteBtn.dataset.confirming === 'true') {
                        delete deleteBtn.dataset.confirming;
                        deleteBtn.innerHTML = originalText;
                    }
                }, 3000);
            }
        }

        document.getElementById('plan-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('save-plan-btn-text');
            const spinner = document.getElementById('save-plan-spinner');
            
            submitBtn.disabled = true;
            btnText.textContent = editingPlanId ? 'Actualizando...' : 'Guardando...';
            spinner.classList.remove('hidden');
            
            setTimeout(() => {
                const planData = {
                    type: 'plan',
                    pacienteId: document.getElementById('input-paciente-plan').value,
                    objetivo: document.getElementById('input-objetivo').value,
                    desayuno: document.getElementById('input-desayuno').value,
                    colacionMatutina: document.getElementById('input-colacion-matutina').value,
                    almuerzo: document.getElementById('input-almuerzo').value,
                    colacionVespertina: document.getElementById('input-colacion-vespertina').value,
                    cena: document.getElementById('input-cena').value,
                    hidratacion: document.getElementById('input-hidratacion').value,
                    ejercicio: document.getElementById('input-ejercicio').value,
                    notas: document.getElementById('input-notas').value,
                    recomendaciones: document.getElementById('input-recomendaciones').value,
                    createdAt: new Date().toISOString()
                };
                
                try {
                    if (editingPlanId) {
                        updateRecord(editingPlanId, planData);
                        showToast('Plan nutricional actualizado correctamente', 'success');
                    } else {
                        createRecord(planData);
                        showToast('Plan nutricional guardado correctamente', 'success');
                    }
                    closePlanForm();
                } catch (error) {
                    showToast('Error al guardar el plan', 'error');
                }
                
                submitBtn.disabled = false;
                btnText.textContent = 'Guardar Plan';
                spinner.classList.add('hidden');
            }, 500);
        });

        function renderStatistics() {
            const patients = getPatients();
            const appointments = getAppointments();
            const plans = getPlans();
            
            document.getElementById('stat-total-patients').textContent = patients.length;
            
            const now = new Date();
            const pendingAppointments = appointments.filter(a => {
                const appointmentDate = new Date(a.fecha + 'T' + a.hora);
                return appointmentDate >= now;
            });
            document.getElementById('stat-pending-appointments').textContent = pendingAppointments.length;
            
            document.getElementById('stat-active-plans').textContent = plans.length;
            
            const avgIMC = patients.length > 0 
                ? (patients.reduce((sum, p) => sum + p.imc, 0) / patients.length).toFixed(1)
                : 0;
            document.getElementById('stat-avg-imc').textContent = avgIMC;
            
            const genderCounts = { Masculino: 0, Femenino: 0 };
            patients.forEach(p => {
                if (genderCounts[p.genero] !== undefined) {
                    genderCounts[p.genero]++;
                }
            });
            
            const totalPatients = patients.length || 1;
            document.getElementById('gender-stats').innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Masculino</span>
                    <div class="flex items-center gap-3">
                        <div class="w-48 bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-500 h-4 rounded-full" style="width: ${(genderCounts.Masculino / totalPatients * 100)}%"></div>
                        </div>
                        <span class="font-semibold text-gray-800 w-12 text-right">${genderCounts.Masculino}</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Femenino</span>
                    <div class="flex items-center gap-3">
                        <div class="w-48 bg-gray-200 rounded-full h-4">
                            <div class="bg-pink-500 h-4 rounded-full" style="width: ${(genderCounts.Femenino / totalPatients * 100)}%"></div>
                        </div>
                        <span class="font-semibold text-gray-800 w-12 text-right">${genderCounts.Femenino}</span>
                    </div>
                </div>
            `;
            
            const imcRanges = {
                'Bajo peso': 0,
                'Normal': 0,
                'Sobrepeso': 0,
                'Obesidad': 0
            };
            
            patients.forEach(p => {
                const category = getIMCCategory(p.imc).text;
                if (imcRanges[category] !== undefined) {
                    imcRanges[category]++;
                }
            });
            
            const colors = {
                'Bajo peso': 'bg-yellow-500',
                'Normal': 'bg-green-500',
                'Sobrepeso': 'bg-orange-500',
                'Obesidad': 'bg-red-500'
            };
            
            document.getElementById('imc-stats').innerHTML = Object.entries(imcRanges).map(([range, count]) => `
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">${range}</span>
                    <div class="flex items-center gap-3">
                        <div class="w-48 bg-gray-200 rounded-full h-4">
                            <div class="${colors[range]} h-4 rounded-full" style="width: ${(count / totalPatients * 100)}%"></div>
                        </div>
                        <span class="font-semibold text-gray-800 w-12 text-right">${count}</span>
                    </div>
                </div>
            `).join('');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-2xl">${type === 'success' ? '‚úì' : '‚ö†Ô∏è'}</div>
                    <p class="text-gray-800 font-medium">${message}</p>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Funciones para vista previa de c√°lculos
        function updateMetricsPreview() {
            const peso = parseFloat(document.getElementById('input-peso').value);
            const altura = parseFloat(document.getElementById('input-altura').value);
            const edad = parseInt(document.getElementById('input-edad').value);
            const genero = document.getElementById('input-genero').value;
            
            if (peso && altura && edad && genero) {
                const grasaCorporalManual = parseFloat(document.getElementById('input-grasa').value) || null;
                const metrics = calculateMetrics(peso, altura, edad, genero, grasaCorporalManual);
                
                document.getElementById('preview-imc').textContent = metrics.imc;
                document.getElementById('preview-tmb').textContent = metrics.tmb + ' kcal';
                document.getElementById('preview-grasa').textContent = metrics.grasaCorporal + '%';
                document.getElementById('preview-edad-metabolica').textContent = metrics.edadMetabolica + ' a√±os';
                
                document.getElementById('preview-peso-sin-grasa').textContent = metrics.pesoSinGrasa + ' kg';
                document.getElementById('preview-masa-muscular').textContent = metrics.masaMuscular + ' kg';
                document.getElementById('preview-agua').textContent = metrics.aguaCorporal + '%';
                document.getElementById('preview-grasa-visceral').textContent = 'Nivel ' + metrics.grasaVisceral;
                document.getElementById('preview-masa-osea').textContent = metrics.masaOsea + ' kg';
                document.getElementById('preview-proteina').textContent = metrics.proteina + '%';
                
                document.getElementById('metrics-preview').classList.remove('hidden');
            } else {
                document.getElementById('metrics-preview').classList.add('hidden');
            }
        }

        function toggleAdvancedPreview() {
            const advanced = document.getElementById('advanced-preview');
            const toggleText = document.getElementById('advanced-toggle-text');
            
            if (advanced.classList.contains('hidden')) {
                advanced.classList.remove('hidden');
                toggleText.textContent = 'Ver menos detalles ‚ñ≤';
            } else {
                advanced.classList.add('hidden');
                toggleText.textContent = 'Ver m√°s detalles ‚ñº';
            }
        }

        // Agregar event listeners para c√°lculo en tiempo real
        function setupRealtimeCalculation() {
            const inputs = ['input-peso', 'input-altura', 'input-edad', 'input-genero', 'input-grasa'];
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', updateMetricsPreview);
                    element.addEventListener('change', updateMetricsPreview);
                }
            });
        }

        // Funci√≥n para llenar autom√°ticamente campos calculados
        function autoFillCalculatedFields() {
            const peso = parseFloat(document.getElementById('input-peso').value);
            const altura = parseFloat(document.getElementById('input-altura').value);
            const edad = parseInt(document.getElementById('input-edad').value);
            const genero = document.getElementById('input-genero').value;
            
            if (peso && altura && edad && genero) {
                const grasaCorporalManual = parseFloat(document.getElementById('input-grasa').value) || null;
                const metrics = calculateMetrics(peso, altura, edad, genero, grasaCorporalManual);
                
                // Solo llenar campos vac√≠os con valores calculados
                if (!document.getElementById('input-grasa').value) {
                    document.getElementById('input-grasa').value = metrics.grasaCorporal;
                }
                if (!document.getElementById('input-musculatura').value) {
                    document.getElementById('input-musculatura').value = metrics.musculaturaEsqueletica;
                }
                if (!document.getElementById('input-grasa-subcutanea').value) {
                    document.getElementById('input-grasa-subcutanea').value = metrics.grasaSubcutanea;
                }
                if (!document.getElementById('input-grasa-visceral').value) {
                    document.getElementById('input-grasa-visceral').value = metrics.grasaVisceral;
                }
                if (!document.getElementById('input-agua').value) {
                    document.getElementById('input-agua').value = metrics.aguaCorporal;
                }
                if (!document.getElementById('input-masa-muscular').value) {
                    document.getElementById('input-masa-muscular').value = metrics.masaMuscular;
                }
                if (!document.getElementById('input-masa-osea').value) {
                    document.getElementById('input-masa-osea').value = metrics.masaOsea;
                }
                if (!document.getElementById('input-proteina').value) {
                    document.getElementById('input-proteina').value = metrics.proteina;
                }
                
                showToast('Campos calculados autom√°ticamente', 'success');
            }
        }

        // Variables para reportes
        let currentReportData = '';
        let selectedPatientForReport = null;

        // Variables para asistente IA
        let chatCount = 0;
        let analysisCount = 0;
        let chatHistory = [];

        // Funciones para reportes
        function renderReports() {
            const patients = getPatients();
            const select = document.getElementById('report-patient-select');
            
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + 
                patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
        }

        function loadPatientData() {
            const patientId = document.getElementById('report-patient-select').value;
            const generateBtn = document.getElementById('generate-btn');
            const downloadBtn = document.getElementById('download-btn');
            const copyBtn = document.getElementById('copy-btn');
            const patientSummary = document.getElementById('patient-summary');
            
            if (!patientId) {
                generateBtn.disabled = true;
                downloadBtn.classList.add('hidden');
                copyBtn.classList.add('hidden');
                patientSummary.classList.add('hidden');
                document.getElementById('report-preview').innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <div class="text-4xl mb-4">üìÑ</div>
                        <p class="text-lg font-medium">Selecciona un paciente para generar el reporte</p>
                        <p class="text-sm mt-2">El reporte incluir√° toda la informaci√≥n relevante del tratamiento</p>
                    </div>
                `;
                return;
            }
            
            selectedPatientForReport = allData.find(p => p.id === patientId);
            if (!selectedPatientForReport) return;
            
            // Obtener datos relacionados
            const patientPlans = getPlans().filter(p => p.pacienteId === patientId);
            const patientAppointments = getAppointments().filter(a => a.pacienteId === patientId);
            
            // Mostrar resumen
            document.getElementById('summary-edad').textContent = `${selectedPatientForReport.edad} a√±os`;
            document.getElementById('summary-imc').textContent = selectedPatientForReport.imc;
            document.getElementById('summary-planes').textContent = `${patientPlans.length} plan(es)`;
            document.getElementById('summary-citas').textContent = `${patientAppointments.length} cita(s)`;
            
            patientSummary.classList.remove('hidden');
            generateBtn.disabled = false;
        }

        function generateReport() {
            if (!selectedPatientForReport) return;
            
            const includePersonal = document.getElementById('include-personal').checked;
            const includeMetrics = document.getElementById('include-metrics').checked;
            const includePlans = document.getElementById('include-plans').checked;
            const includeAppointments = document.getElementById('include-appointments').checked;
            const includeRecommendations = document.getElementById('include-recommendations').checked;
            
            const clinicName = document.getElementById('clinic-name').textContent;
            const currentDate = new Date().toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            let report = '';
            
            // Encabezado del reporte
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '                    REPORTE NUTRICIONAL COMPLETO\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            report += `Cl√≠nica: ${clinicName}\n`;
            report += `Fecha del Reporte: ${currentDate}\n`;
            report += `Paciente: ${selectedPatientForReport.nombre}\n\n`;
            
            // Informaci√≥n Personal
            if (includePersonal) {
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                   INFORMACI√ìN PERSONAL                      ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                report += `Nombre Completo: ${selectedPatientForReport.nombre}\n`;
                report += `Edad: ${selectedPatientForReport.edad} a√±os\n`;
                report += `G√©nero: ${selectedPatientForReport.genero}\n`;
                if (selectedPatientForReport.telefono) {
                    report += `Tel√©fono: ${selectedPatientForReport.telefono}\n`;
                }
                if (selectedPatientForReport.email) {
                    report += `Email: ${selectedPatientForReport.email}\n`;
                }
                report += `Fecha de Registro: ${new Date(selectedPatientForReport.createdAt).toLocaleDateString('es-ES')}\n\n`;
            }
            
            // M√©tricas Corporales
            if (includeMetrics) {
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                   M√âTRICAS CORPORALES                      ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                
                report += 'MEDIDAS B√ÅSICAS:\n';
                report += `‚Ä¢ Peso: ${selectedPatientForReport.peso} kg\n`;
                report += `‚Ä¢ Altura: ${selectedPatientForReport.altura} cm\n`;
                report += `‚Ä¢ IMC: ${selectedPatientForReport.imc} (${getIMCCategory(selectedPatientForReport.imc).text})\n\n`;
                
                if (selectedPatientForReport.grasaCorporal) {
                    report += 'COMPOSICI√ìN CORPORAL:\n';
                    report += `‚Ä¢ Grasa Corporal: ${selectedPatientForReport.grasaCorporal}%\n`;
                    if (selectedPatientForReport.musculaturaEsqueletica) {
                        report += `‚Ä¢ Musculatura Esquel√©tica: ${selectedPatientForReport.musculaturaEsqueletica}%\n`;
                    }
                    if (selectedPatientForReport.pesoSinGrasa) {
                        report += `‚Ä¢ Peso sin Grasa: ${selectedPatientForReport.pesoSinGrasa} kg\n`;
                    }
                    if (selectedPatientForReport.grasaSubcutanea) {
                        report += `‚Ä¢ Grasa Subcut√°nea: ${selectedPatientForReport.grasaSubcutanea}%\n`;
                    }
                    if (selectedPatientForReport.grasaVisceral) {
                        report += `‚Ä¢ Grasa Visceral: Nivel ${selectedPatientForReport.grasaVisceral}\n`;
                    }
                    if (selectedPatientForReport.aguaCorporal) {
                        report += `‚Ä¢ Agua Corporal: ${selectedPatientForReport.aguaCorporal}%\n`;
                    }
                    report += '\n';
                }
                
                if (selectedPatientForReport.masaMuscular || selectedPatientForReport.tmb) {
                    report += 'PAR√ÅMETROS ADICIONALES:\n';
                    if (selectedPatientForReport.masaMuscular) {
                        report += `‚Ä¢ Masa Muscular: ${selectedPatientForReport.masaMuscular} kg\n`;
                    }
                    if (selectedPatientForReport.masaOsea) {
                        report += `‚Ä¢ Masa √ìsea: ${selectedPatientForReport.masaOsea} kg\n`;
                    }
                    if (selectedPatientForReport.proteina) {
                        report += `‚Ä¢ Prote√≠na: ${selectedPatientForReport.proteina}%\n`;
                    }
                    if (selectedPatientForReport.tmb) {
                        report += `‚Ä¢ TMB (Tasa Metab√≥lica Basal): ${selectedPatientForReport.tmb} kcal/d√≠a\n`;
                    }
                    if (selectedPatientForReport.edadMetabolica) {
                        report += `‚Ä¢ Edad Metab√≥lica: ${selectedPatientForReport.edadMetabolica} a√±os\n`;
                    }
                    report += '\n';
                }
            }
            
            // Planes Nutricionales
            if (includePlans) {
                const patientPlans = getPlans().filter(p => p.pacienteId === selectedPatientForReport.id);
                
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                  PLANES NUTRICIONALES                      ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                
                if (patientPlans.length === 0) {
                    report += 'No hay planes nutricionales registrados para este paciente.\n\n';
                } else {
                    patientPlans.forEach((plan, index) => {
                        report += `PLAN ${index + 1}:\n`;
                        report += `Objetivo: ${plan.objetivo}\n`;
                        report += `Fecha de Creaci√≥n: ${new Date(plan.createdAt).toLocaleDateString('es-ES')}\n\n`;
                        
                        if (plan.desayuno) {
                            report += 'DESAYUNO (7:00 - 9:00 AM):\n';
                            report += `${plan.desayuno}\n\n`;
                        }
                        
                        if (plan.colacionMatutina) {
                            report += 'COLACI√ìN MATUTINA (10:00 - 11:00 AM):\n';
                            report += `${plan.colacionMatutina}\n\n`;
                        }
                        
                        if (plan.almuerzo) {
                            report += 'ALMUERZO (12:00 - 2:00 PM):\n';
                            report += `${plan.almuerzo}\n\n`;
                        }
                        
                        if (plan.colacionVespertina) {
                            report += 'COLACI√ìN VESPERTINA (4:00 - 5:00 PM):\n';
                            report += `${plan.colacionVespertina}\n\n`;
                        }
                        
                        if (plan.cena) {
                            report += 'CENA (7:00 - 9:00 PM):\n';
                            report += `${plan.cena}\n\n`;
                        }
                        
                        if (plan.hidratacion) {
                            report += `HIDRATACI√ìN: ${plan.hidratacion}\n\n`;
                        }
                        
                        if (plan.ejercicio) {
                            report += `ACTIVIDAD F√çSICA: ${plan.ejercicio}\n\n`;
                        }
                        
                        if (plan.notas) {
                            report += `NOTAS Y RESTRICCIONES:\n${plan.notas}\n\n`;
                        }
                        
                        if (index < patientPlans.length - 1) {
                            report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
                        }
                    });
                }
            }
            
            // Historial de Citas
            if (includeAppointments) {
                const patientAppointments = getAppointments()
                    .filter(a => a.pacienteId === selectedPatientForReport.id)
                    .sort((a, b) => new Date(b.fecha + 'T' + b.hora) - new Date(a.fecha + 'T' + a.hora));
                
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                   HISTORIAL DE CITAS                       ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                
                if (patientAppointments.length === 0) {
                    report += 'No hay citas registradas para este paciente.\n\n';
                } else {
                    patientAppointments.forEach((appointment, index) => {
                        const appointmentDate = new Date(appointment.fecha + 'T' + appointment.hora);
                        const isPast = appointmentDate < new Date();
                        
                        report += `${index + 1}. ${new Date(appointment.fecha).toLocaleDateString('es-ES')} - ${appointment.hora}\n`;
                        report += `   Estado: ${isPast ? 'Completada' : 'Programada'}\n`;
                        if (appointment.motivo) {
                            report += `   Motivo: ${appointment.motivo}\n`;
                        }
                        report += '\n';
                    });
                }
            }
            
            // Recomendaciones
            if (includeRecommendations) {
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                    RECOMENDACIONES                          ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                
                // Recomendaciones basadas en IMC
                const imcCategory = getIMCCategory(selectedPatientForReport.imc);
                report += 'RECOMENDACIONES BASADAS EN IMC:\n';
                
                if (imcCategory.text === 'Bajo peso') {
                    report += '‚Ä¢ Aumentar la ingesta cal√≥rica de manera saludable\n';
                    report += '‚Ä¢ Incluir m√°s prote√≠nas y grasas saludables\n';
                    report += '‚Ä¢ Realizar ejercicios de fuerza para ganar masa muscular\n';
                } else if (imcCategory.text === 'Normal') {
                    report += '‚Ä¢ Mantener el peso actual con una dieta equilibrada\n';
                    report += '‚Ä¢ Continuar con actividad f√≠sica regular\n';
                    report += '‚Ä¢ Monitorear cambios en la composici√≥n corporal\n';
                } else if (imcCategory.text === 'Sobrepeso') {
                    report += '‚Ä¢ Reducir la ingesta cal√≥rica de manera gradual\n';
                    report += '‚Ä¢ Aumentar la actividad f√≠sica cardiovascular\n';
                    report += '‚Ä¢ Enfocarse en alimentos ricos en fibra y prote√≠na\n';
                } else if (imcCategory.text === 'Obesidad') {
                    report += '‚Ä¢ Implementar un d√©ficit cal√≥rico controlado\n';
                    report += '‚Ä¢ Priorizar ejercicios de bajo impacto inicialmente\n';
                    report += '‚Ä¢ Considerar apoyo psicol√≥gico si es necesario\n';
                }
                report += '\n';
                
                // Recomendaciones de los planes
                const patientPlans = getPlans().filter(p => p.pacienteId === selectedPatientForReport.id);
                const planRecommendations = patientPlans
                    .filter(p => p.recomendaciones)
                    .map(p => p.recomendaciones);
                
                if (planRecommendations.length > 0) {
                    report += 'RECOMENDACIONES ESPEC√çFICAS DEL TRATAMIENTO:\n';
                    planRecommendations.forEach((rec, index) => {
                        report += `${index + 1}. ${rec}\n`;
                    });
                    report += '\n';
                }
                
                report += 'RECOMENDACIONES GENERALES:\n';
                report += '‚Ä¢ Mantener horarios regulares de comida\n';
                report += '‚Ä¢ Beber suficiente agua durante el d√≠a\n';
                report += '‚Ä¢ Dormir entre 7-8 horas diarias\n';
                report += '‚Ä¢ Realizar actividad f√≠sica regularmente\n';
                report += '‚Ä¢ Asistir a las citas de seguimiento programadas\n\n';
            }
            
            // Pie del reporte
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '                         IMPORTANTE\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            report += 'Este reporte es confidencial y est√° destinado √∫nicamente para\n';
            report += 'el paciente mencionado. Las recomendaciones deben seguirse\n';
            report += 'bajo supervisi√≥n profesional.\n\n';
            report += 'Para dudas o consultas adicionales, contacte a su nutri√≥logo.\n\n';
            report += `Generado el: ${new Date().toLocaleString('es-ES')}\n`;
            report += `Por: ${clinicName}\n`;
            
            currentReportData = report;
            
            // Mostrar vista previa
            document.getElementById('report-preview').textContent = report;
            document.getElementById('download-btn').classList.remove('hidden');
            document.getElementById('copy-btn').classList.remove('hidden');
            
            showToast('Reporte generado correctamente', 'success');
        }

        function downloadReport() {
            if (!currentReportData || !selectedPatientForReport) return;
            
            const fileName = `Reporte_${selectedPatientForReport.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            
            const blob = new Blob([currentReportData], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast(`Reporte descargado: ${fileName}`, 'success');
        }

        async function copyReport() {
            if (!currentReportData || !selectedPatientForReport) return;
            
            const copyBtn = document.getElementById('copy-btn');
            const originalText = copyBtn.innerHTML;
            
            try {
                await navigator.clipboard.writeText(currentReportData);
                
                // Cambiar temporalmente el bot√≥n para mostrar √©xito
                copyBtn.innerHTML = '<span>‚úì</span><span>¬°Copiado!</span>';
                copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                showToast('Reporte copiado al portapapeles', 'success');
                
                // Restaurar el bot√≥n despu√©s de 2 segundos
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
                
            } catch (error) {
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = currentReportData;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showToast('Reporte copiado al portapapeles', 'success');
                    
                    // Cambiar temporalmente el bot√≥n para mostrar √©xito
                    copyBtn.innerHTML = '<span>‚úì</span><span>¬°Copiado!</span>';
                    copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }, 2000);
                } catch (fallbackError) {
                    showToast('No se pudo copiar el reporte. Usa el bot√≥n de descarga.', 'error');
                }
                
                document.body.removeChild(textArea);
            }
        }

        // Funciones del Asistente IA
        function renderAssistant() {
            const patients = getPatients();
            const select = document.getElementById('ai-patient-select');
            
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + 
                patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            
            updateChatStats();
        }

        function updateChatStats() {
            document.getElementById('chat-count').textContent = chatCount;
            document.getElementById('analysis-count').textContent = analysisCount;
        }

        function addMessage(content, isUser = false, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start gap-3';
            
            if (isUser) {
                messageDiv.className += ' flex-row-reverse';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white text-sm">üë§</span>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg shadow-sm p-4 max-w-md">
                        <p>${content}</p>
                    </div>
                `;
            } else {
                if (isTyping) {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-sm">ü§ñ</span>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
                            <div class="flex items-center gap-2">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                                <span class="text-gray-500 text-sm">NutriBot est√° escribiendo...</span>
                            </div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-sm">ü§ñ</span>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
                            <div class="text-gray-800">${content}</div>
                        </div>
                    `;
                }
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }

        function generateAIResponse(userMessage, patientData = null) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Respuestas sobre IMC
            if (lowerMessage.includes('imc') || lowerMessage.includes('√≠ndice de masa corporal')) {
                if (lowerMessage.includes('28.5') || lowerMessage.includes('28,5')) {
                    return `
                        <p><strong>üìä An√°lisis de IMC 28.5:</strong></p>
                        <p>Un IMC de 28.5 indica <strong>sobrepeso</strong> (rango: 25.0-29.9).</p>
                        <p><strong>üéØ Recomendaciones:</strong></p>
                        <ul class="mt-2 space-y-1 text-sm">
                            <li>‚Ä¢ D√©ficit cal√≥rico moderado (300-500 kcal/d√≠a)</li>
                            <li>‚Ä¢ Aumentar actividad f√≠sica cardiovascular</li>
                            <li>‚Ä¢ Enfocarse en alimentos ricos en fibra</li>
                            <li>‚Ä¢ Controlar porciones y horarios de comida</li>
                            <li>‚Ä¢ Meta: reducir 0.5-1 kg por semana</li>
                        </ul>
                        <p class="mt-2 text-sm text-gray-600">üí° <em>Est√° cerca del rango normal (18.5-24.9). Con peque√±os cambios puede lograr grandes resultados.</em></p>
                    `;
                }
                
                if (patientData && patientData.imc) {
                    const category = getIMCCategory(patientData.imc);
                    return `
                        <p><strong>üìä An√°lisis de IMC para ${patientData.nombre}:</strong></p>
                        <p>IMC actual: <strong>${patientData.imc}</strong> - ${category.text}</p>
                        <p><strong>üéØ Recomendaciones espec√≠ficas:</strong></p>
                        ${getIMCRecommendations(patientData.imc, patientData.edad, patientData.genero)}
                    `;
                }
                
                return `
                    <p><strong>üìä Sobre el √çndice de Masa Corporal (IMC):</strong></p>
                    <p>El IMC es una medida que relaciona peso y altura:</p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ <strong>Bajo peso:</strong> Menos de 18.5</li>
                        <li>‚Ä¢ <strong>Normal:</strong> 18.5 - 24.9</li>
                        <li>‚Ä¢ <strong>Sobrepeso:</strong> 25.0 - 29.9</li>
                        <li>‚Ä¢ <strong>Obesidad:</strong> 30.0 o m√°s</li>
                    </ul>
                    <p class="mt-2 text-sm text-gray-600">üí° <em>¬øTienes un IMC espec√≠fico que quieres que analice?</em></p>
                `;
            }
            
            // Respuestas sobre grasa visceral
            if (lowerMessage.includes('grasa visceral') || lowerMessage.includes('visceral')) {
                if (lowerMessage.includes('12') || lowerMessage.includes('nivel 12')) {
                    return `
                        <p><strong>‚ö†Ô∏è An√°lisis de Grasa Visceral Nivel 12:</strong></p>
                        <p>Un nivel 12 de grasa visceral est√° en el <strong>rango alto</strong> (normal: 1-9).</p>
                        <p><strong>üö® Riesgos asociados:</strong></p>
                        <ul class="mt-2 space-y-1 text-sm">
                            <li>‚Ä¢ Mayor riesgo cardiovascular</li>
                            <li>‚Ä¢ Resistencia a la insulina</li>
                            <li>‚Ä¢ Inflamaci√≥n sist√©mica</li>
                            <li>‚Ä¢ S√≠ndrome metab√≥lico</li>
                        </ul>
                        <p><strong>üéØ Plan de acci√≥n urgente:</strong></p>
                        <ul class="mt-2 space-y-1 text-sm">
                            <li>‚Ä¢ Ejercicio cardiovascular intenso (5x/semana)</li>
                            <li>‚Ä¢ Dieta antiinflamatoria</li>
                            <li>‚Ä¢ Reducir az√∫cares y carbohidratos refinados</li>
                            <li>‚Ä¢ Aumentar omega-3 y fibra</li>
                            <li>‚Ä¢ Considerar evaluaci√≥n m√©dica</li>
                        </ul>
                    `;
                }
                
                return `
                    <p><strong>üîç Sobre la Grasa Visceral:</strong></p>
                    <p>Es la grasa que rodea los √≥rganos internos. Niveles de referencia:</p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ <strong>Saludable:</strong> 1-9</li>
                        <li>‚Ä¢ <strong>Moderado:</strong> 10-14</li>
                        <li>‚Ä¢ <strong>Alto riesgo:</strong> 15-20</li>
                    </ul>
                    <p class="mt-2 text-sm text-gray-600">üí° <em>Es m√°s peligrosa que la grasa subcut√°nea porque afecta directamente los √≥rganos.</em></p>
                `;
            }
            
            // Respuestas sobre prote√≠nas
            if (lowerMessage.includes('prote√≠na') || lowerMessage.includes('proteinas') || lowerMessage.includes('alimentos ricos en prote√≠na')) {
                return `
                    <p><strong>ü•© Alimentos Ricos en Prote√≠na:</strong></p>
                    <p><strong>üêü Prote√≠nas Completas (origen animal):</strong></p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ <strong>Pollo:</strong> 25g por 100g</li>
                        <li>‚Ä¢ <strong>Pescado:</strong> 20-25g por 100g</li>
                        <li>‚Ä¢ <strong>Huevos:</strong> 13g por 100g</li>
                        <li>‚Ä¢ <strong>Carne magra:</strong> 20-26g por 100g</li>
                        <li>‚Ä¢ <strong>Yogurt griego:</strong> 10g por 100g</li>
                    </ul>
                    <p><strong>üå± Prote√≠nas Vegetales:</strong></p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ <strong>Lentejas:</strong> 9g por 100g</li>
                        <li>‚Ä¢ <strong>Quinoa:</strong> 14g por 100g</li>
                        <li>‚Ä¢ <strong>Tofu:</strong> 8g por 100g</li>
                        <li>‚Ä¢ <strong>Almendras:</strong> 21g por 100g</li>
                        <li>‚Ä¢ <strong>Garbanzos:</strong> 8g por 100g</li>
                    </ul>
                    <p class="mt-2 text-sm text-gray-600">üí° <em>Recomendaci√≥n: 0.8-1.2g por kg de peso corporal diario.</em></p>
                `;
            }
            
            // Respuestas sobre planes de comida
            if (lowerMessage.includes('plan de comida') || lowerMessage.includes('men√∫') || lowerMessage.includes('dieta')) {
                return `
                    <p><strong>üçΩÔ∏è Estructura de Plan de Comidas Saludable:</strong></p>
                    <p><strong>üåÖ Desayuno (25% del d√≠a):</strong></p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ Prote√≠na + Carbohidrato complejo + Grasa saludable</li>
                        <li>‚Ä¢ Ejemplo: Avena + huevo + aguacate + fruta</li>
                    </ul>
                    <p><strong>üçΩÔ∏è Almuerzo (35% del d√≠a):</strong></p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ Prote√≠na magra + Vegetales + Carbohidrato + Grasa</li>
                        <li>‚Ä¢ Ejemplo: Pollo + ensalada + arroz integral + aceite oliva</li>
                    </ul>
                    <p><strong>üåô Cena (25% del d√≠a):</strong></p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ Prote√≠na + Vegetales + Carbohidrato ligero</li>
                        <li>‚Ä¢ Ejemplo: Pescado + verduras + batata</li>
                    </ul>
                    <p><strong>ü•§ Colaciones (15% del d√≠a):</strong></p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ Fruta + frutos secos</li>
                        <li>‚Ä¢ Yogurt + semillas</li>
                    </ul>
                `;
            }
            
            // Respuestas sobre an√°lisis de alimentos
            if (lowerMessage.includes('an√°lisis de alimento') || lowerMessage.includes('informaci√≥n nutricional')) {
                return `
                    <p><strong>üîç ¬øQu√© alimento quieres que analice?</strong></p>
                    <p>Puedo proporcionarte informaci√≥n detallada sobre:</p>
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ <strong>Macronutrientes:</strong> Prote√≠nas, carbohidratos, grasas</li>
                        <li>‚Ä¢ <strong>Micronutrientes:</strong> Vitaminas y minerales</li>
                        <li>‚Ä¢ <strong>Calor√≠as:</strong> Por porci√≥n y por 100g</li>
                        <li>‚Ä¢ <strong>Beneficios:</strong> Para la salud</li>
                        <li>‚Ä¢ <strong>Recomendaciones:</strong> De consumo</li>
                    </ul>
                    <p class="mt-2 text-sm text-gray-600">üí° <em>Ejemplo: "Analiza las propiedades nutricionales del aguacate"</em></p>
                `;
            }
            
            // Respuestas sobre tips nutricionales
            if (lowerMessage.includes('tip') || lowerMessage.includes('consejo') || lowerMessage.includes('recomendaci√≥n')) {
                const tips = [
                    {
                        title: "üíß Hidrataci√≥n Inteligente",
                        content: "Bebe un vaso de agua antes de cada comida. Te ayudar√° a sentirte m√°s saciado y mejorar la digesti√≥n."
                    },
                    {
                        title: "üçΩÔ∏è Regla del Plato",
                        content: "Divide tu plato: 1/2 vegetales, 1/4 prote√≠na magra, 1/4 carbohidratos complejos."
                    },
                    {
                        title: "‚è∞ Timing de Nutrientes",
                        content: "Consume prote√≠nas en cada comida para mantener la saciedad y preservar masa muscular."
                    },
                    {
                        title: "üåà Come Colores",
                        content: "Incluye frutas y verduras de diferentes colores para obtener variedad de antioxidantes."
                    },
                    {
                        title: "ü•ú Grasas Saludables",
                        content: "Incluye aguacate, frutos secos y aceite de oliva para mejorar la absorci√≥n de vitaminas."
                    }
                ];
                
                const randomTip = tips[Math.floor(Math.random() * tips.length)];
                return `
                    <p><strong>${randomTip.title}</strong></p>
                    <p>${randomTip.content}</p>
                    <p class="mt-3 text-sm text-gray-600">üí° <em>¬øQuieres m√°s tips espec√≠ficos sobre alg√∫n tema nutricional?</em></p>
                `;
            }
            
            // Respuesta por defecto
            return `
                <p>Entiendo tu consulta sobre nutrici√≥n. Como asistente especializado, puedo ayudarte con:</p>
                <ul class="mt-2 space-y-1 text-sm">
                    <li>‚Ä¢ <strong>An√°lisis de m√©tricas corporales</strong> (IMC, grasa corporal, etc.)</li>
                    <li>‚Ä¢ <strong>Recomendaciones nutricionales</strong> personalizadas</li>
                    <li>‚Ä¢ <strong>Informaci√≥n sobre alimentos</strong> y sus propiedades</li>
                    <li>‚Ä¢ <strong>Planes de alimentaci√≥n</strong> estructurados</li>
                    <li>‚Ä¢ <strong>Tips y consejos</strong> nutricionales</li>
                </ul>
                <p class="mt-2 text-sm text-gray-600">üí° <em>¬øPodr√≠as ser m√°s espec√≠fico sobre qu√© aspecto nutricional te interesa?</em></p>
            `;
        }

        function getIMCRecommendations(imc, edad, genero) {
            const category = getIMCCategory(imc);
            
            if (category.text === 'Bajo peso') {
                return `
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ Aumentar ingesta cal√≥rica (+300-500 kcal/d√≠a)</li>
                        <li>‚Ä¢ Incluir m√°s prote√≠nas de calidad</li>
                        <li>‚Ä¢ Ejercicios de fuerza para ganar masa muscular</li>
                        <li>‚Ä¢ Comidas m√°s frecuentes (5-6 al d√≠a)</li>
                        <li>‚Ä¢ Consultar con m√©dico si persiste</li>
                    </ul>
                `;
            } else if (category.text === 'Normal') {
                return `
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ Mantener peso actual con dieta equilibrada</li>
                        <li>‚Ä¢ Actividad f√≠sica regular (150 min/semana)</li>
                        <li>‚Ä¢ Monitorear composici√≥n corporal</li>
                        <li>‚Ä¢ Enfocarse en h√°bitos saludables</li>
                        <li>‚Ä¢ Revisiones peri√≥dicas</li>
                    </ul>
                `;
            } else if (category.text === 'Sobrepeso') {
                return `
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ D√©ficit cal√≥rico moderado (300-500 kcal/d√≠a)</li>
                        <li>‚Ä¢ Aumentar actividad cardiovascular</li>
                        <li>‚Ä¢ Priorizar alimentos ricos en fibra</li>
                        <li>‚Ä¢ Control de porciones</li>
                        <li>‚Ä¢ Meta: 0.5-1 kg por semana</li>
                    </ul>
                `;
            } else {
                return `
                    <ul class="mt-2 space-y-1 text-sm">
                        <li>‚Ä¢ D√©ficit cal√≥rico controlado (500-750 kcal/d√≠a)</li>
                        <li>‚Ä¢ Ejercicio de bajo impacto inicialmente</li>
                        <li>‚Ä¢ Apoyo profesional multidisciplinario</li>
                        <li>‚Ä¢ Cambios graduales y sostenibles</li>
                        <li>‚Ä¢ Evaluaci√≥n m√©dica completa</li>
                    </ul>
                `;
            }
        }

        function sendMessage(message) {
            if (!message.trim()) return;
            
            // Agregar mensaje del usuario
            addMessage(message, true);
            chatHistory.push({ role: 'user', content: message });
            
            // Mostrar indicador de escritura
            const typingMessage = addMessage('', false, true);
            
            // Obtener datos del paciente seleccionado si existe
            const selectedPatientId = document.getElementById('ai-patient-select').value;
            const selectedPatient = selectedPatientId ? allData.find(p => p.id === selectedPatientId) : null;
            
            // Simular delay de respuesta
            setTimeout(() => {
                // Remover indicador de escritura
                typingMessage.remove();
                
                // Generar y mostrar respuesta
                const response = generateAIResponse(message, selectedPatient);
                addMessage(response, false);
                chatHistory.push({ role: 'assistant', content: response });
                
                // Actualizar estad√≠sticas
                chatCount++;
                if (selectedPatient || message.toLowerCase().includes('analizar') || message.toLowerCase().includes('an√°lisis')) {
                    analysisCount++;
                }
                updateChatStats();
                
            }, 1000 + Math.random() * 2000); // 1-3 segundos de delay
        }

        function sendSuggestion(suggestion) {
            document.getElementById('chat-input').value = suggestion;
            sendMessage(suggestion);
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white text-sm">ü§ñ</span>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
                        <p class="text-gray-800">Chat reiniciado. ¬øEn qu√© puedo ayudarte?</p>
                    </div>
                </div>
            `;
            chatHistory = [];
            showToast('Chat limpiado correctamente', 'success');
        }

        function quickAnalyzePatient() {
            const selectedPatientId = document.getElementById('ai-patient-select').value;
            if (!selectedPatientId) {
                showToast('Selecciona un paciente primero', 'error');
                return;
            }
            
            const patient = allData.find(p => p.id === selectedPatientId);
            const message = `Analiza completamente al paciente ${patient.nombre} con sus m√©tricas actuales`;
            sendMessage(message);
        }

        function quickMealPlan() {
            const selectedPatientId = document.getElementById('ai-patient-select').value;
            if (selectedPatientId) {
                const patient = allData.find(p => p.id === selectedPatientId);
                const message = `Crea un plan de comidas personalizado para ${patient.nombre} considerando su IMC de ${patient.imc}`;
                sendMessage(message);
            } else {
                sendMessage('Crea un plan de comidas saludable y equilibrado');
            }
        }

        function quickNutritionTips() {
            sendMessage('Dame consejos nutricionales pr√°cticos para mejorar la salud');
        }

        function quickFoodAnalysis() {
            sendMessage('¬øQu√© alimento quieres que analice nutricionalmente?');
        }

        // Event listeners para el chat
        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message) {
                sendMessage(message);
                input.value = '';
            }
        });

        init();
        
        // Configurar c√°lculo en tiempo real cuando se abra el formulario
        document.addEventListener('DOMContentLoaded', () => {
            setupRealtimeCalculation();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99a28a4c749b598b',t:'MTc2MjQxMDYwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
