<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Nutricional</title>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            transition: all 0.2s;
        }

        .nav-item:hover {
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #005eff 0%, #005eff 100%);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #005eff 0%, #005eff 100%);
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .input-field {
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-field:focus {
            border-color: #005eff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .calendar-day {
            transition: all 0.3s ease;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 8px 4px;
            border: 1px solid #e5e7eb;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.has-appointment {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #005eff;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            font-weight: bold;
            color: #92400e;
        }

        .calendar-day.other-month {
            color: #d1d5db;
            background-color: #f9fafb;
        }

        .calendar-day-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-appointment-dot {
            width: 6px;
            height: 6px;
            background-color: #005eff;
            border-radius: 50%;
            margin: 1px;
        }

        .calendar-appointment-count {
            font-size: 10px;
            background-color: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            margin-top: 2px;
            font-weight: bold;
        }

        .calendar-header {
            background: linear-gradient(135deg, #005eff 0%, #005eff 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .calendar-weekday {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #475569;
            font-weight: 600;
            padding: 12px;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #005eff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .metric-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .metric-normal {
            background-color: #d1fae5;
            color: #065f46;
        }

        .metric-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .metric-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* ===================== */
        /*  SIDEBAR REDISE√ëADO   */
        /* ===================== */
        .sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            width: 18rem;
            background: linear-gradient(180deg, #ffffffcc, #f8fafccc);
            backdrop-filter: blur(10px);
            border-right: 1px solid #e5e7eb;
            transition: width .25s ease, transform .25s ease;
            display: flex;
            flex-direction: column;
            z-index: 30;
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-search {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            outline: 0;
            transition: box-shadow .2s, border-color .2s;
            background: #fff;
        }

        .sidebar-search:focus {
            border-color: #005eff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, .12);
        }

        .nav-pill {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            gap: .75rem;
            border-radius: 12px;
            padding: 10px 12px;
            color: #374151;
            font-weight: 600;
            transition: transform .15s, background .15s, color .15s;
        }

        .nav-pill .icon {
            width: 1.5rem;
            text-align: center;
            opacity: .9;
        }

        .nav-pill .nav-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-pill:hover {
            background: #f3f4f6;
            transform: translateX(2px);
        }

        .nav-pill.active {
            color: #111827;
            background: linear-gradient(to right, #eef2ff, #f5f3ff);
            box-shadow: inset 0 0 0 1px #e5e7eb;
        }

        .nav-pill.active .icon {
            opacity: 1;
        }

        .active-dot {
            content: "";
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%) scale(.6);
            width: 6px;
            height: 18px;
            border-radius: 6px;
            background: linear-gradient(180deg, #005eff, #005eff);
            opacity: 0;
            transition: opacity .2s, transform .2s;
        }

        .nav-pill.active .active-dot {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        .badge {
            margin-left: auto;
            font-size: 11px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 999px;
            background: #111827;
            color: #fff;
        }

        .btn-quick {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 12px;
            border-radius: 12px;
            width: 100%;
            color: #fff;
            font-weight: 700;
            background: linear-gradient(135deg, #005eff, #005eff);
            transition: transform .15s, box-shadow .15s;
        }

        .btn-quick:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(16, 185, 129, .25);
        }

        /* Estado colapsado (desktop) */
        .sidebar.is-collapsed {
            width: 5rem;
        }

        .sidebar.is-collapsed .brand>div:nth-child(1)+div,
        .sidebar.is-collapsed .nav-label,
        .sidebar.is-collapsed .btn-quick,
        .sidebar.is-collapsed .brand #app-title,
        .sidebar.is-collapsed .brand #clinic-name {
            display: none;
        }

        .sidebar.is-collapsed .badge {
            display: none;
        }

        .sidebar.is-collapsed .nav-pill {
            justify-content: center;
            padding: 10px;
        }

        .sidebar.is-collapsed .active-dot {
            left: 0;
        }

        /* Drawer m√≥vil */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                transform: translateX(-100%);
                box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            #sidebar-overlay.hidden {
                display: none;
            }
        }
    </style>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>

<body class="bg-gray-50">
    <div class="flex h-full">
        <!-- ======= Sidebar redise√±ado ======= -->
        <button id="sidebar-toggle"
            class="md:hidden fixed top-4 left-4 z-50 px-3 py-2 rounded-lg shadow bg-white/90 border border-gray-200">
            ‚ò∞
        </button>
        <div id="sidebar-overlay" class="md:hidden fixed inset-0 bg-black/40 hidden z-40"></div>

        <aside id="sidebar" class="sidebar">
            <!-- Brand / Header -->
            <div class="brand">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-blue-600 text-white grid place-items-center text-lg">
                        üçè</div>
                    <div class="min-w-0">
                        <h1 id="app-title" class="truncate text-base font-semibold text-gray-800">Gesti√≥n Nutricional
                        </h1>
                        <p id="clinic-name" class="truncate text-xs text-gray-500">Mi Cl√≠nica Nutricional</p>
                    </div>
                </div>
                <button id="collapse-btn"
                    class="hidden md:inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 hover:bg-gray-50"
                    title="Colapsar/Expandir">
                    ‚Äπ‚Ä∫
                </button>
            </div>

            <!-- Search -->
            <div class="px-3 mt-2">
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîé</span>
                    <input type="text" placeholder="Buscar‚Ä¶" class="sidebar-search" oninput="filterSidebar(this.value)">
                </div>
            </div>

            <!-- Nav -->
            <nav id="sidebar-nav" class="mt-2 space-y-1 px-2">
                <button onclick="showSection('pacientes')" id="nav-pacientes"
                    class="nav-item nav-pill active text-gray-700" data-label="Pacientes" title="Pacientes">
                    <span class="active-dot"></span>
                    <span class="icon">üìã</span>
                    <span class="nav-label">Pacientes</span>
                    <span id="badge-pacientes" class="badge hidden">0</span>
                </button>

                <button onclick="showSection('calendario')" id="nav-calendario" class="nav-item nav-pill text-gray-700"
                    data-label="Calendario" title="Calendario">
                    <span class="active-dot"></span>
                    <span class="icon">üìÖ</span>
                    <span class="nav-label">Calendario</span>
                    <span id="badge-citas" class="badge hidden">0</span>
                </button>

                <button onclick="showSection('planes')" id="nav-planes" class="nav-item nav-pill text-gray-700"
                    data-label="Planes" title="Planes nutricionales">
                    <span class="active-dot"></span>
                    <span class="icon">üçé</span>
                    <span class="nav-label">Planes</span>
                    <span id="badge-planes" class="badge hidden">0</span>
                </button>

                <button onclick="showSection('estadisticas')" id="nav-estadisticas"
                    class="nav-item nav-pill text-gray-700" data-label="Estad√≠sticas" title="Estad√≠sticas">
                    <span class="active-dot"></span>
                    <span class="icon">üìä</span>
                    <span class="nav-label">Estad√≠sticas</span>
                </button>

                <button onclick="showSection('reportes')" id="nav-reportes" class="nav-item nav-pill text-gray-700"
                    data-label="Reportes" title="Reportes">
                    <span class="active-dot"></span>
                    <span class="icon">üìÑ</span>
                    <span class="nav-label">Reportes</span>
                </button>

                <button onclick="showSection('asistente')" id="nav-asistente" class="nav-item nav-pill text-gray-700"
                    data-label="Asistente IA" title="Asistente IA">
                    <span class="active-dot"></span>
                    <span class="icon">ü§ñ</span>
                    <span class="nav-label">Asistente IA</span>
                </button>
            </nav>

            <!-- Quick Action -->
            <div class="mt-auto p-3">
                <button onclick="showAddPatientForm()" class="w-full btn-quick">
                    ‚ûï Nuevo Paciente
                </button>
                <div class="mt-3 text-[11px] text-gray-400 text-center">
                    ‚åò/Ctrl + B para colapsar
                </div>
            </div>
        </aside>

        <!-- ======= Main Content ======= -->
        <div class="flex-1 overflow-y-auto">
            <!-- Pacientes Section -->
            <div id="section-pacientes" class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Gesti√≥n de Pacientes</h2>
                    <button onclick="showAddPatientForm()"
                        class="btn-primary text-white px-6 py-3 rounded-lg font-medium"> ‚ûï Nuevo Paciente </button>
                </div>
                <div id="patients-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Patients will be rendered here --></div>

                <!-- Add/Edit Patient Form -->
                <div id="patient-form-container"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90%] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-gray-800" id="form-title">Nuevo Paciente</h3>
                            <button onclick="closePatientForm()"
                                class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                        </div>
                        <form id="patient-form" class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo
                                        *</label>
                                    <input type="text" id="input-nombre" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Edad *</label>
                                    <input type="number" id="input-edad" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">G√©nero *</label>
                                    <select id="input-genero" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Seleccionar</option>
                                        <option value="Masculino">Masculino</option>
                                        <option value="Femenino">Femenino</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Altura (cm) *</label>
                                    <input type="number" step="0.1" id="input-altura" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Peso (kg) *</label>
                                    <input type="number" step="0.1" id="input-peso" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Grasa Corporal (%) <span
                                            class="text-xs text-gray-500">- Opcional, se calcular√°
                                            autom√°ticamente</span></label>
                                    <input type="number" step="0.1" id="input-grasa"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        placeholder="Se calcular√° autom√°ticamente">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Musculatura Esquel√©tica
                                        (%)</label>
                                    <input type="number" step="0.1" id="input-musculatura"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Grasa Subcut√°nea
                                        (%)</label>
                                    <input type="number" step="0.1" id="input-grasa-subcutanea"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Grasa Visceral
                                        (nivel)</label>
                                    <input type="number" step="0.1" id="input-grasa-visceral"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Agua Corporal
                                        (%)</label>
                                    <input type="number" step="0.1" id="input-agua"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Masa Muscular
                                        (kg)</label>
                                    <input type="number" step="0.1" id="input-masa-muscular"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Masa √ìsea (kg)</label>
                                    <input type="number" step="0.1" id="input-masa-osea"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prote√≠na (%)</label>
                                    <input type="number" step="0.1" id="input-proteina"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <!-- NUEVOS CAMPOS: actividad y objetivo -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nivel de Actividad
                                        *</label>
                                    <select id="input-actividad" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="ligera">Ligera (1.375)</option>
                                        <option value="sedentaria">Sedentaria (1.2)</option>
                                        <option value="moderada">Moderada (1.55)</option>
                                        <option value="intensa">Intensa (1.725)</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Objetivo de dieta
                                        *</label>
                                    <select id="input-objetivo-dieta" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="mantenimiento">Mantenimiento</option>
                                        <option value="perdida">P√©rdida de peso (-500 kcal)</option>
                                        <option value="ganancia">Ganancia muscular (+300 kcal)</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label>
                                    <input type="tel" id="input-telefono"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="input-email"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>

                                <div class="col-span-full">
                                    <button type="button" onclick="autoFillCalculatedFields()"
                                        class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg font-medium hover:from-green-600 hover:to-blue-600 transition-all">
                                        üßÆ Calcular Autom√°ticamente Todos los Par√°metros </button>
                                    <p class="text-xs text-gray-500 mt-2 text-center">Completa peso, altura, edad y
                                        g√©nero, luego haz clic para calcular el resto</p>
                                </div>
                            </div>

                            <!-- Vista previa de c√°lculos -->
                            <div id="metrics-preview" class="mt-6 p-4 bg-blue-50 rounded-lg hidden">
                                <h4 class="font-semibold text-blue-800 mb-3">üìä Vista Previa de C√°lculos</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div class="text-center">
                                        <p class="text-blue-600 font-medium">IMC</p>
                                        <p class="text-lg font-bold text-blue-800" id="preview-imc">-</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-blue-600 font-medium">TMB</p>
                                        <p class="text-lg font-bold text-blue-800" id="preview-tmb">-</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-blue-600 font-medium">Grasa Corporal</p>
                                        <p class="text-lg font-bold text-blue-800" id="preview-grasa">-</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-blue-600 font-medium">Edad Metab√≥lica</p>
                                        <p class="text-lg font-bold text-blue-800" id="preview-edad-metabolica">-</p>
                                    </div>
                                </div>
                                <button type="button" onclick="toggleAdvancedPreview()"
                                    class="mt-3 text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    <span id="advanced-toggle-text">Ver m√°s detalles ‚ñº</span>
                                </button>
                                <div id="advanced-preview"
                                    class="hidden mt-3 grid grid-cols-2 md:grid-cols-3 gap-3 text-xs">
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">Peso sin Grasa</p>
                                        <p class="font-bold" id="preview-peso-sin-grasa">-</p>
                                    </div>
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">Masa Muscular</p>
                                        <p class="font-bold" id="preview-masa-muscular">-</p>
                                    </div>
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">Agua Corporal</p>
                                        <p class="font-bold" id="preview-agua">-</p>
                                    </div>
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">Grasa Visceral</p>
                                        <p class="font-bold" id="preview-grasa-visceral">-</p>
                                    </div>
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">Masa √ìsea</p>
                                        <p class="font-bold" id="preview-masa-osea">-</p>
                                    </div>
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">Prote√≠na</p>
                                        <p class="font-bold" id="preview-proteina">-</p>
                                    </div>
                                    <!-- NUEVO: Energ√≠a -->
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">TDEE</p>
                                        <p class="font-bold" id="preview-tdee">-</p>
                                    </div>
                                    <div class="bg-white p-2 rounded">
                                        <p class="text-gray-600">Calor√≠as Objetivo</p>
                                        <p class="font-bold" id="preview-calorias-objetivo">-</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 flex justify-end gap-4">
                                <button type="button" onclick="closePatientForm()"
                                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                    Cancelar </button>
                                <button type="submit"
                                    class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                                    <span id="save-btn-text">Guardar Paciente</span>
                                    <div id="save-spinner" class="loading-spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Patient Detail View -->
                <div id="patient-detail-container"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90%] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-gray-800" id="detail-patient-name">Detalles del Paciente
                            </h3>
                            <button onclick="closePatientDetail()"
                                class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                        </div>
                        <div id="patient-detail-content" class="p-6"></div>
                    </div>
                </div>
            </div>

            <!-- Calendario Section -->
            <div id="section-calendario" class="p-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Calendario de Citas</h2>
                    <button onclick="showAddAppointmentForm()"
                        class="btn-primary text-white px-6 py-3 rounded-lg font-medium"> ‚ûï Nueva Cita </button>
                </div>
                <div class="bg-white rounded-xl shadow-xl overflow-hidden mb-6">
                    <div class="calendar-header">
                        <div class="flex justify-between items-center">
                            <button onclick="previousMonth()"
                                class="calendar-nav-btn flex items-center gap-2"><span>‚Üê</span> Anterior</button>
                            <div class="text-center">
                                <h3 class="text-2xl font-bold" id="calendar-month-year"></h3>
                                <p class="text-sm opacity-80 mt-1">Haz clic en un d√≠a para agendar una cita</p>
                            </div>
                            <button onclick="nextMonth()" class="calendar-nav-btn flex items-center gap-2">Siguiente
                                <span>‚Üí</span></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-7">
                        <div class="calendar-weekday">Dom</div>
                        <div class="calendar-weekday">Lun</div>
                        <div class="calendar-weekday">Mar</div>
                        <div class="calendar-weekday">Mi√©</div>
                        <div class="calendar-weekday">Jue</div>
                        <div class="calendar-weekday">Vie</div>
                        <div class="calendar-weekday">S√°b</div>
                        <div id="calendar-days" class="contents"></div>
                    </div>

                    <div class="p-4 bg-gray-50 border-t">
                        <div class="flex flex-wrap gap-4 justify-center text-sm">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-4 h-4 rounded border-2 border-f59e0b bg-gradient-to-br from-yellow-200 to-yellow-300">
                                </div><span class="text-gray-600">Hoy</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-4 h-4 rounded border-2 border-blue-500 bg-gradient-to-br from-blue-200 to-blue-300">
                                </div><span class="text-gray-600">Con citas</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div><span
                                    class="text-gray-600">Indicador de cita</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <span class="text-white text-lg">üìÖ</span></div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Pr√≥ximas Citas</h3>
                                <p class="text-sm text-gray-500">Citas programadas para los pr√≥ximos d√≠as</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-blue-600" id="upcoming-count">0</p>
                            <p class="text-xs text-gray-500">Pendientes</p>
                        </div>
                    </div>
                    <div id="appointments-list" class="space-y-3"></div>
                </div>

                <!-- Add Appointment Form -->
                <div id="appointment-form-container"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-gray-800">Nueva Cita</h3>
                            <button onclick="closeAppointmentForm()"
                                class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                        </div>
                        <form id="appointment-form" class="p-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Paciente *</label>
                                    <select id="input-paciente-cita" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Seleccionar paciente</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha *</label>
                                    <input type="date" id="input-fecha" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Hora *</label>
                                    <input type="time" id="input-hora" required
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo</label>
                                    <textarea id="input-motivo" rows="3"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-4">
                                <button type="button" onclick="closeAppointmentForm()"
                                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                    Cancelar </button>
                                <button type="submit"
                                    class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                                    <span id="save-appointment-btn-text">Guardar Cita</span>
                                    <div id="save-appointment-spinner" class="loading-spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Planes Section -->
            <div id="section-planes" class="p-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Planes Nutricionales</h2>
                    <button onclick="showAddPlanForm()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
                        ‚ûï Nuevo Plan </button>
                </div>
                <div id="plans-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

                <!-- Add Plan Form -->
                <div id="plan-form-container"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90%] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-gray-800" id="plan-form-title">Nuevo Plan Nutricional
                            </h3>
                            <button onclick="closePlanForm()"
                                class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                        </div>
                        <form id="plan-form" class="p-6">
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Paciente *</label>
                                        <select id="input-paciente-plan" required
                                            class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                            <option value="">Seleccionar paciente</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Objetivo *</label>
                                        <input type="text" id="input-objetivo" required
                                            placeholder="Ej: P√©rdida de peso, Ganancia muscular"
                                            class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>

                                <!-- NUEVO: Objetivo cal√≥rico y macros -->
                                <div
                                    class="bg-gradient-to-r from-amber-50 to-rose-50 rounded-xl p-4 border border-amber-200">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Calor√≠as
                                                objetivo (kcal)</label>
                                            <input type="number" id="input-calorias-objetivo-plan"
                                                class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                placeholder="Ej: 2200">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Prote√≠nas
                                                (g)</label>
                                            <input type="number" id="input-prot-g"
                                                class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                placeholder="Ej: 150">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Carbohidratos
                                                (g)</label>
                                            <input type="number" id="input-carb-g"
                                                class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                placeholder="Ej: 230">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Grasas
                                                (g)</label>
                                            <input type="number" id="input-fat-g"
                                                class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg"
                                                placeholder="Ej: 70">
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-2 mt-3">
                                        <button type="button" onclick="autoCalcMacrosFromPatient()"
                                            class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm">üß†
                                            Autocalcular desde paciente</button>
                                        <button type="button" onclick="proposeMenuIntoForm()"
                                            class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm">üçΩÔ∏è
                                            Proponer men√∫ seg√∫n macros</button>
                                    </div>
                                </div>

                                <!-- Plan Nutricional Estructurado -->
                                <div
                                    class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 border border-green-200">
                                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">üçΩÔ∏è Plan
                                        Nutricional Diario</h4>
                                    <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üåÖ</span>
                                            <h5 class="font-semibold text-gray-700">Desayuno</h5><span
                                                class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">7:00
                                                - 9:00 AM</span>
                                        </div>
                                        <textarea id="input-desayuno" rows="3"
                                            class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                            placeholder="Se llenar√° si usas 'Proponer men√∫'"></textarea>
                                    </div>
                                    <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center gap-2 mb-3"><span class="text-2xl">ü•§</span>
                                            <h5 class="font-semibold text-gray-700">Colaci√≥n Matutina</h5><span
                                                class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">10:00
                                                - 11:00 AM</span>
                                        </div>
                                        <textarea id="input-colacion-matutina" rows="2"
                                            class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                                    </div>
                                    <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üçΩÔ∏è</span>
                                            <h5 class="font-semibold text-gray-700">Almuerzo</h5><span
                                                class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">12:00 -
                                                2:00 PM</span>
                                        </div>
                                        <textarea id="input-almuerzo" rows="4"
                                            class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                                    </div>
                                    <div class="mb-6 bg-white rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center gap-2 mb-3"><span class="text-2xl">ü•®</span>
                                            <h5 class="font-semibold text-gray-700">Colaci√≥n Vespertina</h5><span
                                                class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">4:00
                                                - 5:00 PM</span>
                                        </div>
                                        <textarea id="input-colacion-vespertina" rows="2"
                                            class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                                    </div>
                                    <div class="mb-4 bg-white rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üåô</span>
                                            <h5 class="font-semibold text-gray-700">Cena</h5><span
                                                class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">7:00
                                                - 9:00 PM</span>
                                        </div>
                                        <textarea id="input-cena" rows="3"
                                            class="input-field w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                                    </div>
                                </div>

                                <!-- Informaci√≥n Adicional -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">üíß Hidrataci√≥n
                                            Diaria</label>
                                        <input type="text" id="input-hidratacion"
                                            class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"
                                            placeholder="Ej: 2-3 litros de agua, infusiones sin az√∫car">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">üèÉ‚Äç‚ôÄÔ∏è Actividad
                                            F√≠sica Recomendada</label>
                                        <input type="text" id="input-ejercicio"
                                            class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"
                                            placeholder="Ej: 30 min caminata diaria, 3 d√≠as gym">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">üìù Notas y
                                        Restricciones</label>
                                    <textarea id="input-notas" rows="3"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        placeholder="Alergias, intolerancias, preferencias alimentarias, medicamentos..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‚ö†Ô∏è Recomendaciones
                                        Especiales</label>
                                    <textarea id="input-recomendaciones" rows="2"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        placeholder="Suplementos, horarios espec√≠ficos, precauciones..."></textarea>
                                </div>
                            </div>

                            <div class="mt-6 flex justify-end gap-4">
                                <button type="button" onclick="closePlanForm()"
                                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                    Cancelar </button>
                                <button type="submit"
                                    class="btn-primary text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2">
                                    <span id="save-plan-btn-text">Guardar Plan</span>
                                    <div id="save-plan-spinner" class="loading-spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Reportes Section -->
            <div id="section-reportes" class="p-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Generador de Reportes</h2>
                    <div class="flex items-center gap-2 text-sm text-gray-500"><span>üìÑ</span> <span>Genera reportes
                            completos para enviar a tus pacientes</span></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Panel de Selecci√≥n -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">üéØ Seleccionar
                                Paciente</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Paciente *</label>
                                    <select id="report-patient-select"
                                        class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg"
                                        onchange="loadPatientData()">
                                        <option value="">Seleccionar paciente</option>
                                    </select>
                                </div>
                                <div id="patient-summary"
                                    class="hidden bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-200">
                                    <h4 class="font-semibold text-gray-800 mb-2">Resumen del Paciente</h4>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between"><span class="text-gray-600">Edad:</span> <span
                                                id="summary-edad" class="font-medium">-</span></div>
                                        <div class="flex justify-between"><span class="text-gray-600">IMC:</span> <span
                                                id="summary-imc" class="font-medium">-</span></div>
                                        <div class="flex justify-between"><span class="text-gray-600">Planes:</span>
                                            <span id="summary-planes" class="font-medium">-</span></div>
                                        <div class="flex justify-between"><span class="text-gray-600">Citas:</span>
                                            <span id="summary-citas" class="font-medium">-</span></div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <h4 class="font-semibold text-gray-700">Opciones del Reporte</h4>
                                    <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"
                                            id="include-personal" checked class="w-4 h-4 text-blue-600 rounded"> <span
                                            class="text-sm text-gray-700">Informaci√≥n Personal</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"
                                            id="include-metrics" checked class="w-4 h-4 text-blue-600 rounded"> <span
                                            class="text-sm text-gray-700">M√©tricas Corporales</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"
                                            id="include-plans" checked class="w-4 h-4 text-blue-600 rounded"> <span
                                            class="text-sm text-gray-700">Planes Nutricionales</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"
                                            id="include-appointments" checked class="w-4 h-4 text-blue-600 rounded">
                                        <span class="text-sm text-gray-700">Historial de Citas</span></label>
                                    <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"
                                            id="include-recommendations" checked class="w-4 h-4 text-blue-600 rounded">
                                        <span class="text-sm text-gray-700">Recomendaciones</span></label>
                                </div>

                                <button onclick="generateReport()" id="generate-btn"
                                    class="w-full btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:opacity-50"
                                    disabled>
                                    <span>üìÑ</span> <span>Generar Reporte</span>
                                </button>
                                <button onclick="downloadReport()" id="download-btn"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 hidden">
                                    <span>üíæ</span> <span>Descargar TXT</span>
                                </button>
                                <button onclick="copyReport()" id="copy-btn"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 hidden">
                                    <span>üìã</span> <span>Copiar Texto</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Vista Previa del Reporte -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                                <h3 class="text-xl font-bold flex items-center gap-2">üìã Vista Previa del Reporte</h3>
                                <p class="text-blue-100 mt-1">El reporte se generar√° en formato de texto plano</p>
                            </div>
                            <div class="p-6">
                                <div id="report-preview"
                                    class="bg-gray-50 rounded-lg p-6 font-mono text-sm whitespace-pre-wrap min-h-[500px] border-2 border-dashed border-gray-300">
                                    <div class="text-center text-gray-500 mt-20">
                                        <div class="text-4xl mb-4">üìÑ</div>
                                        <p class="text-lg font-medium">Selecciona un paciente para generar el reporte
                                        </p>
                                        <p class="text-sm mt-2">El reporte incluir√° toda la informaci√≥n relevante del
                                            tratamiento</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Asistente IA Section -->
            <div id="section-asistente" class="p-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Asistente IA Nutricional</h2>
                        <p class="text-gray-600 mt-2">Tu asistente inteligente para consultas nutricionales y an√°lisis
                            de pacientes</p>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div><span>IA Activa</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Panel de Acciones R√°pidas -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">‚ö° Acciones R√°pidas
                            </h3>
                            <div class="space-y-3">
                                <button onclick="quickAnalyzePatient()"
                                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-3 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all flex items-center gap-2"><span>üë§</span>
                                    <span>Analizar Paciente</span></button>
                                <button onclick="assistantGeneratePlan()"
                                    class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white px-4 py-3 rounded-lg font-medium hover:from-green-600 hover:to-teal-700 transition-all flex items-center gap-2"><span>üçΩÔ∏è</span>
                                    <span>Plan + Macros</span></button>
                                <button onclick="quickNutritionTips()"
                                    class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white px-4 py-3 rounded-lg font-medium hover:from-orange-600 hover:to-red-700 transition-all flex items-center gap-2"><span>üí°</span>
                                    <span>Tips Nutricionales</span></button>
                                <button onclick="quickFoodAnalysis()"
                                    class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-3 rounded-lg font-medium hover:from-purple-600 hover:to-pink-700 transition-all flex items-center gap-2"><span>üîç</span>
                                    <span>An√°lisis de Alimentos</span></button>
                                <button onclick="clearChat()"
                                    class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-all flex items-center gap-2"><span>üóëÔ∏è</span>
                                    <span>Limpiar Chat</span></button>
                            </div>

                            <!-- Selector de Paciente para An√°lisis -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="font-semibold text-gray-700 mb-3">Paciente para An√°lisis</h4>
                                <select id="ai-patient-select"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Seleccionar paciente</option>
                                </select>
                            </div>

                            <!-- Estad√≠sticas del Chat -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="font-semibold text-gray-700 mb-3">Estad√≠sticas</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between"><span class="text-gray-600">Consultas:</span>
                                        <span id="chat-count" class="font-medium">0</span></div>
                                    <div class="flex justify-between"><span class="text-gray-600">An√°lisis:</span> <span
                                            id="analysis-count" class="font-medium">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Interface -->
                    <div class="lg:col-span-3">
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden h-[700px] flex flex-col">
                            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                            <span class="text-2xl">ü§ñ</span></div>
                                        <div>
                                            <h3 class="text-xl font-bold">NutriBot</h3>
                                            <p class="text-blue-100 text-sm">Asistente Nutricional Inteligente</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm">
                                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div><span
                                            class="text-blue-100">En l√≠nea</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Messages -->
                            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                                <div class="flex items-start gap-3">
                                    <div
                                        class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                                        <span class="text-white text-sm">ü§ñ</span></div>
                                    <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
                                        <p class="text-gray-800">¬°Hola! Soy tu asistente nutricional inteligente. Puedo
                                            ayudarte con:</p>
                                        <ul class="mt-2 text-sm text-gray-600 space-y-1">
                                            <li>‚Ä¢ An√°lisis de pacientes y m√©tricas</li>
                                            <li>‚Ä¢ Recomendaciones nutricionales</li>
                                            <li>‚Ä¢ Planes de alimentaci√≥n personalizados (con macros y calor√≠as)</li>
                                            <li>‚Ä¢ Informaci√≥n sobre alimentos y nutrientes</li>
                                            <li>‚Ä¢ Interpretaci√≥n de datos corporales</li>
                                        </ul>
                                        <p class="mt-2 text-sm text-gray-600">¬øEn qu√© puedo ayudarte hoy?</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Chat Input -->
                            <div class="border-t border-gray-200 p-4 bg-white">
                                <form id="chat-form" class="flex gap-3">
                                    <input type="text" id="chat-input"
                                        placeholder="Escribe tu consulta nutricional aqu√≠..."
                                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                        autocomplete="off">
                                    <button type="submit" id="send-btn"
                                        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all flex items-center gap-2 disabled:opacity-50">
                                        <span id="send-icon">üì§</span> <span id="send-text">Enviar</span>
                                    </button>
                                </form>
                                <div class="mt-3">
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="sendSuggestion('¬øC√≥mo interpreto un IMC de 28.5?')"
                                            class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors">
                                            ¬øC√≥mo interpreto un IMC de 28.5? </button>
                                        <button onclick="sendSuggestion('Recomienda alimentos ricos en prote√≠na')"
                                            class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full hover:bg-green-200 transition-colors">
                                            Alimentos ricos en prote√≠na </button>
                                        <button onclick="sendSuggestion('Genera un plan con macros para mi paciente')"
                                            class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 transition-colors">
                                            Plan con macros </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas Section -->
            <div id="section-estadisticas" class="p-8 hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Estad√≠sticas</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Total Pacientes</p>
                                <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-total-patients">0</p>
                            </div>
                            <div class="text-4xl">üë•</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Citas Pendientes</p>
                                <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-pending-appointments">0</p>
                            </div>
                            <div class="text-4xl">üìÖ</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Planes Activos</p>
                                <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-active-plans">0</p>
                            </div>
                            <div class="text-4xl">üçé</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">IMC Promedio</p>
                                <p class="text-3xl font-bold text-gray-800 mt-2" id="stat-avg-imc">0</p>
                            </div>
                            <div class="text-4xl">üìä</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Distribuci√≥n por G√©nero</h3>
                        <div id="gender-stats" class="space-y-4"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Rangos de IMC</h3>
                        <div id="imc-stats" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const defaultConfig = {
            app_title: "Gesti√≥n Nutricional",
            clinic_name: "Mi Cl√≠nica Nutricional",
            primary_color: "#667eea",
            secondary_color: "#764ba2",
            background_color: "#f9fafb",
            text_color: "#1f2937",
            accent_color: "#3b82f6"
        };

        let allData = [];
        let currentSection = 'pacientes';
        let editingPatientId = null;
        let editingPlanId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Local Storage Management
        const STORAGE_KEY = 'nutricion_app_data';

        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            } catch (error) {
                showToast('Error al guardar datos localmente', 'error');
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    allData = JSON.parse(stored);
                    renderCurrentSection();
                }
            } catch (error) {
                showToast('Error al cargar datos locales', 'error');
                allData = [];
            }
        }

        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function onConfigChange(config) {
            const appTitle = config.app_title || defaultConfig.app_title;
            const clinicName = config.clinic_name || defaultConfig.clinic_name;
            document.getElementById('app-title').textContent = appTitle;
            document.getElementById('clinic-name').textContent = clinicName;
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.background_color || defaultConfig.background_color,
                        set: (value) => {
                            config.background_color = value;
                            window.elementSdk.setConfig({ background_color: value });
                        }
                    },
                    {
                        get: () => config.text_color || defaultConfig.text_color,
                        set: (value) => {
                            config.text_color = value;
                            window.elementSdk.setConfig({ text_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["app_title", config.app_title || defaultConfig.app_title],
                ["clinic_name", config.clinic_name || defaultConfig.clinic_name]
            ]);
        }

        async function init() {
            loadFromLocalStorage();
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }
        }

        function showSection(section) {
            currentSection = section;
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active'); el.classList.add('text-gray-700');
            });
            document.getElementById(`nav-${section}`).classList.add('active');
            document.getElementById(`nav-${section}`).classList.remove('text-gray-700');
            renderCurrentSection();
        }

        function renderCurrentSection() {
            switch (currentSection) {
                case 'pacientes': renderPatients(); break;
                case 'calendario': renderCalendar(); renderAppointments(); break;
                case 'planes': renderPlans(); break;
                case 'reportes': renderReports(); break;
                case 'asistente': renderAssistant(); break;
                case 'estadisticas': renderStatistics(); break;
            }
        }

        function getPatients() { return allData.filter(item => item.type === 'patient'); }
        function getAppointments() { return allData.filter(item => item.type === 'appointment'); }
        function getPlans() { return allData.filter(item => item.type === 'plan'); }

        function createRecord(data) {
            const newRecord = { ...data, id: generateId(), createdAt: new Date().toISOString() };
            allData.push(newRecord);
            saveToLocalStorage();
            renderCurrentSection();
            return newRecord;
        }

        function updateRecord(id, data) {
            const index = allData.findIndex(item => item.id === id);
            if (index !== -1) {
                allData[index] = { ...allData[index], ...data };
                saveToLocalStorage();
                renderCurrentSection();
                return allData[index];
            }
            return null;
        }

        function deleteRecord(id) {
            const index = allData.findIndex(item => item.id === id);
            if (index !== -1) {
                allData.splice(index, 1);
                saveToLocalStorage();
                renderCurrentSection();
                return true;
            }
            return false;
        }

        // =========================
        // C√ÅLCULOS CORPORO-ENERG√âTICOS
        // =========================
        function calculateMetrics(peso, altura, edad, genero, grasaCorporal = null) {
            const alturaM = altura / 100;
            const imc = peso / (alturaM * alturaM);

            let calculatedGrasaCorporal = grasaCorporal;
            if (!grasaCorporal) {
                if (genero === 'Masculino') { calculatedGrasaCorporal = (1.20 * imc) + (0.23 * edad) - 16.2; }
                else { calculatedGrasaCorporal = (1.20 * imc) + (0.23 * edad) - 5.4; }
                calculatedGrasaCorporal = Math.max(5, Math.min(50, calculatedGrasaCorporal));
            }
            const pesoSinGrasa = peso * (1 - calculatedGrasaCorporal / 100);

            // TMB Mifflin-St Jeor
            let tmb = 0;
            if (genero === 'Masculino') { tmb = 10 * peso + 6.25 * altura - 5 * edad + 5; }
            else { tmb = 10 * peso + 6.25 * altura - 5 * edad - 161; }

            const tmbPromedio = genero === 'Masculino' ? 1800 : 1400;
            const factorMetabolico = tmb / tmbPromedio;
            const edadMetabolica = Math.round(edad / factorMetabolico);

            const musculaturaEsqueletica = (pesoSinGrasa / peso) * (genero === 'Masculino' ? 45 : 38);
            const grasaSubcutanea = calculatedGrasaCorporal * 0.8;

            let grasaVisceral = 1;
            if (imc > 25) grasaVisceral += (imc - 25) * 0.5;
            if (edad > 40) grasaVisceral += (edad - 40) * 0.1;
            grasaVisceral = Math.min(20, Math.max(1, Math.round(grasaVisceral)));

            let aguaCorporal = genero === 'Masculino' ? 60 - (calculatedGrasaCorporal * 0.4) - (edad * 0.1)
                : 55 - (calculatedGrasaCorporal * 0.4) - (edad * 0.1);
            aguaCorporal = Math.max(45, Math.min(70, aguaCorporal));

            const masaMuscular = pesoSinGrasa * 0.75;
            let masaOsea = (altura / 100) * (altura / 100) * (genero === 'Masculino' ? 1.2 : 1.0);
            const proteina = (masaMuscular / peso) * 20;

            return {
                imc: Math.round(imc * 10) / 10,
                grasaCorporal: Math.round(calculatedGrasaCorporal * 10) / 10,
                pesoSinGrasa: Math.round(pesoSinGrasa * 10) / 10,
                tmb: Math.round(tmb),
                edadMetabolica: Math.max(18, Math.min(80, edadMetabolica)),
                musculaturaEsqueletica: Math.round(musculaturaEsqueletica * 10) / 10,
                grasaSubcutanea: Math.round(grasaSubcutanea * 10) / 10,
                grasaVisceral: grasaVisceral,
                aguaCorporal: Math.round(aguaCorporal * 10) / 10,
                masaMuscular: Math.round(masaMuscular * 10) / 10,
                masaOsea: Math.round(masaOsea * 10) / 10,
                proteina: Math.round(proteina * 10) / 10
            };
        }

        function getIMCCategory(imc) {
            if (imc < 18.5) return { text: 'Bajo peso', class: 'metric-warning' };
            if (imc < 25) return { text: 'Normal', class: 'metric-normal' };
            if (imc < 30) return { text: 'Sobrepeso', class: 'metric-warning' };
            return { text: 'Obesidad', class: 'metric-danger' };
        }

        function activityFactor(level) {
            switch (level) {
                case 'sedentaria': return 1.2;
                case 'ligera': return 1.375;
                case 'moderada': return 1.55;
                case 'intensa': return 1.725;
                default: return 1.375;
            }
        }

        function goalDelta(goal) {
            switch (goal) {
                case 'perdida': return -500;
                case 'ganancia': return +300;
                case 'mantenimiento':
                default: return 0;
            }
        }

        function calcEnergyTargets(tmb, level, goal) {
            const tdee = Math.round(tmb * activityFactor(level));
            const target = Math.max(1200, Math.round(tdee + goalDelta(goal))); // m√≠nimo de seguridad
            return { tdee, targetCalories: target };
        }

        // =========================
        // BASE DE DATOS SIMPLE DE ALIMENTOS (por 100 g)
        // =========================
        const foodDB = {
            "Avena": { kcal: 389, p: 16.9, c: 66.0, f: 6.9 },
            "Leche descremada (ml)": { kcal: 35, p: 3.4, c: 5.0, f: 0.2 }, // por 100 ml
            "Banana": { kcal: 89, p: 1.1, c: 23.0, f: 0.3 },
            "Almendras": { kcal: 579, p: 21.2, c: 21.7, f: 49.9 },
            "Pechuga de pollo": { kcal: 165, p: 31.0, c: 0.0, f: 3.6 },
            "Arroz integral cocido": { kcal: 111, p: 2.6, c: 23.0, f: 0.9 },
            "Aceite de oliva": { kcal: 884, p: 0.0, c: 0.0, f: 100.0 },
            "Verduras mixtas": { kcal: 35, p: 2.0, c: 7.0, f: 0.5 },
            "Salm√≥n": { kcal: 208, p: 20.0, c: 0.0, f: 13.0 },
            "Batata cocida": { kcal: 90, p: 2.0, c: 21.0, f: 0.1 },
            "Br√≥coli": { kcal: 34, p: 2.8, c: 7.0, f: 0.4 },
            "Yogur griego": { kcal: 59, p: 10.0, c: 3.4, f: 0.9 },
            "Manzana": { kcal: 52, p: 0.3, c: 14.0, f: 0.2 },
            "Nuez": { kcal: 654, p: 15.0, c: 14.0, f: 65.0 },
            "Pan integral": { kcal: 247, p: 13.0, c: 41.0, f: 4.2 },
            "Quinoa cocida": { kcal: 120, p: 4.4, c: 21.3, f: 1.9 },
            "Tofu": { kcal: 76, p: 8.0, c: 1.9, f: 4.8 }
        };

        function nutritionFor(item, grams, isLiquid = false) {
            // isLiquid true => gramos equivalen a mililitros para bases l√≠quidas (100 ml referencia)
            const base = foodDB[item];
            if (!base) return { kcal: 0, p: 0, c: 0, f: 0 };
            const factor = (grams || 0) / 100;
            return {
                kcal: base.kcal * factor,
                p: base.p * factor,
                c: base.c * factor,
                f: base.f * factor
            };
        }

        function sumNutri(list) {
            return list.reduce((acc, it) => {
                acc.kcal += it.kcal; acc.p += it.p; acc.c += it.c; acc.f += it.f; return acc;
            }, { kcal: 0, p: 0, c: 0, f: 0 });
        }

        function roundNutri(n) { return { kcal: Math.round(n.kcal), p: Math.round(n.p), c: Math.round(n.c), f: Math.round(n.f) }; }

        // =========================
        // C√ÅLCULO DE MACROS DIARIOS
        // =========================
        function computeMacrosForPatient(patient, overrideCalories = null) {
            // Prote√≠nas por kg seg√∫n objetivo
            const goal = patient.objetivoDieta || 'mantenimiento';
            const kg = patient.peso;
            let gPerKg = 1.6;
            if (goal === 'perdida') gPerKg = 1.8;
            if (goal === 'ganancia') gPerKg = 2.0;

            const protein_g = Math.round(kg * gPerKg);

            // Grasas ~30% de calor√≠as objetivo
            const energyTargets = calcEnergyTargets(patient.tmb || 1500, patient.actividad || 'ligera', goal);
            const cals = overrideCalories || energyTargets.targetCalories;
            const fat_kcal = Math.round(cals * 0.30);
            const fat_g = Math.round(fat_kcal / 9);

            // Carbos = resto
            const remaining_kcal = cals - (protein_g * 4) - (fat_g * 9);
            const carbs_g = Math.max(0, Math.round(remaining_kcal / 4));

            return {
                calories: cals,
                protein_g: protein_g,
                fat_g: fat_g,
                carbs_g: carbs_g,
                protein_pct: Math.round((protein_g * 4) / cals * 100),
                fat_pct: Math.round((fat_g * 9) / cals * 100),
                carbs_pct: Math.round((carbs_g * 4) / cals * 100)
            };
        }

        // =========================
        // GENERADOR DE MEN√ö EN BASE A MACROS (plantillas escalables)
        // =========================
        function defaultMealTemplates() {
            return {
                desayuno: [
                    { name: "Avena", grams: 60 },
                    { name: "Leche descremada (ml)", grams: 250 },
                    { name: "Banana", grams: 120 },
                    { name: "Almendras", grams: 15 }
                ],
                colacionAM: [
                    { name: "Yogur griego", grams: 170 },
                    { name: "Manzana", grams: 150 },
                    { name: "Nuez", grams: 15 }
                ],
                almuerzo: [
                    { name: "Pechuga de pollo", grams: 150 },
                    { name: "Arroz integral cocido", grams: 150 },
                    { name: "Verduras mixtas", grams: 200 },
                    { name: "Aceite de oliva", grams: 10 }
                ],
                colacionPM: [
                    { name: "Pan integral", grams: 60 },
                    { name: "Yogur griego", grams: 120 }
                ],
                cena: [
                    { name: "Salm√≥n", grams: 120 },
                    { name: "Batata cocida", grams: 180 },
                    { name: "Br√≥coli", grams: 150 },
                    { name: "Aceite de oliva", grams: 5 }
                ]
            };
        }

        function mealTotals(items) {
            const parts = items.map(it => {
                const isLiquid = it.name.includes('(ml)');
                return nutritionFor(it.name, it.grams, isLiquid);
            });
            const sum = sumNutri(parts);
            return roundNutri(sum);
        }

        function scaleMeal(items, scale) {
            return items.map(it => ({ ...it, grams: Math.max(1, Math.round(it.grams * scale)) }));
        }

        function generatePlanFromMacros(macros) {
            // distribuci√≥n por comida
            const splits = { desayuno: 0.25, almuerzo: 0.35, cena: 0.25, snacks: 0.15 };
            const tpl = defaultMealTemplates();

            // Calcula kcal base por plantilla
            const base = {
                desayuno: mealTotals(tpl.desayuno).kcal,
                colacionAM: mealTotals(tpl.colacionAM).kcal,
                almuerzo: mealTotals(tpl.almuerzo).kcal,
                colacionPM: mealTotals(tpl.colacionPM).kcal,
                cena: mealTotals(tpl.cena).kcal
            };

            const target = {
                desayuno: macros.calories * splits.desayuno,
                almuerzo: macros.calories * splits.almuerzo,
                cena: macros.calories * splits.cena,
                // snacks: dividir 50/50 entre colaciones
                colacionAM: macros.calories * splits.snacks * 0.5,
                colacionPM: macros.calories * splits.snacks * 0.5
            };

            const scaled = {
                desayuno: scaleMeal(tpl.desayuno, target.desayuno / base.desayuno),
                colacionAM: scaleMeal(tpl.colacionAM, target.colacionAM / base.colacionAM),
                almuerzo: scaleMeal(tpl.almuerzo, target.almuerzo / base.almuerzo),
                colacionPM: scaleMeal(tpl.colacionPM, target.colacionPM / base.colacionPM),
                cena: scaleMeal(tpl.cena, target.cena / base.cena)
            };

            const totals = {
                desayuno: mealTotals(scaled.desayuno),
                colacionAM: mealTotals(scaled.colacionAM),
                almuerzo: mealTotals(scaled.almuerzo),
                colacionPM: mealTotals(scaled.colacionPM),
                cena: mealTotals(scaled.cena)
            };

            const dayTotals = roundNutri({
                kcal: totals.desayuno.kcal + totals.colacionAM.kcal + totals.almuerzo.kcal + totals.colacionPM.kcal + totals.cena.kcal,
                p: totals.desayuno.p + totals.colacionAM.p + totals.almuerzo.p + totals.colacionPM.p + totals.cena.p,
                c: totals.desayuno.c + totals.colacionAM.c + totals.almuerzo.c + totals.colacionPM.c + totals.cena.c,
                f: totals.desayuno.f + totals.colacionAM.f + totals.almuerzo.f + totals.colacionPM.f + totals.cena.f
            });

            const toLines = (arr) => arr.map(it => `‚Ä¢ ${it.name}: ${it.grams} g`).join('\n');

            const textPlan = {
                desayuno: toLines(scaled.desayuno),
                colacionMatutina: toLines(scaled.colacionAM),
                almuerzo: toLines(scaled.almuerzo),
                colacionVespertina: toLines(scaled.colacionPM),
                cena: toLines(scaled.cena)
            };

            return {
                items: scaled,
                mealsTotals: totals,
                dayTotals,
                textPlan
            };
        }

        // =========================
        // PACIENTES (render / CRUD)
        // =========================
        function renderPatients() {
            const patients = getPatients();
            const container = document.getElementById('patients-list');
            if (patients.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üë§</div>
                        <p class="text-gray-500 text-lg">No hay pacientes registrados</p>
                        <p class="text-gray-400 text-sm mt-2">Comienza agregando tu primer paciente</p>
                    </div>`;
                return;
            }
            container.innerHTML = patients.map(patient => {
                const imcCategory = getIMCCategory(patient.imc);
                return `
                    <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow cursor-pointer" onclick="showPatientDetail('${patient.id}')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${patient.nombre}</h3>
                                <p class="text-gray-500 text-sm">${patient.edad} a√±os ‚Ä¢ ${patient.genero}</p>
                            </div>
                            <span class="metric-badge ${imcCategory.class}">IMC: ${patient.imc}</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600">Peso:</span><span class="font-semibold">${patient.peso} kg</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Altura:</span><span class="font-semibold">${patient.altura} cm</span></div>
                            ${patient.grasaCorporal ? `<div class="flex justify-between"><span class="text-gray-600">Grasa Corporal:</span><span class="font-semibold">${patient.grasaCorporal}%</span></div>` : ''}
                            ${patient.caloriasObjetivo ? `<div class="flex justify-between"><span class="text-gray-600">Calor√≠as Objetivo:</span><span class="font-semibold">${patient.caloriasObjetivo} kcal</span></div>` : ''}
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 flex gap-2">
                            <button onclick="event.stopPropagation(); editPatient('${patient.id}')" class="flex-1 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 text-sm font-medium">‚úèÔ∏è Editar</button>
                            <button onclick="event.stopPropagation(); deletePatient('${patient.id}')" class="flex-1 px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm font-medium">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function showPatientDetail(patientId) {
            const patient = allData.find(p => p.id === patientId);
            if (!patient) return;
            const imcCategory = getIMCCategory(patient.imc);
            document.getElementById('detail-patient-name').textContent = patient.nombre;
            const energy = calcEnergyTargets(patient.tmb, patient.actividad || 'ligera', patient.objetivoDieta || 'mantenimiento');
            document.getElementById('patient-detail-content').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Informaci√≥n Personal</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Edad:</span><span class="font-semibold">${patient.edad} a√±os</span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">G√©nero:</span><span class="font-semibold">${patient.genero}</span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Actividad:</span><span class="font-semibold capitalize">${patient.actividad || 'ligera'}</span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Objetivo:</span><span class="font-semibold capitalize">${patient.objetivoDieta || 'mantenimiento'}</span></div>
                            ${patient.telefono ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Tel√©fono:</span><span class="font-semibold">${patient.telefono}</span></div>` : ''}
                            ${patient.email ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Email:</span><span class="font-semibold">${patient.email}</span></div>` : ''}
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Medidas B√°sicas</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Peso:</span><span class="font-semibold">${patient.peso} kg</span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Altura:</span><span class="font-semibold">${patient.altura} cm</span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">IMC:</span><span class="font-semibold">${patient.imc} <span class="metric-badge ${imcCategory.class} ml-2">${imcCategory.text}</span></span></div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Composici√≥n Corporal</h4>
                        <div class="space-y-2 text-sm">
                            ${patient.grasaCorporal ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Grasa Corporal:</span><span class="font-semibold">${patient.grasaCorporal}%</span></div>` : ''}
                            ${patient.musculaturaEsqueletica ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Musculatura Esquel√©tica:</span><span class="font-semibold">${patient.musculaturaEsqueletica}%</span></div>` : ''}
                            ${patient.pesoSinGrasa ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Peso sin Grasa:</span><span class="font-semibold">${patient.pesoSinGrasa} kg</span></div>` : ''}
                            ${patient.grasaSubcutanea ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Grasa Subcut√°nea:</span><span class="font-semibold">${patient.grasaSubcutanea}%</span></div>` : ''}
                            ${patient.grasaVisceral ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Grasa Visceral:</span><span class="font-semibold">Nivel ${patient.grasaVisceral}</span></div>` : ''}
                            ${patient.aguaCorporal ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Agua Corporal:</span><span class="font-semibold">${patient.aguaCorporal}%</span></div>` : ''}
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Energ√≠a y Otros</h4>
                        <div class="space-y-2 text-sm">
                            ${patient.masaMuscular ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Masa Muscular:</span><span class="font-semibold">${patient.masaMuscular} kg</span></div>` : ''}
                            ${patient.masaOsea ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Masa √ìsea:</span><span class="font-semibold">${patient.masaOsea} kg</span></div>` : ''}
                            ${patient.proteina ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Prote√≠na:</span><span class="font-semibold">${patient.proteina}%</span></div>` : ''}
                            ${patient.tmb ? `<div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">TMB:</span><span class="font-semibold">${patient.tmb} kcal/d√≠a</span></div>` : ''}
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">TDEE:</span><span class="font-semibold">${energy.tdee} kcal/d√≠a</span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-600">Cal. Objetivo:</span><span class="font-semibold">${energy.targetCalories} kcal/d√≠a</span></div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('patient-detail-container').classList.remove('hidden');
        }

        function closePatientDetail() {
            document.getElementById('patient-detail-container').classList.add('hidden');
        }

        function showAddPatientForm() {
            editingPatientId = null;
            document.getElementById('form-title').textContent = 'Nuevo Paciente';
            document.getElementById('patient-form').reset();
            document.getElementById('metrics-preview').classList.add('hidden');
            document.getElementById('advanced-preview').classList.add('hidden');
            document.getElementById('advanced-toggle-text').textContent = 'Ver m√°s detalles ‚ñº';
            document.getElementById('patient-form-container').classList.remove('hidden');
            setTimeout(() => { setupRealtimeCalculation(); }, 100);
        }

        function editPatient(patientId) {
            const patient = allData.find(p => p.id === patientId);
            if (!patient) return;
            editingPatientId = patientId;
            document.getElementById('form-title').textContent = 'Editar Paciente';
            document.getElementById('input-nombre').value = patient.nombre;
            document.getElementById('input-edad').value = patient.edad;
            document.getElementById('input-genero').value = patient.genero;
            document.getElementById('input-altura').value = patient.altura;
            document.getElementById('input-peso').value = patient.peso;
            document.getElementById('input-grasa').value = patient.grasaCorporal || '';
            document.getElementById('input-musculatura').value = patient.musculaturaEsqueletica || '';
            document.getElementById('input-grasa-subcutanea').value = patient.grasaSubcutanea || '';
            document.getElementById('input-grasa-visceral').value = patient.grasaVisceral || '';
            document.getElementById('input-agua').value = patient.aguaCorporal || '';
            document.getElementById('input-masa-muscular').value = patient.masaMuscular || '';
            document.getElementById('input-masa-osea').value = patient.masaOsea || '';
            document.getElementById('input-proteina').value = patient.proteina || '';
            document.getElementById('input-telefono').value = patient.telefono || '';
            document.getElementById('input-email').value = patient.email || '';
            document.getElementById('input-actividad').value = patient.actividad || 'ligera';
            document.getElementById('input-objetivo-dieta').value = patient.objetivoDieta || 'mantenimiento';
            document.getElementById('patient-form-container').classList.remove('hidden');
        }

        function closePatientForm() {
            document.getElementById('patient-form-container').classList.add('hidden');
            editingPatientId = null;
        }

        function deletePatient(patientId) {
            const deleteBtn = event.target;
            const originalText = deleteBtn.innerHTML;
            if (deleteBtn.dataset.confirming === 'true') {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '‚è≥ Eliminando...';
                const success = deleteRecord(patientId);
                if (success) showToast('Paciente eliminado correctamente', 'success');
                else { showToast('Error al eliminar el paciente', 'error'); deleteBtn.disabled = false; deleteBtn.innerHTML = originalText; }
                delete deleteBtn.dataset.confirming;
            } else {
                deleteBtn.dataset.confirming = 'true';
                deleteBtn.innerHTML = '‚úì Confirmar';
                deleteBtn.classList.remove('bg-red-50', 'text-red-600', 'hover:bg-red-100');
                deleteBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                setTimeout(() => {
                    if (deleteBtn.dataset.confirming === 'true') {
                        delete deleteBtn.dataset.confirming;
                        deleteBtn.innerHTML = originalText;
                        deleteBtn.classList.add('bg-red-50', 'text-red-600', 'hover:bg-red-100');
                        deleteBtn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-700');
                    }
                }, 3000);
            }
        }

        document.getElementById('patient-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('save-btn-text');
            const spinner = document.getElementById('save-spinner');
            submitBtn.disabled = true;
            btnText.textContent = editingPatientId ? 'Actualizando...' : 'Guardando...';
            spinner.classList.remove('hidden');

            setTimeout(() => {
                const peso = parseFloat(document.getElementById('input-peso').value);
                const altura = parseFloat(document.getElementById('input-altura').value);
                const edad = parseInt(document.getElementById('input-edad').value);
                const genero = document.getElementById('input-genero').value;
                const grasaCorporalManual = parseFloat(document.getElementById('input-grasa').value) || null;
                const metrics = calculateMetrics(peso, altura, edad, genero, grasaCorporalManual);

                const actividad = document.getElementById('input-actividad').value;
                const objetivoDieta = document.getElementById('input-objetivo-dieta').value;
                const energy = calcEnergyTargets(metrics.tmb, actividad, objetivoDieta);

                const patientData = {
                    type: 'patient',
                    nombre: document.getElementById('input-nombre').value,
                    edad, genero, altura, peso,
                    imc: metrics.imc,
                    grasaCorporal: metrics.grasaCorporal,
                    musculaturaEsqueletica: parseFloat(document.getElementById('input-musculatura').value) || metrics.musculaturaEsqueletica,
                    pesoSinGrasa: metrics.pesoSinGrasa,
                    grasaSubcutanea: parseFloat(document.getElementById('input-grasa-subcutanea').value) || metrics.grasaSubcutanea,
                    grasaVisceral: parseFloat(document.getElementById('input-grasa-visceral').value) || metrics.grasaVisceral,
                    aguaCorporal: parseFloat(document.getElementById('input-agua').value) || metrics.aguaCorporal,
                    masaMuscular: parseFloat(document.getElementById('input-masa-muscular').value) || metrics.masaMuscular,
                    masaOsea: parseFloat(document.getElementById('input-masa-osea').value) || metrics.masaOsea,
                    proteina: parseFloat(document.getElementById('input-proteina').value) || metrics.proteina,
                    tmb: metrics.tmb,
                    edadMetabolica: metrics.edadMetabolica,
                    actividad: actividad,
                    objetivoDieta: objetivoDieta,
                    tdee: energy.tdee,
                    caloriasObjetivo: energy.targetCalories,
                    telefono: document.getElementById('input-telefono').value,
                    email: document.getElementById('input-email').value
                };

                try {
                    if (editingPatientId) {
                        updateRecord(editingPatientId, patientData);
                        showToast('Paciente actualizado correctamente', 'success');
                    } else {
                        createRecord(patientData);
                        showToast('Paciente registrado correctamente', 'success');
                    }
                    closePatientForm();
                } catch (error) {
                    showToast('Error al guardar el paciente', 'error');
                }
                submitBtn.disabled = false;
                btnText.textContent = 'Guardar Paciente';
                spinner.classList.add('hidden');
            }, 400);
        });

        // =========================
        // CALENDARIO Y CITAS
        // =========================
        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const appointments = getAppointments();
            const appointmentsByDate = {};
            appointments.forEach(appointment => {
                if (!appointmentsByDate[appointment.fecha]) appointmentsByDate[appointment.fecha] = [];
                appointmentsByDate[appointment.fecha].push(appointment);
            });

            let calendarHTML = '';
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                calendarHTML += `<div class="calendar-day other-month cursor-default"><span class="calendar-day-number">${day}</span></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = appointmentsByDate[dateStr] || [];
                const hasAppointments = dayAppointments.length > 0;
                const isToday = new Date().toDateString() === new Date(currentYear, currentMonth, day).toDateString();
                let dayClasses = 'calendar-day cursor-pointer';
                if (hasAppointments) dayClasses += ' has-appointment';
                if (isToday) dayClasses += ' today';
                let appointmentIndicators = '';
                if (hasAppointments) {
                    appointmentIndicators = dayAppointments.length <= 3
                        ? dayAppointments.map(() => '<div class="calendar-appointment-dot"></div>').join('')
                        : `<div class="calendar-appointment-count">${dayAppointments.length}</div>`;
                }
                calendarHTML += `
                    <div class="${dayClasses}" onclick="selectDate('${dateStr}')" title="${hasAppointments ? `${dayAppointments.length} cita(s) programada(s)` : 'Haz clic para agendar una cita'}">
                        <span class="calendar-day-number">${day}</span>
                        <div class="flex flex-wrap justify-center items-center gap-1 mt-1">${appointmentIndicators}</div>
                    </div>`;
            }
            const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                calendarHTML += `<div class="calendar-day other-month cursor-default"><span class="calendar-day-number">${day}</span></div>`;
            }
            document.getElementById('calendar-days').innerHTML = calendarHTML;
        }

        function previousMonth() { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); }
        function nextMonth() { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); }
        function selectDate(dateStr) { document.getElementById('input-fecha').value = dateStr; showAddAppointmentForm(); }

        function renderAppointments() {
            const appointments = getAppointments().sort((a, b) => new Date(a.fecha + 'T' + a.hora) - new Date(b.fecha + 'T' + b.hora));
            const container = document.getElementById('appointments-list');
            const now = new Date();
            const upcomingAppointments = appointments.filter(a => new Date(a.fecha + 'T' + a.hora) >= now);
            document.getElementById('upcoming-count').textContent = upcomingAppointments.length;
            if (upcomingAppointments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-2xl text-gray-400">üìÖ</span></div>
                        <p class="text-gray-500 text-lg font-medium">No hay citas programadas</p>
                        <p class="text-gray-400 text-sm mt-2">Las pr√≥ximas citas aparecer√°n aqu√≠</p>
                    </div>`; return;
            }
            container.innerHTML = upcomingAppointments.slice(0, 8).map((appointment, index) => {
                const patient = allData.find(p => p.id === appointment.pacienteId);
                const patientName = patient ? patient.nombre : 'Paciente no encontrado';
                const appointmentDate = new Date(appointment.fecha + 'T' + appointment.hora);
                const isToday = appointmentDate.toDateString() === now.toDateString();
                const isTomorrow = appointmentDate.toDateString() === new Date(now.getTime() + 24 * 60 * 60 * 1000).toDateString();
                let dateLabel = appointment.fecha;
                if (isToday) dateLabel = 'Hoy';
                else if (isTomorrow) dateLabel = 'Ma√±ana';
                const timeUntil = Math.ceil((appointmentDate - now) / (1000 * 60 * 60 * 24));
                let urgencyClass = ''; let urgencyIcon = 'üìÖ';
                if (isToday) { urgencyClass = 'border-l-4 border-l-red-500 bg-red-50'; urgencyIcon = 'üî•'; }
                else if (isTomorrow) { urgencyClass = 'border-l-4 border-l-orange-500 bg-orange-50'; urgencyIcon = '‚ö°'; }
                else if (timeUntil <= 7) { urgencyClass = 'border-l-4 border-l-yellow-500 bg-yellow-50'; urgencyIcon = '‚è∞'; }
                else { urgencyClass = 'border-l-4 border-l-blue-500 bg-blue-50'; }
                return `
                    <div class="group relative bg-white border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all duration-300 ${urgencyClass}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start gap-3 flex-1">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <span class="text-white text-sm font-bold">${index + 1}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-semibold text-gray-800 truncate">${patientName}</h4>
                                        <span class="text-lg">${urgencyIcon}</span>
                                    </div>
                                    <div class="flex items-center gap-4 text-sm text-gray-600 mb-2">
                                        <div class="flex items-center gap-1"><span>üìÖ</span><span class="font-medium">${dateLabel}</span></div>
                                        <div class="flex items-center gap-1"><span>‚è∞</span><span class="font-medium">${appointment.hora}</span></div>
                                    </div>
                                    ${appointment.motivo ? `<p class="text-sm text-gray-500 bg-gray-50 rounded-lg px-3 py-2 mt-2">üí¨ ${appointment.motivo}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                ${timeUntil <= 1 ? `<span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full">${isToday ? 'HOY' : 'MA√ëANA'}</span>`
                        : timeUntil <= 7 ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full">${timeUntil} d√≠as</span>` : ''}
                                <button onclick="deleteAppointment('${appointment.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
            if (upcomingAppointments.length > 8) {
                container.innerHTML += `<div class="text-center pt-4 border-t border-gray-200"><p class="text-sm text-gray-500">Y ${upcomingAppointments.length - 8} citas m√°s programadas</p></div>`;
            }
        }

        function showAddAppointmentForm() {
            const patients = getPatients();
            const select = document.getElementById('input-paciente-cita');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            document.getElementById('appointment-form').reset();
            document.getElementById('appointment-form-container').classList.remove('hidden');
        }
        function closeAppointmentForm() { document.getElementById('appointment-form-container').classList.add('hidden'); }
        function deleteAppointment(appointmentId) {
            const deleteBtn = event.target;
            const originalText = deleteBtn.innerHTML;
            if (deleteBtn.dataset.confirming === 'true') {
                deleteBtn.disabled = true; deleteBtn.innerHTML = '‚è≥';
                const success = deleteRecord(appointmentId);
                if (success) showToast('Cita eliminada correctamente', 'success');
                else { showToast('Error al eliminar la cita', 'error'); deleteBtn.disabled = false; deleteBtn.innerHTML = originalText; }
                delete deleteBtn.dataset.confirming;
            } else {
                deleteBtn.dataset.confirming = 'true'; deleteBtn.innerHTML = '‚úì';
                setTimeout(() => { if (deleteBtn.dataset.confirming === 'true') { delete deleteBtn.dataset.confirming; deleteBtn.innerHTML = originalText; } }, 3000);
            }
        }

        document.getElementById('appointment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('save-appointment-btn-text');
            const spinner = document.getElementById('save-appointment-spinner');
            submitBtn.disabled = true; btnText.textContent = 'Guardando...'; spinner.classList.remove('hidden');
            setTimeout(() => {
                const appointmentData = {
                    type: 'appointment',
                    pacienteId: document.getElementById('input-paciente-cita').value,
                    fecha: document.getElementById('input-fecha').value,
                    hora: document.getElementById('input-hora').value,
                    motivo: document.getElementById('input-motivo').value,
                    estado: 'pendiente'
                };
                try { createRecord(appointmentData); showToast('Cita registrada correctamente', 'success'); closeAppointmentForm(); }
                catch (error) { showToast('Error al guardar la cita', 'error'); }
                submitBtn.disabled = false; btnText.textContent = 'Guardar Cita'; spinner.classList.add('hidden');
            }, 400);
        });

        // =========================
        // PLANES
        // =========================
        function renderPlans() {
            const plans = getPlans();
            const container = document.getElementById('plans-list');
            if (plans.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üçé</div>
                        <p class="text-gray-500 text-lg">No hay planes nutricionales</p>
                        <p class="text-gray-400 text-sm mt-2">Crea el primer plan para tus pacientes</p>
                    </div>`; return;
            }
            container.innerHTML = plans.map(plan => {
                const patient = allData.find(p => p.id === plan.pacienteId);
                const patientName = patient ? patient.nombre : 'Paciente no encontrado';
                const macrosTag = plan.caloriasObjetivo ? `
                  <div class="flex flex-wrap gap-2 mt-3 text-xs">
                    <span class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full">üéØ ${plan.caloriasObjetivo} kcal</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full">P: ${plan.prot_g || 0} g</span>
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">C: ${plan.carb_g || 0} g</span>
                    <span class="px-2 py-1 bg-rose-100 text-rose-800 rounded-full">G: ${plan.fat_g || 0} g</span>
                  </div>` : '';
                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold">${patientName}</h3>
                                    <p class="text-green-100 mt-1">üéØ ${plan.objetivo || 'Plan'}</p>
                                    <p class="text-xs text-green-200 mt-2">Plan creado: ${new Date(plan.createdAt).toLocaleDateString()}</p>
                                    ${macrosTag}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editPlan('${plan.id}')" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition-colors">‚úèÔ∏è</button>
                                    <button onclick="deletePlan('${plan.id}')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg transition-colors">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-6">
                            <div class="mb-6">
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">üçΩÔ∏è Plan Nutricional Diario</h4>
                                <div class="grid grid-cols-1 gap-4">
                                  ${plan.desayuno ? `<div class="bg-orange-50 border-l-4 border-orange-400 p-4 rounded-r-lg"><div class="flex items-center gap-2 mb-2"><span class="text-lg">üåÖ</span><h5 class="font-semibold text-gray-700">Desayuno</h5><span class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded-full">7:00 - 9:00 AM</span></div><p class="text-sm text-gray-600 whitespace-pre-line">${plan.desayuno}</p></div>` : ''}
                                  ${plan.colacionMatutina ? `<div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg"><div class="flex items-center gap-2 mb-2"><span class="text-lg">ü•§</span><h5 class="font-semibold text-gray-700">Colaci√≥n Matutina</h5><span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full">10:00 - 11:00 AM</span></div><p class="text-sm text-gray-600 whitespace-pre-line">${plan.colacionMatutina}</p></div>` : ''}
                                  ${plan.almuerzo ? `<div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg"><div class="flex items-center gap-2 mb-2"><span class="text-lg">üçΩÔ∏è</span><h5 class="font-semibold text-gray-700">Almuerzo</h5><span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full">12:00 - 2:00 PM</span></div><p class="text-sm text-gray-600 whitespace-pre-line">${plan.almuerzo}</p></div>` : ''}
                                  ${plan.colacionVespertina ? `<div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded-r-lg"><div class="flex items-center gap-2 mb-2"><span class="text-lg">ü•®</span><h5 class="font-semibold text-gray-700">Colaci√≥n Vespertina</h5><span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full">4:00 - 5:00 PM</span></div><p class="text-sm text-gray-600 whitespace-pre-line">${plan.colacionVespertina}</p></div>` : ''}
                                  ${plan.cena ? `<div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-r-lg"><div class="flex items-center gap-2 mb-2"><span class="text-lg">üåô</span><h5 class="font-semibold text-gray-700">Cena</h5><span class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded-full">7:00 - 9:00 PM</span></div><p class="text-sm text-gray-600 whitespace-pre-line">${plan.cena}</p></div>` : ''}
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                              ${plan.hidratacion ? `<div class="bg-cyan-50 rounded-lg p-3"><h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">üíß Hidrataci√≥n</h5><p class="text-sm text-gray-600">${plan.hidratacion}</p></div>` : ''}
                              ${plan.ejercicio ? `<div class="bg-yellow-50 rounded-lg p-3"><h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">üèÉ‚Äç‚ôÄÔ∏è Actividad F√≠sica</h5><p class="text-sm text-gray-600">${plan.ejercicio}</p></div>` : ''}
                            </div>

                            ${plan.notas ? `<div class="bg-gray-50 rounded-lg p-4 mb-4"><h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">üìù Notas y Restricciones</h5><p class="text-sm text-gray-600">${plan.notas}</p></div>` : ''}
                            ${plan.recomendaciones ? `<div class="bg-amber-50 border border-amber-200 rounded-lg p-4"><h5 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">‚ö†Ô∏è Recomendaciones Especiales</h5><p class="text-sm text-gray-600">${plan.recomendaciones}</p></div>` : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        function showAddPlanForm() {
            editingPlanId = null;
            document.getElementById('plan-form-title').textContent = 'Nuevo Plan Nutricional';
            const patients = getPatients();
            const select = document.getElementById('input-paciente-plan');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            document.getElementById('plan-form').reset();
            document.getElementById('plan-form-container').classList.remove('hidden');
        }

        function editPlan(planId) {
            const plan = allData.find(p => p.id === planId);
            if (!plan) return;
            editingPlanId = planId;
            document.getElementById('plan-form-title').textContent = 'Editar Plan Nutricional';
            const patients = getPatients();
            const select = document.getElementById('input-paciente-plan');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            document.getElementById('input-paciente-plan').value = plan.pacienteId;
            document.getElementById('input-objetivo').value = plan.objetivo || '';
            document.getElementById('input-calorias-objetivo-plan').value = plan.caloriasObjetivo || '';
            document.getElementById('input-prot-g').value = plan.prot_g || '';
            document.getElementById('input-carb-g').value = plan.carb_g || '';
            document.getElementById('input-fat-g').value = plan.fat_g || '';
            document.getElementById('input-desayuno').value = plan.desayuno || '';
            document.getElementById('input-colacion-matutina').value = plan.colacionMatutina || '';
            document.getElementById('input-almuerzo').value = plan.almuerzo || '';
            document.getElementById('input-colacion-vespertina').value = plan.colacionVespertina || '';
            document.getElementById('input-cena').value = plan.cena || '';
            document.getElementById('input-hidratacion').value = plan.hidratacion || '';
            document.getElementById('input-ejercicio').value = plan.ejercicio || '';
            document.getElementById('input-notas').value = plan.notas || '';
            document.getElementById('input-recomendaciones').value = plan.recomendaciones || '';
            document.getElementById('plan-form-container').classList.remove('hidden');
        }

        function closePlanForm() { document.getElementById('plan-form-container').classList.add('hidden'); editingPlanId = null; }

        function deletePlan(planId) {
            const deleteBtn = event.target;
            const originalText = deleteBtn.innerHTML;
            if (deleteBtn.dataset.confirming === 'true') {
                deleteBtn.disabled = true; deleteBtn.innerHTML = '‚è≥';
                const success = deleteRecord(planId);
                if (success) showToast('Plan eliminado correctamente', 'success');
                else { showToast('Error al eliminar el plan', 'error'); deleteBtn.disabled = false; deleteBtn.innerHTML = originalText; }
                delete deleteBtn.dataset.confirming;
            } else {
                deleteBtn.dataset.confirming = 'true'; deleteBtn.innerHTML = '‚úì';
                setTimeout(() => { if (deleteBtn.dataset.confirming === 'true') { delete deleteBtn.dataset.confirming; deleteBtn.innerHTML = originalText; } }, 3000);
            }
        }

        document.getElementById('plan-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('save-plan-btn-text');
            const spinner = document.getElementById('save-plan-spinner');
            submitBtn.disabled = true; btnText.textContent = editingPlanId ? 'Actualizando...' : 'Guardando...'; spinner.classList.remove('hidden');

            setTimeout(() => {
                const planData = {
                    type: 'plan',
                    pacienteId: document.getElementById('input-paciente-plan').value,
                    objetivo: document.getElementById('input-objetivo').value,
                    caloriasObjetivo: parseInt(document.getElementById('input-calorias-objetivo-plan').value) || null,
                    prot_g: parseInt(document.getElementById('input-prot-g').value) || null,
                    carb_g: parseInt(document.getElementById('input-carb-g').value) || null,
                    fat_g: parseInt(document.getElementById('input-fat-g').value) || null,
                    desayuno: document.getElementById('input-desayuno').value,
                    colacionMatutina: document.getElementById('input-colacion-matutina').value,
                    almuerzo: document.getElementById('input-almuerzo').value,
                    colacionVespertina: document.getElementById('input-colacion-vespertina').value,
                    cena: document.getElementById('input-cena').value,
                    hidratacion: document.getElementById('input-hidratacion').value,
                    ejercicio: document.getElementById('input-ejercicio').value,
                    notas: document.getElementById('input-notas').value,
                    recomendaciones: document.getElementById('input-recomendaciones').value,
                    createdAt: new Date().toISOString()
                };
                try {
                    if (editingPlanId) { updateRecord(editingPlanId, planData); showToast('Plan nutricional actualizado correctamente', 'success'); }
                    else { createRecord(planData); showToast('Plan nutricional guardado correctamente', 'success'); }
                    closePlanForm();
                } catch (error) { showToast('Error al guardar el plan', 'error'); }
                submitBtn.disabled = false; btnText.textContent = 'Guardar Plan'; spinner.classList.add('hidden');
            }, 400);
        });

        // Helpers de Plan (autocalcular en formulario)
        function autoCalcMacrosFromPatient() {
            const patientId = document.getElementById('input-paciente-plan').value;
            if (!patientId) { showToast('Selecciona un paciente', 'error'); return; }
            const patient = allData.find(p => p.id === patientId);
            const macros = computeMacrosForPatient(patient);
            document.getElementById('input-calorias-objetivo-plan').value = macros.calories;
            document.getElementById('input-prot-g').value = macros.protein_g;
            document.getElementById('input-carb-g').value = macros.carbs_g;
            document.getElementById('input-fat-g').value = macros.fat_g;
            showToast('Macros autocalculadas desde el paciente', 'success');
        }

        function proposeMenuIntoForm() {
            const kcal = parseInt(document.getElementById('input-calorias-objetivo-plan').value);
            const p = parseInt(document.getElementById('input-prot-g').value);
            const c = parseInt(document.getElementById('input-carb-g').value);
            const f = parseInt(document.getElementById('input-fat-g').value);
            if (!kcal || !p || !c || !f) { showToast('Primero calcula o ingresa calor√≠as y macros', 'error'); return; }
            const plan = generatePlanFromMacros({ calories: kcal, protein_g: p, carbs_g: c, fat_g: f });
            document.getElementById('input-desayuno').value = plan.textPlan.desayuno;
            document.getElementById('input-colacion-matutina').value = plan.textPlan.colacionMatutina;
            document.getElementById('input-almuerzo').value = plan.textPlan.almuerzo;
            document.getElementById('input-colacion-vespertina').value = plan.textPlan.colacionVespertina;
            document.getElementById('input-cena').value = plan.textPlan.cena;
            showToast('Men√∫ propuesto seg√∫n macros', 'success');
        }

        // =========================
        // ESTAD√çSTICAS
        // =========================
        function renderStatistics() {
            const patients = getPatients();
            const appointments = getAppointments();
            const plans = getPlans();
            document.getElementById('stat-total-patients').textContent = patients.length;
            const now = new Date();
            const pendingAppointments = appointments.filter(a => new Date(a.fecha + 'T' + a.hora) >= now);
            document.getElementById('stat-pending-appointments').textContent = pendingAppointments.length;
            document.getElementById('stat-active-plans').textContent = plans.length;
            const avgIMC = patients.length > 0 ? (patients.reduce((sum, p) => sum + p.imc, 0) / patients.length).toFixed(1) : 0;
            document.getElementById('stat-avg-imc').textContent = avgIMC;

            const genderCounts = { Masculino: 0, Femenino: 0 };
            patients.forEach(p => { if (genderCounts[p.genero] !== undefined) genderCounts[p.genero]++; });
            const totalPatients = patients.length || 1;
            document.getElementById('gender-stats').innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Masculino</span>
                    <div class="flex items-center gap-3">
                        <div class="w-48 bg-gray-200 rounded-full h-4"><div class="bg-blue-500 h-4 rounded-full" style="width:${(genderCounts.Masculino / totalPatients * 100)}%"></div></div>
                        <span class="font-semibold text-gray-800 w-12 text-right">${genderCounts.Masculino}</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Femenino</span>
                    <div class="flex items-center gap-3">
                        <div class="w-48 bg-gray-200 rounded-full h-4"><div class="bg-pink-500 h-4 rounded-full" style="width:${(genderCounts.Femenino / totalPatients * 100)}%"></div></div>
                        <span class="font-semibold text-gray-800 w-12 text-right">${genderCounts.Femenino}</span>
                    </div>
                </div>`;

            const imcRanges = { 'Bajo peso': 0, 'Normal': 0, 'Sobrepeso': 0, 'Obesidad': 0 };
            patients.forEach(p => { const category = getIMCCategory(p.imc).text; if (imcRanges[category] !== undefined) imcRanges[category]++; });
            const colors = { 'Bajo peso': 'bg-yellow-500', 'Normal': 'bg-green-500', 'Sobrepeso': 'bg-orange-500', 'Obesidad': 'bg-red-500' };
            document.getElementById('imc-stats').innerHTML = Object.entries(imcRanges).map(([range, count]) => `
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">${range}</span>
                    <div class="flex items-center gap-3">
                        <div class="w-48 bg-gray-200 rounded-full h-4"><div class="${colors[range]} h-4 rounded-full" style="width:${(count / totalPatients * 100)}%"></div></div>
                        <span class="font-semibold text-gray-800 w-12 text-right">${count}</span>
                    </div>
                </div>`).join('');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<div class="flex items-center gap-3"><div class="text-2xl">${type === 'success' ? '‚úì' : '‚ö†Ô∏è'}</div><p class="text-gray-800 font-medium">${message}</p></div>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        // Vista previa din√°mica (paciente)
        function updateMetricsPreview() {
            const peso = parseFloat(document.getElementById('input-peso').value);
            const altura = parseFloat(document.getElementById('input-altura').value);
            const edad = parseInt(document.getElementById('input-edad').value);
            const genero = document.getElementById('input-genero').value;
            if (peso && altura && edad && genero) {
                const grasaCorporalManual = parseFloat(document.getElementById('input-grasa').value) || null;
                const metrics = calculateMetrics(peso, altura, edad, genero, grasaCorporalManual);
                document.getElementById('preview-imc').textContent = metrics.imc;
                document.getElementById('preview-tmb').textContent = metrics.tmb + ' kcal';
                document.getElementById('preview-grasa').textContent = metrics.grasaCorporal + '%';
                document.getElementById('preview-edad-metabolica').textContent = metrics.edadMetabolica + ' a√±os';
                document.getElementById('preview-peso-sin-grasa').textContent = metrics.pesoSinGrasa + ' kg';
                document.getElementById('preview-masa-muscular').textContent = metrics.masaMuscular + ' kg';
                document.getElementById('preview-agua').textContent = metrics.aguaCorporal + '%';
                document.getElementById('preview-grasa-visceral').textContent = 'Nivel ' + metrics.grasaVisceral;
                document.getElementById('preview-masa-osea').textContent = metrics.masaOsea + ' kg';
                document.getElementById('preview-proteina').textContent = metrics.proteina + '%';

                const actividad = document.getElementById('input-actividad').value || 'ligera';
                const objetivo = document.getElementById('input-objetivo-dieta').value || 'mantenimiento';
                const energy = calcEnergyTargets(metrics.tmb, actividad, objetivo);
                document.getElementById('preview-tdee').textContent = energy.tdee + ' kcal';
                document.getElementById('preview-calorias-objetivo').textContent = energy.targetCalories + ' kcal';
                document.getElementById('metrics-preview').classList.remove('hidden');
            } else {
                document.getElementById('metrics-preview').classList.add('hidden');
            }
        }

        function toggleAdvancedPreview() {
            const advanced = document.getElementById('advanced-preview');
            const toggleText = document.getElementById('advanced-toggle-text');
            if (advanced.classList.contains('hidden')) { advanced.classList.remove('hidden'); toggleText.textContent = 'Ver menos detalles ‚ñ≤'; }
            else { advanced.classList.add('hidden'); toggleText.textContent = 'Ver m√°s detalles ‚ñº'; }
        }

        function setupRealtimeCalculation() {
            const inputs = ['input-peso', 'input-altura', 'input-edad', 'input-genero', 'input-grasa', 'input-actividad', 'input-objetivo-dieta'];
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', updateMetricsPreview);
                    element.addEventListener('change', updateMetricsPreview);
                }
            });
        }

        function autoFillCalculatedFields() {
            const peso = parseFloat(document.getElementById('input-peso').value);
            const altura = parseFloat(document.getElementById('input-altura').value);
            const edad = parseInt(document.getElementById('input-edad').value);
            const genero = document.getElementById('input-genero').value;
            if (peso && altura && edad && genero) {
                const grasaCorporalManual = parseFloat(document.getElementById('input-grasa').value) || null;
                const metrics = calculateMetrics(peso, altura, edad, genero, grasaCorporalManual);
                if (!document.getElementById('input-grasa').value) { document.getElementById('input-grasa').value = metrics.grasaCorporal; }
                if (!document.getElementById('input-musculatura').value) { document.getElementById('input-musculatura').value = metrics.musculaturaEsqueletica; }
                if (!document.getElementById('input-grasa-subcutanea').value) { document.getElementById('input-grasa-subcutanea').value = metrics.grasaSubcutanea; }
                if (!document.getElementById('input-grasa-visceral').value) { document.getElementById('input-grasa-visceral').value = metrics.grasaVisceral; }
                if (!document.getElementById('input-agua').value) { document.getElementById('input-agua').value = metrics.aguaCorporal; }
                if (!document.getElementById('input-masa-muscular').value) { document.getElementById('input-masa-muscular').value = metrics.masaMuscular; }
                if (!document.getElementById('input-masa-osea').value) { document.getElementById('input-masa-osea').value = metrics.masaOsea; }
                if (!document.getElementById('input-proteina').value) { document.getElementById('input-proteina').value = metrics.proteina; }
                const actividad = document.getElementById('input-actividad').value || 'ligera';
                const objetivo = document.getElementById('input-objetivo-dieta').value || 'mantenimiento';
                const energy = calcEnergyTargets(metrics.tmb, actividad, objetivo);
                showToast(`Campos calculados. TDEE: ${energy.tdee} ‚Ä¢ Objetivo: ${energy.targetCalories} kcal`, 'success');
                updateMetricsPreview();
            }
        }

        // =========================
        // REPORTES (resumen incluye macros si est√°n en el plan)
        // =========================
        let currentReportData = '';
        let selectedPatientForReport = null;

        function renderReports() {
            const patients = getPatients();
            const select = document.getElementById('report-patient-select');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
        }

        function loadPatientData() {
            const patientId = document.getElementById('report-patient-select').value;
            const generateBtn = document.getElementById('generate-btn');
            const downloadBtn = document.getElementById('download-btn');
            const copyBtn = document.getElementById('copy-btn');
            const patientSummary = document.getElementById('patient-summary');
            if (!patientId) {
                generateBtn.disabled = true; downloadBtn.classList.add('hidden'); copyBtn.classList.add('hidden'); patientSummary.classList.add('hidden');
                document.getElementById('report-preview').innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <div class="text-4xl mb-4">üìÑ</div>
                        <p class="text-lg font-medium">Selecciona un paciente para generar el reporte</p>
                        <p class="text-sm mt-2">El reporte incluir√° toda la informaci√≥n relevante del tratamiento</p>
                    </div>`; return;
            }
            selectedPatientForReport = allData.find(p => p.id === patientId);
            if (!selectedPatientForReport) return;
            const patientPlans = getPlans().filter(p => p.pacienteId === patientId);
            const patientAppointments = getAppointments().filter(a => a.pacienteId === patientId);
            document.getElementById('summary-edad').textContent = `${selectedPatientForReport.edad} a√±os`;
            document.getElementById('summary-imc').textContent = selectedPatientForReport.imc;
            document.getElementById('summary-planes').textContent = `${patientPlans.length} plan(es)`;
            document.getElementById('summary-citas').textContent = `${patientAppointments.length} cita(s)`;
            patientSummary.classList.remove('hidden');
            generateBtn.disabled = false;
        }

        function generateReport() {
            if (!selectedPatientForReport) return;
            const includePersonal = document.getElementById('include-personal').checked;
            const includeMetrics = document.getElementById('include-metrics').checked;
            const includePlans = document.getElementById('include-plans').checked;
            const includeAppointments = document.getElementById('include-appointments').checked;
            const includeRecommendations = document.getElementById('include-recommendations').checked;
            const clinicName = document.getElementById('clinic-name').textContent;
            const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

            let report = '';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '                    REPORTE NUTRICIONAL COMPLETO\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            report += `Cl√≠nica: ${clinicName}\n`;
            report += `Fecha del Reporte: ${currentDate}\n`;
            report += `Paciente: ${selectedPatientForReport.nombre}\n\n`;

            if (includePersonal) {
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                   INFORMACI√ìN PERSONAL                      ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                report += `Nombre Completo: ${selectedPatientForReport.nombre}\n`;
                report += `Edad: ${selectedPatientForReport.edad} a√±os\n`;
                report += `G√©nero: ${selectedPatientForReport.genero}\n`;
                report += `Actividad: ${selectedPatientForReport.actividad || 'ligera'}\n`;
                report += `Objetivo: ${selectedPatientForReport.objetivoDieta || 'mantenimiento'}\n`;
                if (selectedPatientForReport.telefono) report += `Tel√©fono: ${selectedPatientForReport.telefono}\n`;
                if (selectedPatientForReport.email) report += `Email: ${selectedPatientForReport.email}\n`;
                report += `Fecha de Registro: ${new Date(selectedPatientForReport.createdAt).toLocaleDateString('es-ES')}\n\n`;
            }

            if (includeMetrics) {
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                   M√âTRICAS CORPORALES                      ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                report += 'MEDIDAS B√ÅSICAS:\n';
                report += `‚Ä¢ Peso: ${selectedPatientForReport.peso} kg\n`;
                report += `‚Ä¢ Altura: ${selectedPatientForReport.altura} cm\n`;
                report += `‚Ä¢ IMC: ${selectedPatientForReport.imc} (${getIMCCategory(selectedPatientForReport.imc).text})\n\n`;
                if (selectedPatientForReport.grasaCorporal) {
                    report += 'COMPOSICI√ìN CORPORAL:\n';
                    report += `‚Ä¢ Grasa Corporal: ${selectedPatientForReport.grasaCorporal}%\n`;
                    if (selectedPatientForReport.musculaturaEsqueletica) report += `‚Ä¢ Musculatura Esquel√©tica: ${selectedPatientForReport.musculaturaEsqueletica}%\n`;
                    if (selectedPatientForReport.pesoSinGrasa) report += `‚Ä¢ Peso sin Grasa: ${selectedPatientForReport.pesoSinGrasa} kg\n`;
                    if (selectedPatientForReport.grasaSubcutanea) report += `‚Ä¢ Grasa Subcut√°nea: ${selectedPatientForReport.grasaSubcutanea}%\n`;
                    if (selectedPatientForReport.grasaVisceral) report += `‚Ä¢ Grasa Visceral: Nivel ${selectedPatientForReport.grasaVisceral}\n`;
                    if (selectedPatientForReport.aguaCorporal) report += `‚Ä¢ Agua Corporal: ${selectedPatientForReport.aguaCorporal}%\n\n`;
                }
                if (selectedPatientForReport.masaMuscular || selectedPatientForReport.tmb) {
                    report += 'PAR√ÅMETROS ADICIONALES:\n';
                    if (selectedPatientForReport.masaMuscular) report += `‚Ä¢ Masa Muscular: ${selectedPatientForReport.masaMuscular} kg\n`;
                    if (selectedPatientForReport.masaOsea) report += `‚Ä¢ Masa √ìsea: ${selectedPatientForReport.masaOsea} kg\n`;
                    if (selectedPatientForReport.proteina) report += `‚Ä¢ Prote√≠na: ${selectedPatientForReport.proteina}%\n`;
                    if (selectedPatientForReport.tmb) report += `‚Ä¢ TMB (Tasa Metab√≥lica Basal): ${selectedPatientForReport.tmb} kcal/d√≠a\n`;
                    if (selectedPatientForReport.tdee) report += `‚Ä¢ TDEE (Gasto total estimado): ${selectedPatientForReport.tdee} kcal/d√≠a\n`;
                    if (selectedPatientForReport.caloriasObjetivo) report += `‚Ä¢ Calor√≠as Objetivo: ${selectedPatientForReport.caloriasObjetivo} kcal/d√≠a\n`;
                    if (selectedPatientForReport.edadMetabolica) report += `‚Ä¢ Edad Metab√≥lica: ${selectedPatientForReport.edadMetabolica} a√±os\n\n`;
                }
            }

            if (includePlans) {
                const patientPlans = getPlans().filter(p => p.pacienteId === selectedPatientForReport.id);
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                  PLANES NUTRICIONALES                      ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                if (patientPlans.length === 0) {
                    report += 'No hay planes nutricionales registrados para este paciente.\n\n';
                } else {
                    patientPlans.forEach((plan, index) => {
                        report += `PLAN ${index + 1}:\n`;
                        report += `Objetivo: ${plan.objetivo}\n`;
                        report += `Fecha de Creaci√≥n: ${new Date(plan.createdAt).toLocaleDateString('es-ES')}\n`;
                        if (plan.caloriasObjetivo) {
                            report += `Calor√≠as objetivo: ${plan.caloriasObjetivo} kcal\n`;
                            report += `Macros (g): P=${plan.prot_g || 0}, C=${plan.carb_g || 0}, G=${plan.fat_g || 0}\n`;
                        }
                        report += '\n';
                        if (plan.desayuno) { report += 'DESAYUNO:\n' + plan.desayuno + '\n\n'; }
                        if (plan.colacionMatutina) { report += 'COLACI√ìN MATUTINA:\n' + plan.colacionMatutina + '\n\n'; }
                        if (plan.almuerzo) { report += 'ALMUERZO:\n' + plan.almuerzo + '\n\n'; }
                        if (plan.colacionVespertina) { report += 'COLACI√ìN VESPERTINA:\n' + plan.colacionVespertina + '\n\n'; }
                        if (plan.cena) { report += 'CENA:\n' + plan.cena + '\n\n'; }
                        if (plan.hidratacion) report += `HIDRATACI√ìN: ${plan.hidratacion}\n\n`;
                        if (plan.ejercicio) report += `ACTIVIDAD F√çSICA: ${plan.ejercicio}\n\n`;
                        if (plan.notas) report += `NOTAS Y RESTRICCIONES:\n${plan.notas}\n\n`;
                        if (index < patientPlans.length - 1) report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
                    });
                }
            }

            if (includeAppointments) {
                const patientAppointments = getAppointments().filter(a => a.pacienteId === selectedPatientForReport.id)
                    .sort((a, b) => new Date(b.fecha + 'T' + b.hora) - new Date(a.fecha + 'T' + a.hora));
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                   HISTORIAL DE CITAS                       ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                if (patientAppointments.length === 0) {
                    report += 'No hay citas registradas para este paciente.\n\n';
                } else {
                    patientAppointments.forEach((appointment, index) => {
                        const appointmentDate = new Date(appointment.fecha + 'T' + appointment.hora);
                        const isPast = appointmentDate < new Date();
                        report += `${index + 1}. ${new Date(appointment.fecha).toLocaleDateString('es-ES')} - ${appointment.hora}\n`;
                        report += `   Estado: ${isPast ? 'Completada' : 'Programada'}\n`;
                        if (appointment.motivo) report += `   Motivo: ${appointment.motivo}\n`;
                        report += '\n';
                    });
                }
            }

            if (includeRecommendations) {
                report += '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
                report += '‚îÇ                    RECOMENDACIONES                          ‚îÇ\n';
                report += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
                const imcCategory = getIMCCategory(selectedPatientForReport.imc);
                report += 'RECOMENDACIONES BASADAS EN IMC:\n';
                if (imcCategory.text === 'Bajo peso') {
                    report += '‚Ä¢ Aumentar la ingesta cal√≥rica de manera saludable\n‚Ä¢ Incluir m√°s prote√≠nas y grasas saludables\n‚Ä¢ Ejercicios de fuerza para ganar masa muscular\n';
                } else if (imcCategory.text === 'Normal') {
                    report += '‚Ä¢ Mantener el peso actual con una dieta equilibrada\n‚Ä¢ Actividad f√≠sica regular\n‚Ä¢ Monitorear composici√≥n corporal\n';
                } else if (imcCategory.text === 'Sobrepeso') {
                    report += '‚Ä¢ D√©ficit cal√≥rico moderado (300-500 kcal/d√≠a)\n‚Ä¢ Aumentar actividad cardiovascular\n‚Ä¢ Enfocarse en fibra y prote√≠na\n';
                } else {
                    report += '‚Ä¢ D√©ficit cal√≥rico controlado (500-750 kcal/d√≠a)\n‚Ä¢ Ejercicio de bajo impacto inicialmente\n‚Ä¢ Apoyo profesional si es necesario\n';
                }
                report += '\nRECOMENDACIONES GENERALES:\n';
                report += '‚Ä¢ Mantener horarios regulares de comida\n‚Ä¢ Beber suficiente agua durante el d√≠a\n‚Ä¢ Dormir 7-8 horas diarias\n‚Ä¢ Realizar actividad f√≠sica regularmente\n‚Ä¢ Asistir a las citas de seguimiento\n\n';
            }

            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '                         IMPORTANTE\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            report += 'Este reporte es confidencial y est√° destinado √∫nicamente para\n';
            report += 'el paciente mencionado. Las recomendaciones deben seguirse\n';
            report += 'bajo supervisi√≥n profesional.\n\n';
            report += `Generado el: ${new Date().toLocaleString('es-ES')}\n`;
            report += `Por: ${clinicName}\n`;

            currentReportData = report;
            document.getElementById('report-preview').textContent = report;
            document.getElementById('download-btn').classList.remove('hidden');
            document.getElementById('copy-btn').classList.remove('hidden');
            showToast('Reporte generado correctamente', 'success');
        }

        function downloadReport() {
            if (!currentReportData || !selectedPatientForReport) return;
            const fileName = `Reporte_${selectedPatientForReport.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([currentReportData], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click();
            document.body.removeChild(a); window.URL.revokeObjectURL(url);
            showToast(`Reporte descargado: ${fileName}`, 'success');
        }

        async function copyReport() {
            if (!currentReportData || !selectedPatientForReport) return;
            const copyBtn = document.getElementById('copy-btn'); const originalText = copyBtn.innerHTML;
            try {
                await navigator.clipboard.writeText(currentReportData);
                copyBtn.innerHTML = '<span>‚úì</span><span>¬°Copiado!</span>';
                copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700'); copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                showToast('Reporte copiado al portapapeles', 'success');
                setTimeout(() => { copyBtn.innerHTML = originalText; copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700'); copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); }, 2000);
            } catch (error) {
                const textArea = document.createElement('textarea');
                textArea.value = currentReportData; textArea.style.position = 'fixed'; textArea.style.left = '-999999px'; textArea.style.top = '-999999px';
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try {
                    document.execCommand('copy'); showToast('Reporte copiado al portapapeles', 'success');
                    copyBtn.innerHTML = '<span>‚úì</span><span>¬°Copiado!</span>'; copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700'); copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    setTimeout(() => { copyBtn.innerHTML = originalText; copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700'); copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); }, 2000);
                } catch (fallbackError) { showToast('No se pudo copiar. Usa Descargar.', 'error'); }
                document.body.removeChild(textArea);
            }
        }

        // =========================
        // ASISTENTE IA (chat + plan con macros)
        // =========================
        let chatCount = 0;
        let analysisCount = 0;
        let chatHistory = [];
        let lastAIPlan = null; // para guardar con 1 clic

        function renderAssistant() {
            const patients = getPatients();
            const select = document.getElementById('ai-patient-select');
            select.innerHTML = '<option value="">Seleccionar paciente</option>' + patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            updateChatStats();
        }

        function updateChatStats() {
            document.getElementById('chat-count').textContent = chatCount;
            document.getElementById('analysis-count').textContent = analysisCount;
        }

        function addMessage(content, isUser = false, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start gap-3';
            if (isUser) {
                messageDiv.className += ' flex-row-reverse';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-white text-sm">üë§</span></div>
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg shadow-sm p-4 max-w-md"><p>${content}</p></div>`;
            } else {
                if (isTyping) {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-white text-sm">ü§ñ</span></div>
                        <div class="bg-white rounded-lg shadow-sm p-4 max-w-md">
                            <div class="flex items-center gap-2">
                                <div class="flex space-x-1">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
                                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
                                </div>
                                <span class="text-gray-500 text-sm">NutriBot est√° escribiendo...</span>
                            </div>
                        </div>`;
                } else {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-white text-sm">ü§ñ</span></div>
                        <div class="bg-white rounded-lg shadow-sm p-4 max-w-md"><div class="text-gray-800 whitespace-pre-line">${content}</div></div>`;
                }
            }
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }

        function getIMCRecommendations(imc, edad, genero) {
            const category = getIMCCategory(imc);
            if (category.text === 'Bajo peso') {
                return `<ul class="mt-2 space-y-1 text-sm"><li>‚Ä¢ Aumentar ingesta cal√≥rica (+300-500 kcal/d√≠a)</li><li>‚Ä¢ Incluir m√°s prote√≠nas de calidad</li><li>‚Ä¢ Fuerza para ganar masa muscular</li><li>‚Ä¢ 5-6 comidas al d√≠a</li><li>‚Ä¢ Revisar con m√©dico si persiste</li></ul>`;
            } else if (category.text === 'Normal') {
                return `<ul class="mt-2 space-y-1 text-sm"><li>‚Ä¢ Mantener peso con dieta equilibrada</li><li>‚Ä¢ 150 min/semana de actividad</li><li>‚Ä¢ Monitorear composici√≥n</li><li>‚Ä¢ H√°bitos saludables</li><li>‚Ä¢ Revisiones peri√≥dicas</li></ul>`;
            } else if (category.text === 'Sobrepeso') {
                return `<ul class="mt-2 space-y-1 text-sm"><li>‚Ä¢ D√©ficit 300-500 kcal/d√≠a</li><li>‚Ä¢ M√°s cardio</li><li>‚Ä¢ Priorizar fibra</li><li>‚Ä¢ Control de porciones</li><li>‚Ä¢ Meta: 0.5-1 kg/semana</li></ul>`;
            } else {
                return `<ul class="mt-2 space-y-1 text-sm"><li>‚Ä¢ D√©ficit 500-750 kcal/d√≠a</li><li>‚Ä¢ Ejercicio de bajo impacto</li><li>‚Ä¢ Apoyo multidisciplinario</li><li>‚Ä¢ Cambios graduales</li><li>‚Ä¢ Evaluaci√≥n m√©dica</li></ul>`;
            }
        }

        function generateAIResponse(userMessage, patientData = null) {
            const lowerMessage = userMessage.toLowerCase();

            if (lowerMessage.includes('plan') && (lowerMessage.includes('macro') || lowerMessage.includes('calor√≠a'))) {
                // Atajo: generar plan con macros
                setTimeout(() => { assistantGeneratePlan(); }, 50);
                return "Entendido. Estoy calculando macros y un men√∫ diario basado en los requerimientos del paciente‚Ä¶";
            }

            if (lowerMessage.includes('imc') || lowerMessage.includes('√≠ndice de masa corporal')) {
                if (patientData && patientData.imc) {
                    const category = getIMCCategory(patientData.imc);
                    return `<p><strong>üìä An√°lisis de IMC para ${patientData.nombre}:</strong></p>
                            <p>IMC actual: <strong>${patientData.imc}</strong> - ${category.text}</p>
                            <p><strong>üéØ Recomendaciones espec√≠ficas:</strong></p>
                            ${getIMCRecommendations(patientData.imc, patientData.edad, patientData.genero)}`;
                }
                return `<p><strong>üìä Sobre el √çndice de Masa Corporal (IMC):</strong></p>
                        <p>El IMC relaciona peso y altura.</p>
                        <ul class="mt-2 space-y-1 text-sm">
                          <li>‚Ä¢ Bajo peso: &lt;18.5</li><li>‚Ä¢ Normal: 18.5‚Äì24.9</li><li>‚Ä¢ Sobrepeso: 25.0‚Äì29.9</li><li>‚Ä¢ Obesidad: ‚â•30.0</li>
                        </ul>`;
            }

            if (lowerMessage.includes('grasa visceral') || lowerMessage.includes('visceral')) {
                return `<p><strong>üîç Grasa visceral:</strong> Niveles 1‚Äì9 saludables, 10‚Äì14 moderado, 15‚Äì20 alto riesgo.</p>
                        <p>Prioriza dieta antiinflamatoria, cardio frecuente, fibra y omega-3.</p>`;
            }

            if (lowerMessage.includes('prote√≠na') || lowerMessage.includes('alimentos ricos en prote√≠na')) {
                return `<p><strong>ü•© Prote√≠nas completas:</strong> pollo (25g/100g), pescado (20‚Äì25g), huevo (13g), carnes magras (20‚Äì26g).</p>
                        <p><strong>üå± Vegetales:</strong> lentejas (9g), quinoa (14g), tofu (8g), almendras (21g).</p>
                        <p class="text-sm text-gray-600">Recomendaci√≥n general: 0.8‚Äì2.0 g/kg seg√∫n objetivo.</p>`;
            }

            if (lowerMessage.includes('dieta') || lowerMessage.includes('men√∫') || lowerMessage.includes('plan de comida')) {
                return `Puedo estructurar un plan: desayuno 25%, almuerzo 35%, cena 25%, colaciones 15%. 
                        Si quieres que lo ajuste a tu paciente, usa el bot√≥n <strong>‚ÄúPlan + Macros‚Äù</strong>.`;
            }

            return `Puedo ayudarte con an√°lisis, recomendaciones y planes con macros y calor√≠as.
                    Elige un paciente y pulsa <strong>‚ÄúPlan + Macros‚Äù</strong> para generarlo autom√°ticamente.`;
        }

        function sendMessage(message) {
            if (!message.trim()) return;
            addMessage(message, true);
            chatHistory.push({ role: 'user', content: message });
            const typingMessage = addMessage('', false, true);
            const selectedPatientId = document.getElementById('ai-patient-select').value;
            const selectedPatient = selectedPatientId ? allData.find(p => p.id === selectedPatientId) : null;

            setTimeout(() => {
                typingMessage.remove();
                const response = generateAIResponse(message, selectedPatient);
                addMessage(response, false);
                chatHistory.push({ role: 'assistant', content: response });
                chatCount++;
                if (selectedPatient || message.toLowerCase().includes('analizar') || message.toLowerCase().includes('an√°lisis')) analysisCount++;
                updateChatStats();
            }, 800 + Math.random() * 1200);
        }

        function sendSuggestion(suggestion) { document.getElementById('chat-input').value = suggestion; sendMessage(suggestion); }
        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-white text-sm">ü§ñ</span></div>
                    <div class="bg-white rounded-lg shadow-sm p-4 max-w-md"><p class="text-gray-800">Chat reiniciado. ¬øEn qu√© puedo ayudarte?</p></div>
                </div>`;
            chatHistory = [];
            showToast('Chat limpiado correctamente', 'success');
        }

        function quickAnalyzePatient() {
            const selectedPatientId = document.getElementById('ai-patient-select').value;
            if (!selectedPatientId) { showToast('Selecciona un paciente primero', 'error'); return; }
            const patient = allData.find(p => p.id === selectedPatientId);
            const message = `Analiza completamente al paciente ${patient.nombre} con sus m√©tricas actuales`;
            sendMessage(message);
        }

        function quickNutritionTips() { sendMessage('Dame consejos nutricionales pr√°cticos para mejorar la salud'); }
        function quickFoodAnalysis() { sendMessage('¬øQu√© alimento quieres que analice nutricionalmente?'); }

        // Plan + Macros (IA)
        function assistantGeneratePlan() {
            const selectedPatientId = document.getElementById('ai-patient-select').value;
            if (!selectedPatientId) {
                addMessage('Selecciona un paciente en el panel izquierdo para generar su plan con macros.', false);
                return;
            }
            const patient = allData.find(p => p.id === selectedPatientId);
            const energy = calcEnergyTargets(patient.tmb, patient.actividad || 'ligera', patient.objetivoDieta || 'mantenimiento');
            const macros = computeMacrosForPatient(patient, energy.targetCalories);
            const planBuilt = generatePlanFromMacros(macros);

            lastAIPlan = {
                type: 'plan',
                pacienteId: patient.id,
                objetivo: (patient.objetivoDieta || 'mantenimiento').toUpperCase(),
                caloriasObjetivo: macros.calories,
                prot_g: macros.protein_g,
                carb_g: macros.carbs_g,
                fat_g: macros.fat_g,
                desayuno: planBuilt.textPlan.desayuno,
                colacionMatutina: planBuilt.textPlan.colacionMatutina,
                almuerzo: planBuilt.textPlan.almuerzo,
                colacionVespertina: planBuilt.textPlan.colacionVespertina,
                cena: planBuilt.textPlan.cena,
                hidratacion: '2‚Äì3 L de agua/d√≠a',
                ejercicio: '150‚Äì300 min/semana seg√∫n objetivo',
                notas: 'Ajustar por preferencias/alergias. Porciones aproximadas.',
                recomendaciones: 'Priorizar alimentos frescos y preparaciones simples.'
            };

            const summary =
                `üë§ Paciente: ${patient.nombre}
üéØ Objetivo: ${(patient.objetivoDieta || 'mantenimiento').toUpperCase()}
üî• TMB: ${patient.tmb} kcal | TDEE: ${energy.tdee} kcal | Calor√≠as objetivo: ${macros.calories} kcal

üçΩÔ∏è Macros diarios:
‚Ä¢ Prote√≠nas: ${macros.protein_g} g (${macros.protein_pct}%)
‚Ä¢ Carbohidratos: ${macros.carbs_g} g (${macros.carbs_pct}%)
‚Ä¢ Grasas: ${macros.fat_g} g (${macros.fat_pct}%)

üìÖ Men√∫ propuesto (aprox.):
‚Äî Desayuno (~25%): 
${lastAIPlan.desayuno}

‚Äî Colaci√≥n AM (~7.5%):
${lastAIPlan.colacionMatutina}

‚Äî Almuerzo (~35%):
${lastAIPlan.almuerzo}

‚Äî Colaci√≥n PM (~7.5%):
${lastAIPlan.colacionVespertina}

‚Äî Cena (~25%):
${lastAIPlan.cena}

üî¢ Totales estimados del d√≠a: ${planBuilt.dayTotals.kcal} kcal | P ${planBuilt.dayTotals.p} g | C ${planBuilt.dayTotals.c} g | G ${planBuilt.dayTotals.f} g

üíæ Puedes guardar este plan con el bot√≥n de abajo.`;

            // Mostrar en chat + bot√≥n de guardado
            const container = addMessage(summary, false);
            const btnWrap = document.createElement('div');
            btnWrap.className = 'mt-3';
            btnWrap.innerHTML = `<button onclick="saveAIPlan()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm">üíæ Guardar como Plan</button>`;
            container.querySelector('.text-gray-800')?.appendChild(btnWrap);
            chatCount++; analysisCount++; updateChatStats();
        }

        function saveAIPlan() {
            if (!lastAIPlan) { showToast('No hay plan generado a√∫n', 'error'); return; }
            createRecord(lastAIPlan);
            showToast('Plan guardado correctamente', 'success');
            lastAIPlan = null;
        }

        // =========================
        // EVENTOS GENERALES
        // =========================
        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) { sendMessage(message); input.value = ''; }
        });

        /* ===== Sidebar logic (integrado) ===== */
        (function () {
            const sidebar = document.getElementById('sidebar');
            const btnCollapse = document.getElementById('collapse-btn');
            const btnToggle = document.getElementById('sidebar-toggle');
            const overlay = document.getElementById('sidebar-overlay');

            function isMobile() { return window.innerWidth < 768; }

            function openMobileDrawer(open) {
                if (!isMobile()) return;
                if (open) { sidebar.classList.add('open'); overlay.classList.remove('hidden'); }
                else { sidebar.classList.remove('open'); overlay.classList.add('hidden'); }
            }

            window.toggleSidebar = function (force) {
                if (isMobile()) { openMobileDrawer(force ?? !sidebar.classList.contains('open')); return; }
                // Desktop collapse
                const willCollapse = force ?? !sidebar.classList.contains('is-collapsed');
                sidebar.classList.toggle('is-collapsed', willCollapse);
            };

            // Buttons
            btnCollapse?.addEventListener('click', () => toggleSidebar());
            btnToggle?.addEventListener('click', () => openMobileDrawer(true));
            overlay?.addEventListener('click', () => openMobileDrawer(false));
            window.addEventListener('resize', () => openMobileDrawer(false));

            // Keyboard: Ctrl/‚åò + B = toggle
            window.addEventListener('keydown', (e) => {
                const mod = e.ctrlKey || e.metaKey;
                if (mod && (e.key.toLowerCase() === 'b')) { e.preventDefault(); toggleSidebar(); }
            });

            // Badges
            function setBadge(id, n) {
                const el = document.getElementById(id);
                if (!el) return;
                el.textContent = n;
                el.classList.toggle('hidden', !(n > 0));
            }

            window.updateSidebarCounts = function () {
                try {
                    const totalP = getPatients().length;
                    const now = new Date();
                    const totalC = getAppointments().filter(a => new Date(a.fecha + 'T' + a.hora) >= now).length;
                    const totalPlans = getPlans().length;
                    setBadge('badge-pacientes', totalP);
                    setBadge('badge-citas', totalC);
                    setBadge('badge-planes', totalPlans);
                } catch (_) { }
            };

            // Filtro simple de items (por etiqueta)
            window.filterSidebar = function (text) {
                const q = (text || '').toLowerCase();
                document.querySelectorAll('#sidebar-nav .nav-item').forEach(btn => {
                    const label = (btn.dataset.label || '').toLowerCase();
                    btn.style.display = label.includes(q) ? '' : 'none';
                });
            };

            // Hook: actualiza badges cada vez que se renderiza o se guarda
            const _renderCurrentSection = renderCurrentSection;
            window.renderCurrentSection = function () {
                _renderCurrentSection();
                updateSidebarCounts();
            };
            const _saveToLocalStorage = saveToLocalStorage;
            window.saveToLocalStorage = function () {
                _saveToLocalStorage();
                updateSidebarCounts();
            };

            // Inicial
            updateSidebarCounts();
        })();

        init();
        document.addEventListener('DOMContentLoaded', () => { setupRealtimeCalculation(); });
    </script>

    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'99a28a4c749b598b',t:'MTc2MjQxMDYwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>
